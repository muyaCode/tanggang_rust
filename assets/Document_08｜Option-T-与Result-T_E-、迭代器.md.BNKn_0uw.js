import{_ as n,c as a,o as l,ag as p}from"./chunks/framework.D2WelYEY.js";const o="/tanggang_rust/assets/2c6688bff17d22b516a83e8063fb094e.B5UAgN4_.jpg",e="/tanggang_rust/assets/959455893ca1ae8c43ffyye251c015ed.C8uVghQR.jpg",t="/tanggang_rust/assets/ca69bfe4787585c0e16529c5ddd8b5e5.EOLhdNNK.jpg",r="/tanggang_rust/assets/7170a2fcaec48fd123158f99e88ce708.BOlnDdvR.jpg",c="/tanggang_rust/assets/d300204ce7c0e9a948b486d617e7fa32.BH029XVg.jpg",b=JSON.parse('{"title":"08 ｜ Option<T> 与 Result<T, E>、迭代器","description":"","frontmatter":{},"headers":[],"relativePath":"Document/08｜Option-T-与Result-T,E-、迭代器.md","filePath":"Document/08｜Option-T-与Result-T,E-、迭代器.md","lastUpdated":1740766764000}'),B={name:"Document/08｜Option-T-与Result-T,E-、迭代器.md"};function y(i,s,F,A,u,d){return l(),a("div",null,s[0]||(s[0]=[p('<h1 id="_08-option-t-与-result-t-e-、迭代器" tabindex="-1">08 ｜ <code>Option&lt;T&gt;</code> 与 <code>Result&lt;T, E&gt;</code>、迭代器 <a class="header-anchor" href="#_08-option-t-与-result-t-e-、迭代器" aria-label="Permalink to &quot;08 ｜ `Option&lt;T&gt;` 与 `Result&lt;T, E&gt;`、迭代器&quot;">​</a></h1><p>你好，我是 Mike，今天我们一起来重点学习在 Rust 中高频使用的 <code>Option&lt;T&gt;</code>、 <code>Result&lt;T, E&gt;</code>、迭代器，通过学习这些内容，我们可以继续夯实集合中所有权相关的知识点。</p><p><code>Option&lt;T&gt;</code> 和 <code>Result&lt;T, E&gt;</code> 并不是 Rust 的独创设计，在 Rust 之前，OCaml、Haskell、Scala 等已经使用它们很久了。新兴的一批语言 Kotlin、Swift 等也和 Rust 一样引入了这两种类型。而 C++17 之后也引入了它们。</p><p>这其实能说明使用 <code>Option&lt;T&gt;</code> 和 <code>Result&lt;T, E&gt;</code> 逐渐成了编程语言圈子的一种新共识。而迭代器已经是目前几乎所有主流语言的标配了，所以我们也来看看 Rust 中的迭代器有什么独到的地方。</p><p>如果你习惯了命令式编程或 OOP 编程，那么这节课我们提到各种操作对你来说可能有点陌生，不过也不用担心，这节课我设计了大量示例，你可以通过熟悉这些示例代码，掌握 Rust 中地道的编程风格。</p><h2 id="option-t-与-result-t-e" tabindex="-1"><code>Option&lt;T&gt;</code> 与 <code>Result&lt;T, E&gt;</code> <a class="header-anchor" href="#option-t-与-result-t-e" aria-label="Permalink to &quot;`Option&lt;T&gt;` 与 `Result&lt;T, E&gt;`&quot;">​</a></h2><p><code>Option&lt;T&gt;</code> 与 <code>Result&lt;T, E&gt;</code> 在 Rust 代码中随处可见，但是我们到现在才开始正式介绍，就是因为它们实际是带类型参数的枚举类型。</p><h3 id="option-t-的定义" tabindex="-1"><code>Option&lt;T&gt;</code> 的定义 <a class="header-anchor" href="#option-t-的定义" aria-label="Permalink to &quot;`Option&lt;T&gt;` 的定义&quot;">​</a></h3><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">pub</span><span style="color:#C678DD;"> enum</span><span style="color:#E5C07B;"> Option</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">T</span><span style="color:#ABB2BF;">&gt; {</span></span>\n<span class="line"><span style="color:#E5C07B;">    None</span><span style="color:#ABB2BF;">,</span></span>\n<span class="line"><span style="color:#E5C07B;">    Some</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">T</span><span style="color:#ABB2BF;">),</span></span>\n<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>Option&lt;T&gt;</code> 定义为包含两个变体的枚举。一个是不带负载的 None，另一个是带一个类型参数作为其负载的 Some。 <code>Option&lt;T&gt;</code> 的实例在 Some 和 None 中取值， 表示这个实例有取空值的可能。</p><p>你可以把 <code>Option&lt;T&gt;</code> 理解为把空值单独提出来了一个维度。在没有 <code>Option&lt;T&gt;</code> 的语言中，空值是分散在其他类型中的。比如空字符串、空数组、数字 0、NULL 指针等。并且有的语言还把空值区分为空值和未定义的值，如 nil、undefined 等。</p><p>Rust 做了两件事情来解决这个混乱的场面。第一，Rust 中所有的变量定义后使用前都必须初始化，所以不存在未定义值这个情况。第二，Rust 把空值单独提出来统一定义成 <code>Option&lt;T&gt;::None</code>，并在标准库层面上就做好了规范，上层的应用在设计时也应该遵循这个规范。</p><p>我们来看一个示例。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> s</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> String</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">from</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;&quot;</span><span style="color:#ABB2BF;">);</span></span>\n<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> a</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Option</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Some</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">s</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>变量 a 是携带空字符串的 <code>Option&lt;String&gt;</code> 类型。这里，空字符串&quot;&quot;的“空”与 None 所表示的“无”表达了不同的意义。</p><p>如果早点发明 Option，Tony Hoare 就不会自责了。Tony Hoare 在 <a href="https://www.infoq.com/presentations/Null-References-The-Billion-Dollar-Mistake-Tony-Hoare/" target="_blank" rel="noreferrer">一次分享</a> 中说，他在 1965 年发明的空引用（Null references）是一个“十亿美元”的错误。</p><p>他是这样说的：我把它叫做我的十亿美元错误。那个时候，我正在为一个面向对象语言中的引用设计第一个全面的类型系统。我的目标是让编译器自动施加检查，来确保对引用的所有使用都是绝对安全的。但是我当时无法抵抗空引用的诱惑，就是因为它非常容易实现。这导致了难以计数的错误、漏洞和系统崩溃，在后续 40 年里这可能已经导致了十亿美元的痛苦和破坏。</p><p>Rust 通过所有权并借用检查器、 <code>Option&lt;T&gt;</code>、 <code>Result&lt;T, E&gt;</code> 等一整套机制全面解决了 Hoare 想解决的问题。</p><h3 id="result-t-e-的定义" tabindex="-1"><code>Result&lt;T, E&gt;</code> 的定义 <a class="header-anchor" href="#result-t-e-的定义" aria-label="Permalink to &quot;`Result&lt;T, E&gt;` 的定义&quot;">​</a></h3><p>我们先来看一个示例。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">pub</span><span style="color:#C678DD;"> enum</span><span style="color:#E5C07B;"> Result</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">T</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">E</span><span style="color:#ABB2BF;">&gt; {</span></span>\n<span class="line"><span style="color:#E5C07B;">    Ok</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">T</span><span style="color:#ABB2BF;">),</span></span>\n<span class="line"><span style="color:#E5C07B;">    Err</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">E</span><span style="color:#ABB2BF;">),</span></span>\n<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>Result&lt;T, E&gt;</code> 被定义为包含两个变体的枚举。这两个变体各自带一个类型参数作为其负载。 <code>Ok(T)</code> 用来表示结果正确， <code>Err(E)</code> 用来表示结果有错误。</p><p>对比其他语言函数错误返回的约定，C、CPP、Java 语言里有时用返回 0 来表示函数执行正确，有时又不是这样，你需要根据代码所在的上下文环境来判断返回什么值代表正确，返回什么值代表错误。</p><p>而 Go 语言强制对函数返回值做出了约定。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">ret</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">err</span><span style="color:#ABB2BF;"> :</span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> function</span><span style="color:#ABB2BF;">()</span></span>\n<span class="line"><span style="color:#C678DD;">if</span><span style="color:#E06C75;"> err</span><span style="color:#56B6C2;"> !=</span><span style="color:#E06C75;"> nil</span><span style="color:#ABB2BF;"> {</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>约定要求函数返回两个值，正确的情况下， <code>ret</code> 存放返回值， <code>err</code> 为 <code>nil</code>。如果函数要返回错误值，那么会给 <code>err</code> 变量填充具体的内容，于是就出现了经典的满屏 <code>if err ！= nil</code> 代码，成了 Go 语言圈的一个梗。可以看到，Go 语言已经朝着把错误信息和正常返回值类型剥离开来的方向走出了一步。</p><p>而 Rust 没有像 Go 那样设计，一是因为 Rust 不存在单独的 <code>nil</code> 这种空值，二是 Rust 直接用带类型参数的枚举就可以达到这个目的。</p><p>一个枚举实例在一个时刻只能是那个枚举类型的某一个变体。所以一个函数的返回值，不论它是正确的情况还是错误的情况，都能用 <code>Result&lt;T, E&gt;</code> 类型统一表达，这样会显得更紧凑。同时还因为 <code>Result&lt;T, E&gt;</code> 是一种类型，我们可以在它之上添加很多操作，用起来很方便。下面我用例子来给你讲解。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> r</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> function</span><span style="color:#ABB2BF;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>这个例子表示将函数返回值赋给变量 r，返回类型是 <code>Result&lt;String, String&gt;</code>。在正确的情况下，返回内容为 String 类型；错误的情况下，被返回的错误类型也是 String。你是不是在想：两种可以一样？当然可以，这两个类型参数可以被任意类型代入。</p><p><code>Result&lt;T, E&gt;</code> 被用来支撑 Rust 的错误处理机制，所以非常重要。我们会在第 18 讲详细讲述基于 <code>Result&lt;T, E&gt;</code> 的错误处理。</p><h3 id="解包" tabindex="-1">解包 <a class="header-anchor" href="#解包" aria-label="Permalink to &quot;解包&quot;">​</a></h3><p>现在我们遇到了一个问题，比如 <code>Option&lt;u32&gt;::Some(10)</code> 和 <code>10u32</code> 明显已经不是同一种类型了。我们真正想要的值被“包裹”在了另外一种类型里面。这种“包裹”是通过枚举变体来实现的。那我们想获取被包在里面的值应该怎么做呢？</p><p>其实有很多办法，我们先讲一类解包操作。这里我列出了三种方法，分别是 <code>expect()</code>、 <code>unwrap()</code>、 <code>unwrap_or()</code>。我给出了它们解包的具体操作和示例代码，你可以看一下有什么不同。</p><p><img src="'+o+`" alt="图片"></p><p>示例：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// Option</span></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> Some</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;value&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">expect</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;fruits are healthy&quot;</span><span style="color:#ABB2BF;">), </span><span style="color:#98C379;">&quot;value&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// Result</span></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> path</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> std</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">env</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">var</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;IMPORTANT_PATH&quot;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">    .</span><span style="color:#61AFEF;">expect</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;env variable \`IMPORTANT_PATH\` should be set by \`wrapper_script.sh\`&quot;</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><img src="`+e+`" alt="图片"></p><p>示例：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// Option</span></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> Some</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;air&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unwrap</span><span style="color:#ABB2BF;">(), </span><span style="color:#98C379;">&quot;air&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// Result</span></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">, &amp;</span><span style="color:#E5C07B;">str</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Ok</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unwrap</span><span style="color:#ABB2BF;">(), </span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><img src="`+t+`" alt="图片"></p><p>示例：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// Option</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;car&quot;</span><span style="color:#ABB2BF;">).</span><span style="color:#61AFEF;">unwrap_or</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;bike&quot;</span><span style="color:#ABB2BF;">), </span><span style="color:#98C379;">&quot;car&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">None</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unwrap_or</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;bike&quot;</span><span style="color:#ABB2BF;">), </span><span style="color:#98C379;">&quot;bike&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// Result</span></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> default</span><span style="color:#56B6C2;"> =</span><span style="color:#D19A66;"> 2</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">, &amp;</span><span style="color:#E5C07B;">str</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Ok</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">9</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unwrap_or</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">default</span><span style="color:#ABB2BF;">), </span><span style="color:#D19A66;">9</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">, &amp;</span><span style="color:#E5C07B;">str</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Err</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;error&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unwrap_or</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">default</span><span style="color:#ABB2BF;">), </span><span style="color:#E06C75;">default</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><img src="`+r+`" alt="图片"></p><p>示例：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// Option</span></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Option</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> None</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> y</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Option</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Some</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">12</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unwrap_or_default</span><span style="color:#ABB2BF;">(), </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">y</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unwrap_or_default</span><span style="color:#ABB2BF;">(), </span><span style="color:#D19A66;">12</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// Result</span></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> good_year_from_input</span><span style="color:#56B6C2;"> =</span><span style="color:#98C379;"> &quot;1909&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> bad_year_from_input</span><span style="color:#56B6C2;"> =</span><span style="color:#98C379;"> &quot;190blarg&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> good_year</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> good_year_from_input</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">parse</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">unwrap_or_default</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> bad_year</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> bad_year_from_input</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">parse</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">unwrap_or_default</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">1909</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">good_year</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">bad_year</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>可以看到，解包操作挺费劲的。如果我们总是先用 <code>Option&lt;T&gt;</code> 或 <code>Result&lt;T, E&gt;</code> 把值包裹起来，用的时候再手动解包，那其实说明没有真正抓住到 <code>Option&lt;T&gt;</code> 和 <code>Result&lt;T, E&gt;</code> 的设计要义。在 Rust 中，很多时候我们不需要解包也能操作里面的值，这样就不用做看起来多此一举的解包操作了。下面我们来看一下在不解包的情况下，我们可以怎样做。</p><h3 id="不解包的情况下如何操作" tabindex="-1">不解包的情况下如何操作？ <a class="header-anchor" href="#不解包的情况下如何操作" aria-label="Permalink to &quot;不解包的情况下如何操作？&quot;">​</a></h3><p>不解包的情况下如果想要获取被包在里面的值就需要用到 <code>Option&lt;T&gt;</code> 和 <code>Result&lt;T, E&gt;</code> 里的一些常用方法。</p><p><code>Option&lt;T&gt;</code> 上的常用方法和示例：</p><ul><li>map()：在 Option 是 Some 的情况下，通过 map 中提供的函数或闭包把 Option 里的类型转换成另一种类型。在 Option 是 None 的情况下，保持 None 不变。map() 会消耗原类型，也就是获取所有权。</li></ul><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> maybe_some_string</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> Some</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">from</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;Hello, World!&quot;</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> maybe_some_len</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> maybe_some_string</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">map</span><span style="color:#ABB2BF;">(</span><span style="color:#56B6C2;">|</span><span style="color:#E06C75;">s</span><span style="color:#56B6C2;">|</span><span style="color:#E06C75;"> s</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">len</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">maybe_some_len</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">13</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Option</span><span style="color:#ABB2BF;">&lt;&amp;</span><span style="color:#E5C07B;">str</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> None</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">map</span><span style="color:#ABB2BF;">(</span><span style="color:#56B6C2;">|</span><span style="color:#E06C75;">s</span><span style="color:#56B6C2;">|</span><span style="color:#E06C75;"> s</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">len</span><span style="color:#ABB2BF;">()), </span><span style="color:#E5C07B;">None</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>cloned()：通过克隆 Option 里面的内容，把 <code>Option&lt;&amp;T&gt;</code> 转换成 <code>Option&lt;T&gt;</code>。</li></ul><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#56B6C2;"> =</span><span style="color:#D19A66;"> 12</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> opt_x</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> Some</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">opt_x</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#D19A66;">12</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> cloned</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> opt_x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">cloned</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">cloned</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">12</span><span style="color:#ABB2BF;">));</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>is_some()：如果 Option 是 Some 值，返回 true。</li></ul><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Option</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Some</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">is_some</span><span style="color:#ABB2BF;">(), </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Option</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> None</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">is_some</span><span style="color:#ABB2BF;">(), </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>is_none()：如果 Option 是 None 值，返回 true。</li></ul><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Option</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Some</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">is_none</span><span style="color:#ABB2BF;">(), </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Option</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> None</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">is_none</span><span style="color:#ABB2BF;">(), </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>as_ref()：把 <code>Option&lt;T&gt;</code> 或 <code>&amp;Option&lt;T&gt;</code> 转换成 <code>Option&lt;&amp;T&gt;</code>。创建一个新 Option，里面的类型是原来类型的引用，就是从 <code>Option&lt;T&gt;</code> 到 <code>Option&lt;&amp;T&gt;</code>。原来那个 <code>Option&lt;T&gt;</code> 实例保持不变。</li></ul><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> text</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Option</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Some</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;Hello, world!&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> text_length</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Option</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">usize</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> text</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">as_ref</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">map</span><span style="color:#ABB2BF;">(</span><span style="color:#56B6C2;">|</span><span style="color:#E06C75;">s</span><span style="color:#56B6C2;">|</span><span style="color:#E06C75;"> s</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">len</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#61AFEF;">println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;still can print text: {text:?}&quot;</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>as_mut()：把 <code>Option&lt;T&gt;</code> 或 <code>&amp;mut Option&lt;T&gt;</code> 转换成 <code>Option&lt;&amp;mut T&gt;</code>。</li></ul><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> x</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> Some</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">match</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">as_mut</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">v</span><span style="color:#ABB2BF;">) =&gt; *</span><span style="color:#E06C75;">v</span><span style="color:#56B6C2;"> =</span><span style="color:#D19A66;"> 42</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E5C07B;">None</span><span style="color:#ABB2BF;"> =&gt; {},</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">42</span><span style="color:#ABB2BF;">));</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>take()：把 Option 的值拿出去，在原地留下一个 None 值。这个非常有用。相当于把值拿出来用，但是却没有消解原来那个 Option。</li></ul><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> x</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> Some</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> y</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">take</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">None</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">y</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Option</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> None</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> y</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">take</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">None</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">y</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">None</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>replace()：在原地替换新值，同时把原来那个值抛出来。</li></ul><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> x</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> Some</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> old</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">replace</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">5</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">5</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">old</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> x</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> None</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> old</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">replace</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">3</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">3</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">old</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">None</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>and_then()：如果 Option 是 None，返回 None；如果 Option 是 Some，就把参数里面提供的函数或闭包应用到被包裹的内容上，并返回运算后的结果。</li></ul><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> sq_then_to_string</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">) -&gt; </span><span style="color:#E5C07B;">Option</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">&gt; {</span></span>
<span class="line"><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">checked_mul</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">).</span><span style="color:#61AFEF;">map</span><span style="color:#ABB2BF;">(</span><span style="color:#56B6C2;">|</span><span style="color:#E06C75;">sq</span><span style="color:#56B6C2;">|</span><span style="color:#E06C75;"> sq</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">())</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">).</span><span style="color:#61AFEF;">and_then</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">sq_then_to_string</span><span style="color:#ABB2BF;">), </span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">4.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">()));</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">1_000_000</span><span style="color:#ABB2BF;">).</span><span style="color:#61AFEF;">and_then</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">sq_then_to_string</span><span style="color:#ABB2BF;">), </span><span style="color:#E5C07B;">None</span><span style="color:#ABB2BF;">); </span><span style="color:#7F848E;font-style:italic;">// overflowed!</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">None</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">and_then</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">sq_then_to_string</span><span style="color:#ABB2BF;">), </span><span style="color:#E5C07B;">None</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>我们再看 <code>Result&lt;T, E&gt;</code> 上的常用方法和示例。</p><ul><li>map()：当 Result 是 Ok 的时候，把 Ok 里的类型通过参数里提供的函数运算并且可以转换成另外一种类型。当 Result 是 Err 的时候，原样返回 Err 和它携带的内容。</li></ul><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> line</span><span style="color:#56B6C2;"> =</span><span style="color:#98C379;"> &quot;1</span><span style="color:#56B6C2;">\\n</span><span style="color:#98C379;">2</span><span style="color:#56B6C2;">\\n</span><span style="color:#98C379;">3</span><span style="color:#56B6C2;">\\n</span><span style="color:#98C379;">4</span><span style="color:#56B6C2;">\\n</span><span style="color:#98C379;">&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">for</span><span style="color:#E06C75;"> num</span><span style="color:#C678DD;"> in</span><span style="color:#E06C75;"> line</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">lines</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">match</span><span style="color:#E06C75;"> num</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">parse</span><span style="color:#ABB2BF;">::&lt;</span><span style="color:#E5C07B;">i32</span><span style="color:#ABB2BF;">&gt;().</span><span style="color:#61AFEF;">map</span><span style="color:#ABB2BF;">(</span><span style="color:#56B6C2;">|</span><span style="color:#E06C75;">i</span><span style="color:#56B6C2;">|</span><span style="color:#E06C75;"> i</span><span style="color:#ABB2BF;"> * </span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">Ok</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">n</span><span style="color:#ABB2BF;">) =&gt; </span><span style="color:#61AFEF;">println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;{n}&quot;</span><span style="color:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#E5C07B;">Err</span><span style="color:#ABB2BF;">(..) =&gt; {}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>is_ok()：如果 Result 是 Ok，返回 true。</li></ul><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">i32</span><span style="color:#ABB2BF;">, &amp;</span><span style="color:#E5C07B;">str</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Ok</span><span style="color:#ABB2BF;">(-</span><span style="color:#D19A66;">3</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">is_ok</span><span style="color:#ABB2BF;">(), </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">i32</span><span style="color:#ABB2BF;">, &amp;</span><span style="color:#E5C07B;">str</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Err</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;Some error message&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">is_ok</span><span style="color:#ABB2BF;">(), </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>is_err()：如果 Result 是 Err，返回 true。</li></ul><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">i32</span><span style="color:#ABB2BF;">, &amp;</span><span style="color:#E5C07B;">str</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Ok</span><span style="color:#ABB2BF;">(-</span><span style="color:#D19A66;">3</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">is_err</span><span style="color:#ABB2BF;">(), </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">i32</span><span style="color:#ABB2BF;">, &amp;</span><span style="color:#E5C07B;">str</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Err</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;Some error message&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">is_err</span><span style="color:#ABB2BF;">(), </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>as_ref()：创建一个新 Result，里面的两种类型分别是原来两种类型的引用，就是从 <code>Result&lt;T, E&gt;</code> 到 <code>Result&lt;&amp;T, &amp;E&gt;</code>。原来那个 <code>Result&lt;T, E&gt;</code> 实例保持不变。</li></ul><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">, &amp;</span><span style="color:#E5C07B;">str</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Ok</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">as_ref</span><span style="color:#ABB2BF;">(), </span><span style="color:#E5C07B;">Ok</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">, &amp;</span><span style="color:#E5C07B;">str</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Err</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;Error&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">as_ref</span><span style="color:#ABB2BF;">(), </span><span style="color:#E5C07B;">Err</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#98C379;">&quot;Error&quot;</span><span style="color:#ABB2BF;">));</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>as_mut()：创建一个新 Result，里面的两种类型分别是原来两种类型的可变引用，就是从 <code>Result&lt;T, E&gt;</code> 到 <code>Result&lt;&amp;mut T, &amp;mut E&gt;</code>。原来那个 <code>Result&lt;T, E&gt;</code> 实例保持不变。</li></ul><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> mutate</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">r</span><span style="color:#ABB2BF;">: &amp;</span><span style="color:#C678DD;">mut</span><span style="color:#E5C07B;"> Result</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">i32</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">i32</span><span style="color:#ABB2BF;">&gt;) {</span></span>
<span class="line"><span style="color:#C678DD;">match</span><span style="color:#E06C75;"> r</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">as_mut</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#E5C07B;">Ok</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">v</span><span style="color:#ABB2BF;">) =&gt; *</span><span style="color:#E06C75;">v</span><span style="color:#56B6C2;"> =</span><span style="color:#D19A66;"> 42</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E5C07B;">Err</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">e</span><span style="color:#ABB2BF;">) =&gt; *</span><span style="color:#E06C75;">e</span><span style="color:#56B6C2;"> =</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">i32</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">i32</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Ok</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">mutate</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#C678DD;">mut</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unwrap</span><span style="color:#ABB2BF;">(), </span><span style="color:#D19A66;">42</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">i32</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">i32</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Err</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">13</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">mutate</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#C678DD;">mut</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unwrap_err</span><span style="color:#ABB2BF;">(), </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>and_then()：当 Result 是 Ok 时，把这个方法提供的函数或闭包应用到 Ok 携带的内容上面，并返回一个新的 Result。当 Result 是 Err 的时候，这个方法直接传递返回这个 Err 和它的负载。这个方法常常用于一路链式操作，前提是过程里的每一步都需要返回 Result。</li></ul><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> sq_then_to_string</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">) -&gt; </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">, &amp;&#39;</span><span style="color:#E5C07B;">static</span><span style="color:#E5C07B;"> str</span><span style="color:#ABB2BF;">&gt; {</span></span>
<span class="line"><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">checked_mul</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">).</span><span style="color:#61AFEF;">map</span><span style="color:#ABB2BF;">(</span><span style="color:#56B6C2;">|</span><span style="color:#E06C75;">sq</span><span style="color:#56B6C2;">|</span><span style="color:#E06C75;"> sq</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">()).</span><span style="color:#61AFEF;">ok_or</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;overflowed&quot;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Ok</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">).</span><span style="color:#61AFEF;">and_then</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">sq_then_to_string</span><span style="color:#ABB2BF;">), </span><span style="color:#E5C07B;">Ok</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">4.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">()));</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Ok</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">1_000_000</span><span style="color:#ABB2BF;">).</span><span style="color:#61AFEF;">and_then</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">sq_then_to_string</span><span style="color:#ABB2BF;">), </span><span style="color:#E5C07B;">Err</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;overflowed&quot;</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Err</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;not a number&quot;</span><span style="color:#ABB2BF;">).</span><span style="color:#61AFEF;">and_then</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">sq_then_to_string</span><span style="color:#ABB2BF;">), </span><span style="color:#E5C07B;">Err</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;not a number&quot;</span><span style="color:#ABB2BF;">));</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>map_err()：当 Result 是 Ok 时，传递原样返回。当 Result 是 Err 时，对 Err 携带的内容使用这个方法提供的函数或闭包进行运算及类型转换。这个方法常常用于转换 Result 的 Err 的负载的类型，在错误处理流程中大量使用。</li></ul><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> stringify</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">) -&gt; </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;"> { </span><span style="color:#61AFEF;">format!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;error code: {x}&quot;</span><span style="color:#ABB2BF;">) }</span></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Ok</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">map_err</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">stringify</span><span style="color:#ABB2BF;">), </span><span style="color:#E5C07B;">Ok</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Err</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">13</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">map_err</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">stringify</span><span style="color:#ABB2BF;">), </span><span style="color:#E5C07B;">Err</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;error code: 13&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">()));</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="option-t-与-result-t-e-的相互转换" tabindex="-1"><code>Option&lt;T&gt;</code> 与 <code>Result&lt;T, E&gt;</code> 的相互转换 <a class="header-anchor" href="#option-t-与-result-t-e-的相互转换" aria-label="Permalink to &quot;\`Option&lt;T&gt;\` 与 \`Result&lt;T, E&gt;\` 的相互转换&quot;">​</a></h3><p><code>Option&lt;T&gt;</code> 与 <code>Result&lt;T, E&gt;</code> 之间是可以互相转换的。转换的时候需要注意， <code>Result&lt;T, E&gt;</code> 比 <code>Option&lt;T&gt;</code> 多一个类型参数，所以它带的信息比 <code>Option&lt;T&gt;</code> 多一份，因此核心要点就是 <strong>要注意信息的添加与抛弃</strong>。</p><h4 id="从option-t-到-result-t-e-ok-or" tabindex="-1"><code>从Option&lt;T&gt;</code> 到 <code>Result&lt;T, E&gt;：ok_or()</code> <a class="header-anchor" href="#从option-t-到-result-t-e-ok-or" aria-label="Permalink to &quot;\`从Option&lt;T&gt;\` 到 \`Result&lt;T, E&gt;：ok_or()\`&quot;">​</a></h4><p><code>Option&lt;T&gt;</code> 实例如果是 <code>Some</code>，直接把内容重新包在 <code>Result&lt;T, E&gt;::Ok()</code> 里。如果是 <code>None</code>，使用 <code>ok_or()</code> 里提供的参数作为 <code>Err</code> 的内容。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> Some</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;foo&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">ok_or</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">), </span><span style="color:#E5C07B;">Ok</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;foo&quot;</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Option</span><span style="color:#ABB2BF;">&lt;&amp;</span><span style="color:#E5C07B;">str</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> None</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">ok_or</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">), </span><span style="color:#E5C07B;">Err</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">));</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="从-result-t-e-到-option-t-ok" tabindex="-1">从 <code>Result&lt;T, E&gt;</code> 到 <code>Option&lt;T&gt;：ok()</code> <a class="header-anchor" href="#从-result-t-e-到-option-t-ok" aria-label="Permalink to &quot;从 \`Result&lt;T, E&gt;\` 到 \`Option&lt;T&gt;：ok()\`&quot;">​</a></h4><p>如果 <code>Result&lt;T, E&gt;</code> 是 <code>Ok</code>，就把内容重新包在 <code>Some</code> 里。如果 <code>Result&lt;T, E&gt;</code> 是 <code>Err</code>，就直接换成 <code>None</code>，丢弃 <code>Err</code> 里的内容，同时原 <code>Result&lt;T, E&gt;</code> 实例被消费。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">, &amp;</span><span style="color:#E5C07B;">str</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Ok</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">ok</span><span style="color:#ABB2BF;">(), </span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">, &amp;</span><span style="color:#E5C07B;">str</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Err</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;Nothing here&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">ok</span><span style="color:#ABB2BF;">(), </span><span style="color:#E5C07B;">None</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="从-result-t-e-到-option-t-err" tabindex="-1">从 <code>Result&lt;T, E&gt;</code> 到 <code>Option&lt;T&gt;：err()</code> <a class="header-anchor" href="#从-result-t-e-到-option-t-err" aria-label="Permalink to &quot;从 \`Result&lt;T, E&gt;\` 到 \`Option&lt;T&gt;：err()\`&quot;">​</a></h4><p>如果 <code>Result&lt;T, E&gt;</code> 是 <code>Ok</code>，直接换成 <code>None</code>，丢弃 <code>Ok</code> 里的内容。如果 <code>Result&lt;T, E&gt;</code> 是 <code>Err</code>，把内容重新包在 <code>Some</code> 里，同时原 <code>Result&lt;T, E&gt;</code> 实例被消费。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">, &amp;</span><span style="color:#E5C07B;">str</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Ok</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">err</span><span style="color:#ABB2BF;">(), </span><span style="color:#E5C07B;">None</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> x</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">, &amp;</span><span style="color:#E5C07B;">str</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Err</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;Nothing here&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">err</span><span style="color:#ABB2BF;">(), </span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;Nothing here&quot;</span><span style="color:#ABB2BF;">));</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>下面我们讲讲迭代器。</p><h2 id="迭代器" tabindex="-1">迭代器 <a class="header-anchor" href="#迭代器" aria-label="Permalink to &quot;迭代器&quot;">​</a></h2><p>迭代器其实很简单，就是对一个集合类型进行遍历。比如对 <code>Vec&lt;T&gt;</code>、对 <code>HashMap&lt;K, V&gt;</code> 等进行遍历。使用迭代器有一些好处，比如：</p><ol><li>按需使用，不需要把目标集合一次性全部加载到内存，使用一点加载一点。</li><li>惰性计算，可以用来表达无限区间，比如第一讲我们说的 range，可以表达 1 到无限这个集合，这种在其他有些语言中很难表达。</li><li>可以安全地访问边界，不需要使用有访问风险的下标操作符。</li></ol><h3 id="next-方法" tabindex="-1"><code>next()</code> 方法 <a class="header-anchor" href="#next-方法" aria-label="Permalink to &quot;\`next()\` 方法&quot;">​</a></h3><p>迭代器上有一个标准方法，叫作 <code>next()</code>，这个方法返回 <code>Option&lt;Item&gt;</code>，其中 Item 就是组成迭代器的元素。这个方法的字面意思就是 <strong>迭代出下一个元素</strong>。如果这个集合被迭代完成了，那么最后一次执行会返回 <code>None</code>。比如下面的例子，在迭代器上调用 <code>.next()</code> 返回 <code>u32</code> 数字。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> a</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Vec</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> vec!</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">3</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">5</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> an_iter</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> a</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">into_iter</span><span style="color:#ABB2BF;">();    </span><span style="color:#7F848E;font-style:italic;">// 将Vec&lt;u32&gt;转换为迭代器</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    while</span><span style="color:#C678DD;"> let</span><span style="color:#E5C07B;"> Some</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">i</span><span style="color:#ABB2BF;">) </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> an_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">() {  </span><span style="color:#7F848E;font-style:italic;">// 调用 .next() 方法</span></span>
<span class="line"><span style="color:#61AFEF;">        println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;{i}&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 输出</span></span>
<span class="line"><span style="color:#D19A66;">1</span></span>
<span class="line"><span style="color:#D19A66;">2</span></span>
<span class="line"><span style="color:#D19A66;">3</span></span>
<span class="line"><span style="color:#D19A66;">4</span></span>
<span class="line"><span style="color:#D19A66;">5</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>实际上，Rust 中不止 <code>into_iter()</code> 这一种将集合转换成迭代器的方法。</p><h3 id="iter-、-iter-mut-、-into-iter-与三种迭代器" tabindex="-1"><code>iter()</code>、 <code>iter_mut()</code>、 <code>into_iter()</code> 与三种迭代器 <a class="header-anchor" href="#iter-、-iter-mut-、-into-iter-与三种迭代器" aria-label="Permalink to &quot;\`iter()\`、 \`iter_mut()\`、 \`into_iter()\` 与三种迭代器&quot;">​</a></h3><p>Rust 中的迭代器根据所有权三态可以分成三种。</p><ol><li>获取集合元素不可变引用的迭代器，对应方法为 <code>iter()</code>。</li><li>获取集合元素可变引用的迭代器，对应方法为 <code>iter_mut()</code>。</li><li>获取集合元素所有权的迭代器，对应方法为 <code>into_iter()</code>。</li></ol><p>在 Rust 标准库约定中，如果你看到一个类型上实现了 <code>iter()</code> 方法，那么它会返回获取集合元素不可变引用的迭代器；如果你看到一个类型上实现了 <code>iter_mut()</code> 方法，那么它会返回获取集合元素可变引用的迭代器；如果你看到一个类型上实现了 <code>into_iter()</code> 方法，那么它会返回获取集合元素所有权的迭代器。调用了这个迭代器后，迭代器的执行会消耗掉原集合。</p><p>我们来看这三种不同的迭代器的一个对比。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> a</span><span style="color:#56B6C2;"> =</span><span style="color:#ABB2BF;"> [</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">3</span><span style="color:#ABB2BF;">];    </span><span style="color:#7F848E;font-style:italic;">// 一个整数数组</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> an_iter</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> a</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">iter</span><span style="color:#ABB2BF;">();  </span><span style="color:#7F848E;font-style:italic;">// 转换成第一种迭代器</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">    assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">), </span><span style="color:#E06C75;">an_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#61AFEF;">    assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">), </span><span style="color:#E06C75;">an_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#61AFEF;">    assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#D19A66;">3</span><span style="color:#ABB2BF;">), </span><span style="color:#E06C75;">an_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#61AFEF;">    assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">None</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">an_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> an_iter</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> a</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">iter_mut</span><span style="color:#ABB2BF;">();  </span><span style="color:#7F848E;font-style:italic;">// 转换成第二种迭代器</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">    assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#C678DD;">mut</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">), </span><span style="color:#E06C75;">an_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#61AFEF;">    assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#C678DD;">mut</span><span style="color:#D19A66;"> 2</span><span style="color:#ABB2BF;">), </span><span style="color:#E06C75;">an_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#61AFEF;">    assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#C678DD;">mut</span><span style="color:#D19A66;"> 3</span><span style="color:#ABB2BF;">), </span><span style="color:#E06C75;">an_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#61AFEF;">    assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">None</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">an_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> an_iter</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> a</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">into_iter</span><span style="color:#ABB2BF;">();  </span><span style="color:#7F848E;font-style:italic;">// 转换成第三种迭代器，并消耗掉a</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">    assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">), </span><span style="color:#E06C75;">an_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#61AFEF;">    assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">), </span><span style="color:#E06C75;">an_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#61AFEF;">    assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">3</span><span style="color:#ABB2BF;">), </span><span style="color:#E06C75;">an_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#61AFEF;">    assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">None</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">an_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">    println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;{:?}&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">a</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>你还可以与字符串数组进行对比加深理解。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> a</span><span style="color:#56B6C2;"> =</span><span style="color:#ABB2BF;"> [</span><span style="color:#98C379;">&quot;1&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">(), </span><span style="color:#98C379;">&quot;2&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">(), </span><span style="color:#98C379;">&quot;3&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">()];</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> an_iter</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> a</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">iter</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">    assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#98C379;">&quot;1&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">()), </span><span style="color:#E06C75;">an_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#61AFEF;">    assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#98C379;">&quot;2&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">()), </span><span style="color:#E06C75;">an_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#61AFEF;">    assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#98C379;">&quot;3&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">()), </span><span style="color:#E06C75;">an_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#61AFEF;">    assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">None</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">an_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> an_iter</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> a</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">iter_mut</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">    assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#C678DD;">mut</span><span style="color:#98C379;"> &quot;1&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">()), </span><span style="color:#E06C75;">an_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#61AFEF;">    assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#C678DD;">mut</span><span style="color:#98C379;"> &quot;2&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">()), </span><span style="color:#E06C75;">an_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#61AFEF;">    assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#C678DD;">mut</span><span style="color:#98C379;"> &quot;3&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">()), </span><span style="color:#E06C75;">an_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#61AFEF;">    assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">None</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">an_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> an_iter</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> a</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">into_iter</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">    assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;1&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">()), </span><span style="color:#E06C75;">an_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#61AFEF;">    assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;2&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">()), </span><span style="color:#E06C75;">an_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#61AFEF;">    assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Some</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;3&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">()), </span><span style="color:#E06C75;">an_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#61AFEF;">    assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">None</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">an_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">    println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;{:?}&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">a</span><span style="color:#ABB2BF;">);    </span><span style="color:#7F848E;font-style:italic;">// 请你试试这一行有没有问题？</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>对于整数数组 <code>[1,2,3]</code> 而言，调用 <code>into_iter()</code> 实际会复制一份这个数组，再将复制后的数组转换成迭代器，并消耗掉这个复制后的数组，因此最后的打印语句能把原来那个 a 打印出来。对于字符串数组 <code>[&quot;1&quot;.to_string(), &quot;2&quot;.to_string(), &quot;3&quot;.to_string()]</code> 而言，调用 <code>into_iter()</code> 会直接消耗掉这个字符串数组，因此最后的打印语句不能把原来那个 a 打印出来。</p><p>为什么会有这个差异呢？你可以从我们 <a href="https://time.geekbang.org/column/article/718916" target="_blank" rel="noreferrer">第 2 讲</a> 所有权相关知识中找到答案。</p><h3 id="for-语句的真面目" tabindex="-1">for 语句的真面目 <a class="header-anchor" href="#for-语句的真面目" aria-label="Permalink to &quot;for 语句的真面目&quot;">​</a></h3><p>有了迭代器的背景知识后，我们终于要解开 Rust 语言里面 for 语句的真面目了。for 语句是一种语法糖。语句 <code>for item in c {}</code> 会展开成下面这样：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> tmp_iter</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> c</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">into_iter</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">while</span><span style="color:#C678DD;"> let</span><span style="color:#E5C07B;"> Some</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">item</span><span style="color:#ABB2BF;">) </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> tmp_iter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">() {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>也就是说，for 语句默认使用获取元素所有权的迭代器模式，自动调用了 <code>into_iter()</code> 方法。因此，for 语句会消耗集合 c。同时也说明，要将一个类型放在 for 语句里进行迭代，需要这个类型实现了迭代器 <code>into_iter()</code> 方法。</p><p>标准库中常见的 Range、Vec、HashMap、BtreeMap 等都实现了 <code>into_iter()</code> 方法，因此它们可以放在 for 语句里进行迭代。</p><p>for 语句作为一种基础语法，它会消耗掉原集合。有时候希望不获取原集合元素所有权，比如只是打印一下，这时只需要获取集合元素的引用 ，应该怎么办呢？</p><p>Rust 中也考虑到了这种需求，提供了配套的辅助语法。</p><ul><li>用 <code>for in &amp;c {}</code> 获取元素的不可变引用，相当于调用 <code>c.iter()</code>。</li><li>用 <code>for in &amp;mut c {}</code> 获取元素的可变引用，相当于调用 <code>c.iter_mut()</code>。</li></ul><p>用这两种形式就不会消耗原集合所有权。</p><p>我们来看示例。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> a</span><span style="color:#56B6C2;"> =</span><span style="color:#ABB2BF;"> [</span><span style="color:#98C379;">&quot;1&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">(), </span><span style="color:#98C379;">&quot;2&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">(), </span><span style="color:#98C379;">&quot;3&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">()];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> item</span><span style="color:#C678DD;"> in</span><span style="color:#ABB2BF;"> &amp;</span><span style="color:#E06C75;">a</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#61AFEF;">        println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;{}&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">item</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> item</span><span style="color:#C678DD;"> in</span><span style="color:#ABB2BF;"> &amp;</span><span style="color:#C678DD;">mut</span><span style="color:#E06C75;"> a</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#61AFEF;">        println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;{}&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">item</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> item</span><span style="color:#C678DD;"> in</span><span style="color:#E06C75;"> a</span><span style="color:#ABB2BF;"> {    </span><span style="color:#7F848E;font-style:italic;">// 请想一想为什么要把这一句放在后面</span></span>
<span class="line"><span style="color:#61AFEF;">        println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;{}&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">item</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // println!(&quot;{:?}&quot;, a);</span><span style="color:#7F848E;font-style:italic;">  // 你可以试试把这一句打开</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 输出</span></span>
<span class="line"><span style="color:#D19A66;">1</span></span>
<span class="line"><span style="color:#D19A66;">2</span></span>
<span class="line"><span style="color:#D19A66;">3</span></span>
<span class="line"><span style="color:#D19A66;">1</span></span>
<span class="line"><span style="color:#D19A66;">2</span></span>
<span class="line"><span style="color:#D19A66;">3</span></span>
<span class="line"><span style="color:#D19A66;">1</span></span>
<span class="line"><span style="color:#D19A66;">2</span></span>
<span class="line"><span style="color:#D19A66;">3</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>因为 <code>into_iter()</code> 会消耗集合所有权，因此在上面示例中我们把它放在最后去展示。</p><h3 id="获取集合类型中元素的所有权" tabindex="-1">获取集合类型中元素的所有权 <a class="header-anchor" href="#获取集合类型中元素的所有权" aria-label="Permalink to &quot;获取集合类型中元素的所有权&quot;">​</a></h3><p>我们来看一个简单的例子，一般来说，我们想要获取 Vec 里的一个元素，只需要下标操作就可以了。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> s1</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> String</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">from</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;aaa&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> s2</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> String</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">from</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;bbb&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> s3</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> String</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">from</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;ccc&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> s4</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> String</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">from</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;ddd&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> v</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> vec!</span><span style="color:#ABB2BF;">[</span><span style="color:#E06C75;">s1</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">s2</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">s3</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">s4</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> a</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> v</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">];    </span><span style="color:#7F848E;font-style:italic;">// 这里，我们想访问 s1 的内容</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这段代码稀松平常，在 Rust 中却没办法编译通过。</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span>error[E0507]: cannot move out of index of \`Vec&lt;String&gt;\`</span></span>
<span class="line"><span>  --&gt; src/main.rs:11:13</span></span>
<span class="line"><span>   |</span></span>
<span class="line"><span>11 |     let a = v[0];</span></span>
<span class="line"><span>   |             ^^^^ move occurs because value has type \`String\`, which does not implement the \`Copy\` trait</span></span>
<span class="line"><span>   |</span></span>
<span class="line"><span>help: consider borrowing here</span></span>
<span class="line"><span>   |</span></span>
<span class="line"><span>11 |     let a = &amp;v[0];</span></span>
<span class="line"><span>   |             +</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>提示不能从 <code>Vec&lt;String&gt;</code> 中用下标操作符移出元素。我们改一下代码。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> s1</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> String</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">from</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;aaa&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> s2</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> String</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">from</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;bbb&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> s3</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> String</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">from</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;ccc&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> s4</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> String</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">from</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;ddd&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> v</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> vec!</span><span style="color:#ABB2BF;">[</span><span style="color:#E06C75;">s1</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">s2</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">s3</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">s4</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> a</span><span style="color:#56B6C2;"> =</span><span style="color:#ABB2BF;"> &amp;</span><span style="color:#E06C75;">v</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">];  </span><span style="color:#7F848E;font-style:italic;">// 明确a只获得v中第一个元素的引用</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>明确 a 只获得 v 中第一个元素的引用，这下可以编译通过了。这里，你可以顺便思考一下，对于 <code>Vec&lt;u32&gt;</code> 这种类型的动态数组，let a = v[0]; 这种代码可以编译通过吗？你可以立即动手测试一下。</p><p>在上面示例中，你可能为了从集合中获得 s1 的所有权，而不得不使用 <code>let a = v[0].clone()</code>。而根据我们这节课讲的迭代器知识，使用 <code>into_iter()</code> 就可以拿到并操作上述动态数组 v 中元素的所有权。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> s1</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> String</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">from</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;aaa&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> s2</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> String</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">from</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;bbb&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> s3</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> String</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">from</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;ccc&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> s4</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> String</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">from</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;ddd&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> v</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> vec!</span><span style="color:#ABB2BF;">[</span><span style="color:#E06C75;">s1</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">s2</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">s3</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">s4</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> s</span><span style="color:#C678DD;"> in</span><span style="color:#E06C75;"> v</span><span style="color:#ABB2BF;"> {      </span><span style="color:#7F848E;font-style:italic;">// 这里，s拿到了集合元素的所有权</span></span>
<span class="line"><span style="color:#61AFEF;">        println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;{}&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">s</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这也体现了 Rust 对权限有相当细致的管理。对于下标索引这种不安全的操作，禁止获得集合元素所有权；对于迭代器这种安全的操作，允许它获得集合元素所有权。</p><h2 id="小结" tabindex="-1">小结 <a class="header-anchor" href="#小结" aria-label="Permalink to &quot;小结&quot;">​</a></h2><p>我们这节课详细探讨了 Rust 中的 <code>Option&lt;T&gt;</code> 和 <code>Result&lt;T, E&gt;</code> 的定义及常见操作。学习了如何以解包和不解包方式使用它们。内容比较细，风格可能也是你不太熟悉的。不过现在你只需要先了解这种代码风格，以后的项目实践中再慢慢掌握它们。</p><p>我们还介绍了迭代器的概念。迭代器的 <code>next()</code> 方法会返回一个 <code>Option&lt;Item&gt;</code> 类型。在所有权三态理论的指导下 Rust 中的迭代器也划分成了三种，可以通过不同的方法获取到集合元素的不可变引用、可变引用和所有权，这是 Rust 和其他语言的迭代器很不一样的地方。每种迭代器都有各自适用的场景，正确使用迭代器能提高代码的可靠性和可阅读性。</p><p><img src="`+c+'" alt=""></p><p>学习完这节课的内容之后，你应该能更深刻地感受到所有权概念在 Rust 语言中的支配地位。</p><h2 id="思考题" tabindex="-1">思考题 <a class="header-anchor" href="#思考题" aria-label="Permalink to &quot;思考题&quot;">​</a></h2><p>你可以用同样的思路去研究一下，看看如何拿到 HashMap 中值的所有权。</p><p><a href="https://doc.rust-lang.org/std/collections/struct.HashMap.html" target="_blank" rel="noreferrer">https://doc.rust-lang.org/std/collections/struct.HashMap.html</a></p><p>欢迎你把你的成果展示在评论区，也欢迎你把这节课的内容分享给需要的朋友，邀他一起学习，我们下节课再见！</p>',144)]))}const E=n(B,[["render",y]]);export{b as __pageData,E as default};
