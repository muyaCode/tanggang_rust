import{_ as n,c as a,o as l,ag as p}from"./chunks/framework.D2WelYEY.js";const e="/tanggang_rust/assets/d2d37a5cb5c776b0eba5b91d4ffd1166.BFx0aKSu.png",d=JSON.parse('{"title":"25 ｜ Rust GUI 编程：用 Slint 为 Chatbot 实现一个界面","description":"","frontmatter":{},"headers":[],"relativePath":"Document/25｜RustGUI编程：用Slint为Chatbot实现一个界面.md","filePath":"Document/25｜RustGUI编程：用Slint为Chatbot实现一个界面.md","lastUpdated":1740766764000}'),o={name:"Document/25｜RustGUI编程：用Slint为Chatbot实现一个界面.md"};function r(t,s,c,B,i,y){return l(),a("div",null,s[0]||(s[0]=[p(`<h1 id="_25-rust-gui-编程-用-slint-为-chatbot-实现一个界面" tabindex="-1">25 ｜ Rust GUI 编程：用 Slint 为 Chatbot 实现一个界面 <a class="header-anchor" href="#_25-rust-gui-编程-用-slint-为-chatbot-实现一个界面" aria-label="Permalink to &quot;25 ｜ Rust GUI 编程：用 Slint 为 Chatbot 实现一个界面&quot;">​</a></h1><p>你好，我是 Mike。今天我们一起来学习如何用 Rust 进行 GUI 开发，我们用的 GUI 库是 Slint。</p><p>GUI 开发非常有趣，它能让你看到立竿见影的效果。这是为什么很多人学习编程喜欢从 GUI 开发开始（Web 开发也是类似的道理）。而且 GUI 库还能用来做点小游戏什么的，非常有趣。而这两年，Rust 生态中冒出来几个非常不错的 GUI 库，比如 Slint、egui、Makepad 等，今天我们就以 Slint 为例来讲讲。</p><p>学完这节课的内容，你就能使用 Rust 动手编写 GUI 程序了。</p><h2 id="slint-简介" tabindex="-1">Slint 简介 <a class="header-anchor" href="#slint-简介" aria-label="Permalink to &quot;Slint 简介&quot;">​</a></h2><p>Slint 是一个轻量级的 GUI 框架，使用 Rust 实现，提供了 Rust、CPP、JavaScript 接口。对，你没看错，你也可以用 JavaScript 来调用 Slint 库做 GUI 开发。Slint 的架构简洁优美，你可以在 1 ～ 2 天的时间里掌握它的理念和编程方法。</p><p>Slint 的两位创始人之前是 QT 的核心开发者，因此从 Slint 上可以看到非常浓厚的 QT（主要是 QML）风格。QT 是目前 IT 业界最流行的品质最好的开源跨平台 GUI 库，可以说 Slint 继承了 QT 的最佳实践，同时又与编程语言界的最佳实践 Rust 结合起来，得到了一个相当优美的 GUI 框架。</p><p>Slint 可以在 Windows、macOS、Linux、浏览器，以及各种嵌入式平台上运行，现在也在做 Android 和 iOS 的适配工作。Slint 支持多国语言，它是使用 gettext 这种传统的 Linux 方式来做的。</p><p>这是 Slint 的 <a href="https://slint.dev" target="_blank" rel="noreferrer">官方地址</a>，你可以在浏览器里面体验它的 <a href="https://slintpad.com/" target="_blank" rel="noreferrer">demos</a>，还有 2 个比较重要的资料，就是 <a href="https://slint.dev/releases/1.3.2/docs/slint/src/language/" target="_blank" rel="noreferrer">reference</a> 和 <a href="https://docs.rs/slint/latest/slint/index.html" target="_blank" rel="noreferrer">Rust API</a>，你可以点击链接了解一下。</p><p>注：这一讲的代码适用于 Slint v1.3 版本。</p><h3 id="界面语言-slint" tabindex="-1">界面语言 slint <a class="header-anchor" href="#界面语言-slint" aria-label="Permalink to &quot;界面语言 slint&quot;">​</a></h3><p>Slint 自己设计了一门界面描述语言 slint，界面描述文件以 .slint 后缀结尾。slint 看起来是下面这个样子：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">component</span><span style="color:#E5C07B;"> MyButton</span><span style="color:#E06C75;"> inherits</span><span style="color:#E5C07B;"> Text</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">    color</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">black</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // ...</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#E06C75;">export</span><span style="color:#E06C75;"> component</span><span style="color:#E5C07B;"> MyApp</span><span style="color:#E06C75;"> inherits</span><span style="color:#E5C07B;"> Window</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">    preferred</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">width</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">200px</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    preferred</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">height</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">100px</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    Rectangle</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">        width</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">200px</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        height</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">100px</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        background</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">green</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#E5C07B;">    MyButton</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">        x</span><span style="color:#ABB2BF;">:</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">;</span><span style="color:#E06C75;">y</span><span style="color:#ABB2BF;">:</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        text</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;hello&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#E5C07B;">    MyButton</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">        y</span><span style="color:#ABB2BF;">:</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        x</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">50px</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        text</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;world&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>slint 这门“新语言”只是用于界面描述的，并不是真正的编程语言，因此你可以把它当作 HTML 这种 Markup 语言来看待。</p><p>界面相关的基础设施在 slint 里面都有，比如用来布局的 HorizontalLayout、VerticalLayout、GridLayout、对齐、stretch、字体、各种属性设置、各种基本控件等等。</p><h3 id="component" tabindex="-1">Component <a class="header-anchor" href="#component" aria-label="Permalink to &quot;Component&quot;">​</a></h3><p>你的所有界面都应该放在一棵 Component 组件树里面。比如上面的示例中，MyApp 继承自 Slint 提供的 Window 组件，也叫基础元素 Element，MyButton 继承自 Text 基础元素。MyApp 中可以包含 Slint 基础元素或自定义的其他组件。这样就形成了一棵界面的组件树。</p><p>export 关键字用来表明这个组件可以被外部 .slint 文件使用，这样就可以用来开发界面库，供其他应用使用。</p><h4 id="property" tabindex="-1">Property <a class="header-anchor" href="#property" aria-label="Permalink to &quot;Property&quot;">​</a></h4><p>属性分为基础预定义属性和自定义属性。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">export</span><span style="color:#E06C75;"> component</span><span style="color:#E5C07B;"> Example</span><span style="color:#E06C75;"> inherits</span><span style="color:#E5C07B;"> Window</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">    width</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">42px</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    height</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">42px</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>例子里的 width 和 height 就是基础属性。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">export</span><span style="color:#E06C75;"> component</span><span style="color:#E5C07B;"> Example</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">    property</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E06C75;">int</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#E06C75;">my</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">property</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    property</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E06C75;">int</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#E06C75;">my</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">second</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">property</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">42</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>代码里的 my-property 和 my-second-property 就是自定义属性，用 <code>property&lt;T&gt;</code> 的形式来定义。属性可以用 in、out、in-out、private 等修饰符修饰。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">export</span><span style="color:#E06C75;"> component</span><span style="color:#E5C07B;"> Button</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">    in</span><span style="color:#E06C75;"> property</span><span style="color:#ABB2BF;"> &lt;</span><span style="color:#E06C75;">string</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#E06C75;">text</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    out</span><span style="color:#E06C75;"> property</span><span style="color:#ABB2BF;"> &lt;</span><span style="color:#E5C07B;">bool</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#E06C75;">pressed</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    in</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">out</span><span style="color:#E06C75;"> property</span><span style="color:#ABB2BF;"> &lt;</span><span style="color:#E5C07B;">bool</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#E06C75;">checked</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    private</span><span style="color:#E06C75;"> property</span><span style="color:#ABB2BF;"> &lt;</span><span style="color:#E5C07B;">bool</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#E06C75;">has</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">mouse</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>其中：</p><ul><li>in：表示这个属性只能被这个组件的用户（比如 Rust 代码）修改，或者以绑定的形式被修改，在.slint 文件内不能用赋值语句修改这个属性。</li><li>out：表示这个属性只能被这个组件内部修改，也就是在.slint 文件中定义的逻辑去修改，在外部使用的时候，比如 Rust 语言中，只能读，不能改。</li><li>in-out：内部外部都能改，也都能读。</li><li>private：这个属性只能由本组件在内部访问，不能由这个组件的父组件访问，也不能在 Rust 中访问。</li></ul><h4 id="绑定" tabindex="-1">绑定 <a class="header-anchor" href="#绑定" aria-label="Permalink to &quot;绑定&quot;">​</a></h4><p>与 React 等现代 Web 前端框架类似，Slint 中也有绑定概念。绑定给编程带来了很好的体验，比如下面代码：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E5C07B;">Button</span><span style="color:#ABB2BF;"> } </span><span style="color:#E06C75;">from</span><span style="color:#98C379;"> &quot;std-widgets.slint&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">export</span><span style="color:#E06C75;"> component</span><span style="color:#E5C07B;"> Example</span><span style="color:#E06C75;"> inherits</span><span style="color:#E5C07B;"> Window</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">    preferred</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">width</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">50px</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    preferred</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">height</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">50px</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    Button</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">        property</span><span style="color:#ABB2BF;"> &lt;</span><span style="color:#E06C75;">int</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#E06C75;">counter</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">3</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        clicked</span><span style="color:#ABB2BF;"> =&gt; { </span><span style="color:#E5C07B;">self</span><span style="color:#ABB2BF;">.counter </span><span style="color:#56B6C2;">+=</span><span style="color:#D19A66;"> 3</span><span style="color:#ABB2BF;"> }</span></span>
<span class="line"><span style="color:#E06C75;">        text</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">self</span><span style="color:#ABB2BF;">.counter * </span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Button 的 text 属性，就随着 counter 属性的变化而自动变化，Slint 在内部自动做了重新计算和更新状态的通知，不用我们操心。</p><p>更棒的是还有双向绑定这个东西，看下面的示例：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">export</span><span style="color:#E06C75;"> component</span><span style="color:#E5C07B;"> Example</span><span style="color:#ABB2BF;">  {</span></span>
<span class="line"><span style="color:#C678DD;">    in</span><span style="color:#E06C75;"> property</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E06C75;">brush</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#E06C75;">rect</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">color</span><span style="color:#56B6C2;"> &lt;=</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#E06C75;">r</span><span style="color:#ABB2BF;">.background;</span></span>
<span class="line"><span style="color:#E06C75;">    r</span><span style="color:#ABB2BF;">:</span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Rectangle</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">        width</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">parent</span><span style="color:#ABB2BF;">.width;</span></span>
<span class="line"><span style="color:#E06C75;">        height</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">parent</span><span style="color:#ABB2BF;">.height;</span></span>
<span class="line"><span style="color:#E06C75;">        background</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">blue</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>双向绑定用 <code>&lt;=&gt;</code> 符号，表示这两个属性始终同步。上面的示例里，Example component 的 rect-color 属性和它的子元素 Rectangle r 的 background 双向绑定上了，因此它们任何一方变化了，另一方就会自动跟着变化。这里 <code>r := Rectangle</code> 这个语法表示给这个子元素命名为 r，然后这个 r 就可以在这个 component 里的其他地方引用，用来指代这个子元素。</p><p>有了绑定，我们写业务就能节省大量样板代码，而且不容易出错。</p><h4 id="callback" tabindex="-1">Callback <a class="header-anchor" href="#callback" aria-label="Permalink to &quot;Callback&quot;">​</a></h4><p>回调用于这个 component 内部元素之间，以及和外部 Rust 代码之间进行交互。看下面代码：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">export</span><span style="color:#E06C75;"> component</span><span style="color:#E5C07B;"> Example</span><span style="color:#E06C75;"> inherits</span><span style="color:#E5C07B;"> Rectangle</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">    callback</span><span style="color:#E06C75;"> hello</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;">    area</span><span style="color:#ABB2BF;"> :</span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> TouchArea</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">        clicked</span><span style="color:#ABB2BF;"> =&gt; {</span></span>
<span class="line"><span style="color:#E06C75;">            root</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">hello</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>代码定义了 callback hello。TouchArea 子元素有个 clicked 预定义的 callback，点击的时候会触发，触发时执行 Example 组件中的 hello 回调，就是我们刚才定义那个 callback hello。</p><p>可以看到 hello 回调还没有回调体实现，我们可以使用下面这种形式，在这个组件内部或者在 Rust 侧进行实现。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">ui_handle</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">on_hello</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">move</span><span style="color:#56B6C2;"> ||</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    //</span></span>
<span class="line"><span style="color:#ABB2BF;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>写的时候在 Rust 侧自动加上 <code>on_</code> 前缀，给这个组件定义一个回调的函数内容。</p><h3 id="内置-widgets" tabindex="-1">内置 Widgets <a class="header-anchor" href="#内置-widgets" aria-label="Permalink to &quot;内置 Widgets&quot;">​</a></h3><p>Slint 内置了一些控件，它们就是预定义的组件实现。现在控件不算多，还需要继续努力开发。目前就是下面这些。</p><ul><li>AboutSlint</li><li>Button</li><li>CheckBox</li><li>ComboBox</li><li>GridBox</li><li>GroupBox</li><li>HorizontalBox</li><li>LineEdit</li><li>ListView</li><li>ProgressIndication</li><li>ScrollView</li><li>Slider</li><li>SpinBox</li><li>Spinner</li><li>StandardButton</li><li>StandardListView</li><li>StandardTableView</li><li>Switch</li><li>TabWidget</li><li>TextEdit</li><li>VeticalBox</li></ul><p>如果你以前有过 GUI 开发的经验，通过这些名字应该能知道它们是什么。如果没有，可以看看 Slint 官方的详细说明。这些控件虽然不算太多，但是基本够用。并且在 Slint 中开发新控件很简单，你可以看 <a href="https://slint.dev/releases/1.3.2/docs/slint/src/recipes/recipes#custom-widgets" target="_blank" rel="noreferrer">自定义控件介绍</a>，参考 <a href="https://github.com/Surrealism-All/SurrealismUI" target="_blank" rel="noreferrer">这个链接</a> 里的内容为 Slint 做一个第三方的控件库扩展库。</p><h3 id="编程范式" tabindex="-1">编程范式 <a class="header-anchor" href="#编程范式" aria-label="Permalink to &quot;编程范式&quot;">​</a></h3><p>Slint 的编程范式和其他很多 GUI 框架有些不同，整体显得非常扁平。比如，在 Slint 中你无法在 Rust 代码中通过查找拿到某一个 element 的 handle，而是要把 element 需要交互的属性映射到顶层 component 的属性上去，通过顶层 App 的 handle 去交互。</p><p>Slint 页面描述语言显得相当内聚，在 Rust 代码里（目前）只能通过顶层 App handle 与页面进行交互，而在页面内部则可以充分展开绑定、更新、callback 调用等工作。我们在后面的示例里可以充分感受到。</p><h3 id="扩展样式" tabindex="-1">扩展样式 <a class="header-anchor" href="#扩展样式" aria-label="Permalink to &quot;扩展样式&quot;">​</a></h3><p>一般，Slint 编译出来的界面样式是地道的，也就是说，在哪个平台上就是哪个平台的风格，但是也可以手动选择样式。目前支持 fluent、material、cupertino、qt 等几种样式。你可以点击 <a href="https://slint.dev/releases/1.3.2/docs/slint/src/advanced/style" target="_blank" rel="noreferrer">链接</a> 了解更多。</p><p>在了解了 Slint 的基本概念之后，下面我们开始实操。</p><h3 id="ide-插件" tabindex="-1">IDE 插件 <a class="header-anchor" href="#ide-插件" aria-label="Permalink to &quot;IDE 插件&quot;">​</a></h3><p>VS Code 有 Slint 的插件，对于编写界面和 Rust 逻辑代码来说非常方便，一定得用。</p><h2 id="chatbot-实战" tabindex="-1">Chatbot 实战 <a class="header-anchor" href="#chatbot-实战" aria-label="Permalink to &quot;Chatbot 实战&quot;">​</a></h2><p>我们要把 <a href="https://time.geekbang.org/column/article/734931" target="_blank" rel="noreferrer">第 23 讲</a> 的 chatbot 命令行程序做成一个 GUI 程序，双击就可以运行。下面的示例我在 Windows 上实现，但是代码是跨平台的，不用做任何改动，你可以在其他系统上做实验，如果有问题可以在评论区留言反馈。</p><h3 id="创建项目" tabindex="-1">创建项目 <a class="header-anchor" href="#创建项目" aria-label="Permalink to &quot;创建项目&quot;">​</a></h3><p>Slint 官方提供了一个 Rust 项目模板，我们直接用那个。</p><p>我们使用 cargo-generate 下载这个模板。如果没有安装这个工具，请执行下面这行命令。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">cargo</span><span style="color:#E06C75;"> install</span><span style="color:#E06C75;"> cargo</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">generate</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>安装后下载模板。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">cargo</span><span style="color:#E06C75;"> generate</span><span style="color:#ABB2BF;"> --</span><span style="color:#E06C75;">git</span><span style="color:#E06C75;"> https</span><span style="color:#ABB2BF;">:</span><span style="color:#7F848E;font-style:italic;">//github.com/slint-ui/slint-rust-template --name my-project</span></span>
<span class="line"><span style="color:#E06C75;">cd</span><span style="color:#E06C75;"> my</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">project</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这里面实现了一个简单的计数器示例。你可以用 <code>cargo run</code> 运行一下，看一下能否弹出来窗口界面。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">cargo</span><span style="color:#E06C75;"> run</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>只要你之前安装好了 Rust，运行这个命令会自动下载依赖并编译，最后能顺利弹出 GUI App 程序。你可以回忆一下，以前为了开发 Windows GUI 程序，是不是得下载一堆玩意儿，还得自己一个一个安装并配置。所以这里你就能看到，用 Rust 开发真的是太方便了。</p><h3 id="依赖库" tabindex="-1">依赖库 <a class="header-anchor" href="#依赖库" aria-label="Permalink to &quot;依赖库&quot;">​</a></h3><p>我们打开 Cargo.toml 文件看一下，发现依赖只有下面两个。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">[</span><span style="color:#E06C75;">dependencies</span><span style="color:#ABB2BF;">]</span></span>
<span class="line"><span style="color:#E06C75;">slint</span><span style="color:#56B6C2;"> =</span><span style="color:#98C379;"> &quot;1.0&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">[</span><span style="color:#E06C75;">build</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">dependencies</span><span style="color:#ABB2BF;">]</span></span>
<span class="line"><span style="color:#E06C75;">slint</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">build</span><span style="color:#56B6C2;"> =</span><span style="color:#98C379;"> &quot;1.0&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="添加代码" tabindex="-1">添加代码 <a class="header-anchor" href="#添加代码" aria-label="Permalink to &quot;添加代码&quot;">​</a></h3><p>我做了一份 <a href="https://github.com/miketang84/jikeshijian/tree/master/25-slint-chatbot-demo" target="_blank" rel="noreferrer">样例代码</a>，你可以把代码和对应的模型文件下载下来，然后执行命令。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">cargo</span><span style="color:#E06C75;"> run</span><span style="color:#ABB2BF;"> --</span><span style="color:#E06C75;">release</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="运行效果" tabindex="-1">运行效果 <a class="header-anchor" href="#运行效果" aria-label="Permalink to &quot;运行效果&quot;">​</a></h3><p><img src="`+e+`" alt="图片"></p><p>可以看到，这只是一个简单的聊天对话窗口，一个简单的 GUI 应用。它也是一个单机版的大语言模型聊天机器人，用的 LLM 是 OpenChat 3.5 量子化 Q4 版本。请一定要按照这个仓库里的指令下载相关模型文件。</p><h3 id="代码详解" tabindex="-1">代码详解 <a class="header-anchor" href="#代码详解" aria-label="Permalink to &quot;代码详解&quot;">​</a></h3><h4 id="appwindow-slint" tabindex="-1">appwindow.slint <a class="header-anchor" href="#appwindow-slint" aria-label="Permalink to &quot;appwindow.slint&quot;">​</a></h4><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E5C07B;">Button</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">VerticalBox</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">TextEdit</span><span style="color:#ABB2BF;"> } </span><span style="color:#E06C75;">from</span><span style="color:#98C379;"> &quot;std-widgets.slint&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;">export</span><span style="color:#E06C75;"> component</span><span style="color:#E5C07B;"> AppWindow</span><span style="color:#E06C75;"> inherits</span><span style="color:#E5C07B;"> Window</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">    title</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;OpenChat Bot&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    width</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">500px</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    height</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">550px</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">    forward</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">focus</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">ed2</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    in</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">out</span><span style="color:#E06C75;"> property</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E06C75;">string</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#E06C75;">dialog</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    in</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">out</span><span style="color:#E06C75;"> property</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E06C75;">string</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#E06C75;">input</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">ask</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;">    callback</span><span style="color:#E06C75;"> send</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">ask</span><span style="color:#ABB2BF;">-</span><span style="color:#61AFEF;">content</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">string</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;">    VerticalBox</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">        Text</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">            text</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;Model: openchat_3.5.Q4_K_M.gguf&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#E06C75;">        ed1</span><span style="color:#ABB2BF;"> :</span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> TextEdit</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">            font</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">size</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">15px</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            width</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">parent</span><span style="color:#ABB2BF;">.width - </span><span style="color:#E06C75;">20px</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            vertical</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">stretch</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            read</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">only</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            text</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">root</span><span style="color:#ABB2BF;">.dialog;</span></span>
<span class="line"><span style="color:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#E06C75;">        ed2</span><span style="color:#ABB2BF;"> :</span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> TextEdit</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">            font</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">size</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">15px</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            width</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">parent</span><span style="color:#ABB2BF;">.width - </span><span style="color:#E06C75;">20px</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            height</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">100px</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            text</span><span style="color:#56B6C2;"> &lt;=</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#E06C75;">root</span><span style="color:#ABB2BF;">.input-</span><span style="color:#E06C75;">ask</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#E5C07B;">        Button</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">            text</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&quot;Send&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">            clicked</span><span style="color:#ABB2BF;"> =&gt; {</span></span>
<span class="line"><span style="color:#E06C75;">                root</span><span style="color:#ABB2BF;">.send-</span><span style="color:#E06C75;">ask</span><span style="color:#ABB2BF;">-</span><span style="color:#61AFEF;">content</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">root</span><span style="color:#ABB2BF;">.input-</span><span style="color:#E06C75;">ask</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E06C75;">                ed2</span><span style="color:#ABB2BF;">.text </span><span style="color:#56B6C2;">=</span><span style="color:#98C379;"> &quot;&quot;</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">            }</span></span>
<span class="line"><span style="color:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>我来解释一下这段代码。</p><p>代码开头，也就是第 1 行，从 std-widgets.slint 基础控件库中引入 Button、VerticalBox、TextEdit 三种控件。然后第 3 行定义 AppWindow，从 Window 中继承过来。</p><p>第 4 ～ 6 行，设置窗口相关基本属性。第 7 行的作用是把窗口打开后的焦点传递到 ed2 里，往下看，ed2 就是我们的聊天语句输入框。</p><p>第 9 ～ 10 行，定义两个应用级别的属性（顶层自定义属性），dialog 表示信息窗口的内容，input-ask 表示问题窗口的输入内容。第 12 行定义一个 callback，这里只有签名，没有具体实现，具体实现在后面的 Rust 代码中来填充。第 14 行使用 VerticalBox 进行垂直布局。第 15 ～ 17 是文本标签控件，用于显示当前用的什么模型。</p><p>第 18 ～ 24，用 TextEdit 控件表示对话消息显示窗口。可以看到，它的 text 属性被绑定到了上层属性 root.dialog。dialog 属性的更新会导致这个 TextEdit 的 text 显示内容自动更新。这里这个 root 表示当前 component 的顶层，这里也可以用 parent.dialog，表示当前元素的上一层。这里的 vertical-stretch 表示扩展填充，方便布局。这个控件元素用 <code>:=</code> 符号命名为 ed1。</p><p>第 25 ～ 30 行，用 TextEdit 控件表示聊天输入窗口。它的 text 属性被绑定到了 <code>root.input-ask</code>。用的双向绑定 <code>&lt;=&gt;</code> 符号。这个意思是，聊天输入窗口的内容变了， <code>root.input-ask</code> 属性自动同步，反过来也是这样。</p><p>第 31 ～ 37 行，定义了一个按钮 Button。实现了其 clicked 回调，当被点击的时候，会调用这个回调。这个回调里面，调用了顶层定义的回调函数 <code>root.send-ask-content(root.input-ask)</code>，同时将聊天输入框中的内容清空。</p><p>只有这么三十几行代码，所以这个界面本身是比较简单的。下面我们来看一下对应的 Rust 文件。</p><h4 id="main-rs" tabindex="-1">main.rs <a class="header-anchor" href="#main-rs" aria-label="Permalink to &quot;main.rs&quot;">​</a></h4><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">#![allow(unused)]</span></span>
<span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> std</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">sync</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">mpsc</span><span style="color:#ABB2BF;">::channel;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">mod</span><span style="color:#ABB2BF;"> token_output_stream;</span></span>
<span class="line"><span style="color:#C678DD;">mod</span><span style="color:#ABB2BF;"> llmengin;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;">slint</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">include_modules!</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">() -&gt; </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">&lt;(), </span><span style="color:#E06C75;">slint</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">PlatformError</span><span style="color:#ABB2BF;">&gt; {</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> ui</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> AppWindow</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">new</span><span style="color:#ABB2BF;">()?;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> ui_handle</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> ui</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">as_weak</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;">sender</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">receiver</span><span style="color:#ABB2BF;">) </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> channel</span><span style="color:#ABB2BF;">::&lt;</span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">&gt;();</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> sender1</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> sender</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">clone</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> _thread</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> std</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">thread</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">spawn</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">move</span><span style="color:#56B6C2;"> ||</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#C678DD;"> let</span><span style="color:#E5C07B;"> Err</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">_</span><span style="color:#ABB2BF;">) </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> llmengin</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">start_engine</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">ui_handle</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">receiver</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // process before exit.</span></span>
<span class="line"><span style="color:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#ABB2BF;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> ui_handle</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> ui</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">as_weak</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E06C75;">    ui</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">on_send_ask_content</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">move</span><span style="color:#56B6C2;"> |</span><span style="color:#E06C75;">content</span><span style="color:#56B6C2;">|</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#61AFEF;">        update_dialog</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">ui_handle</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">clone</span><span style="color:#ABB2BF;">(), </span><span style="color:#E06C75;">content</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#E06C75;">        sender</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">send</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">content</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">()).</span><span style="color:#61AFEF;">unwrap</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;">    ui</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">window</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">on_close_requested</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">move</span><span style="color:#56B6C2;"> ||</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">        sender1</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">send</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;_exit_&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">()).</span><span style="color:#61AFEF;">unwrap</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E5C07B;">        slint</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">CloseRequestResponse</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">HideWindow</span></span>
<span class="line"><span style="color:#ABB2BF;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;">    ui</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">run</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> update_dialog</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">ui_handle</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">slint</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">Weak</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">AppWindow</span><span style="color:#ABB2BF;">&gt;, </span><span style="color:#E06C75;">msg</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E06C75;">    _</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> slint</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">invoke_from_event_loop</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">move</span><span style="color:#56B6C2;"> ||</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">        let</span><span style="color:#E06C75;"> ui_handle</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> ui_handle</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unwrap</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">        let</span><span style="color:#E06C75;"> old_content</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> ui_handle</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get_dialog</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E06C75;">        ui_handle</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">set_dialog</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">old_content</span><span style="color:#ABB2BF;"> + &amp;</span><span style="color:#E06C75;">msg</span><span style="color:#ABB2BF;"> + </span><span style="color:#98C379;">&quot;</span><span style="color:#56B6C2;">\\n</span><span style="color:#98C379;">&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    });</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> update_dialog_without_ln</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">ui_handle</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">slint</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">Weak</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">AppWindow</span><span style="color:#ABB2BF;">&gt;, </span><span style="color:#E06C75;">msg</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E06C75;">    _</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> slint</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">invoke_from_event_loop</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">move</span><span style="color:#56B6C2;"> ||</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">        let</span><span style="color:#E06C75;"> ui_handle</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> ui_handle</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unwrap</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">        let</span><span style="color:#E06C75;"> old_content</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> ui_handle</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get_dialog</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E06C75;">        ui_handle</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">set_dialog</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">old_content</span><span style="color:#ABB2BF;"> + &amp;</span><span style="color:#E06C75;">msg</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    });</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>第 4 ～ 5 行引入大模型引擎实现模块。第 7 行用 <code>slint::include_modules!()</code> 将编译后的 slint 界面资源文件加载进来。</p><p>第 10 行创建 AppWindow 实例，这个 AppWindow 就是前面 slint 文件中定义的 AppWindow 组件，也就是当前应用。第 12 行获得 AppWindow 实例的弱引用。弱引用在 Rust 中是一种智能指针，用来防止产生循环引用。我们这里照做就行了。</p><p>第 13 ～ 14 行创建一个 MPSC 的 channel。这个 channel 是 Rust 标准库里的，用于在线程间进行通信。</p><p>第 16 ～ 20 行启动一个新的系统线程。我们这个是一个本地大模型推理应用，大模型的推理是非常消耗资源的，我们不应该放在主线程（主循环，同时负责渲染 UI）中，而应该放在后台信息中执行。 <code>llmengin::start_engine()</code> 就用于启动这个后台任务。可以看到，我们将弱引用 <code>ui_handle</code> 传了进去，用于在后台任务中拿到主线程的句柄，方便更新内容。同时，我们把 receiver 传了进去，这样后台任务就可以接收 UI 主线程发来的消息了。</p><p>第 22 ～ 26 行的 <code>on_send_ask_content()</code> 用来填充 slint 界面文件中定义的 <code>send-ask-content(string)</code> 回调函数，给这个回调函数填充具体的执行逻辑。这个函数名是按映射规则由 slint 自动为我们生成的，也就是在前面加了 <code>on_</code> 前缀，并且把 - 号替换成了 _ 号。具体来说执行了两个任务，一是把聊天输入框的内容更新到消息对话窗口中，二是用 channel 的 sender 向后台任务发送消息。</p><p>第 28 ～ 31 行用来处理当窗口关闭时的行为，因为我们有后台任务，后台任务与前台 main loop 任务都是两个 loop 在无限跑，我们不能对后台任务用 join 方法，因为那样会阻塞主线程循环。在主线程循环退出的时候，也要通知后台任务退出，这样才安全。</p><p>剩下的 <code>update_dialog()</code> 和 <code>update_dialog_without_ln()</code> 就是用来更新消息对话窗口的内容的。 <code>slint::invoke_from_event_loop()</code> 可以在任何线程中调用，它保证这个函数中的闭包会在主线程循环中被调用。</p><p>这里其实在它内部用了一个 <strong>channel queue</strong> 来实现。也就是说，后台任务的输出结果，不需要我们手动地传回到主线程中来操作了，只需要调用这个函数，就可以将界面上对应的内容更新。更新 UI 的逻辑，实际的执行还是在主线程中做的。 <code>ui_handle.get_dialog()</code> 和 <code>ui_handle.set_dialog()</code> 是 slint 自动帮我们生成的，就是在顶层属性 dialog 上自动生成了 getter 和 setter。</p><h4 id="llmengin-rs" tabindex="-1">llmengin.rs <a class="header-anchor" href="#llmengin-rs" aria-label="Permalink to &quot;llmengin.rs&quot;">​</a></h4><p>llmengin.rs 代码行数比较多，你可以打开 <a href="https://github.com/miketang84/jikeshijian/blob/master/25-slint-chatbot-demo/src/llmengin.rs" target="_blank" rel="noreferrer">链接</a> 查看。代码大体上和 <a href="https://time.geekbang.org/column/article/734931" target="_blank" rel="noreferrer">第 23 讲</a> 是一样的，不过有几处更改。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// 这几行代码片段从llmengin.rs文件中的第99行开始</span></span>
<span class="line"><span style="color:#E5C07B;font-style:italic;">super</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">update_dialog_without_ln</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">ui_handle</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">clone</span><span style="color:#ABB2BF;">(), </span><span style="color:#98C379;">&quot;&gt; &quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> ask</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> receiver</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">recv</span><span style="color:#ABB2BF;">().</span><span style="color:#61AFEF;">unwrap</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">if</span><span style="color:#E06C75;"> ask</span><span style="color:#56B6C2;"> ==</span><span style="color:#98C379;"> &quot;_exit_&quot;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E5C07B;"> Err</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">anyhow</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">anyhow!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;exit&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">()));</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> prompt_str</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> format!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;User:{ask}&lt;|end_of_turn|&gt;Assistant:&quot;</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><a href="https://github.com/miketang84/jikeshijian/blob/master/25-slint-chatbot-demo/src/llmengin.rs#L101" target="_blank" rel="noreferrer">第 101 行</a> 使用了 <code>let ask = receiver.recv().unwrap();</code> 来从 channel 中接收信息，也就是从主线程中接收聊天输入消息。第 102 ～ 104 行是用来处理退出后台线程的指令。在这里你可以看到 <code>anyhow!</code> 的用法。</p><p>其他的就是把 <code>print!()</code> 代码全部换成了 <code>super::update_dialog_*()</code> 相关代码，用来把输出结果更新到界面上去。</p><p>整体来说，还是非常简单的。</p><h2 id="小结" tabindex="-1">小结 <a class="header-anchor" href="#小结" aria-label="Permalink to &quot;小结&quot;">​</a></h2><p>这节课我们通过这短短几十行代码，就使用 Slint 框架，用 Rust 做了一个 GUI 应用。而且整个过程中，我们甚至不需要手动下载额外的依赖安装包，一个命令 <code>cargo run</code> 就搞定了。这就是 Rust 相比于 C++甚至 Python 更方便的地方。</p><p>在这个示例里，我们对 <a href="https://time.geekbang.org/column/article/734931" target="_blank" rel="noreferrer">第 23 讲</a> 的 chatbot 代码做了一些改造，主要的变化在输入和输出上面。改的也不多，只有几行。</p><p>后台任务是一个重要概念，因为 GUI 界面需要有一个系统线程主循环来负责更新，耗时比较多的任务不应该放在这个线程里运行，不然会让界面显得很卡。 <strong>我们应该使用 <code>std::thread::spawn</code> 创建一个新的系统级线程来运行</strong>。</p><p>通过这个示例，我们了解了 Slint GUI 框架的基本概念、编程范式。Slint 确实是一个非常简单明了的框架。在熟悉它的规则之后，用它来开发 GUI 程序是非常快速便捷的。更可喜的是，用 Slint 编程的程序可以在各大主流平台上运行，还能在网页上运行，快速分发部署，非常方便。</p><p>Slint 的设计风格延续了 Qt（QML）的风格，可以说是业界的最佳实践。使用 <strong>Rust + Slint</strong>，我们能非常快速地实现我们的想法。还等什么，用 Slint 做一些有趣的东西吧！</p><h2 id="思考题" tabindex="-1">思考题 <a class="header-anchor" href="#思考题" aria-label="Permalink to &quot;思考题&quot;">​</a></h2><p>这节课的示例非常原型化，代码还有很多可以改进的地方，请你思考一下并指出一两处。欢迎你把你的想法分享到评论区，也欢迎你把这节课的内容分享给需要的朋友，邀他一起学习 Rust，我们下节课再见！</p>`,109)]))}const b=n(o,[["render",r]]);export{d as __pageData,b as default};
