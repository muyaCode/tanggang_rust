<!DOCTYPE html>
<html lang="zh" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>30 ｜ Unsafe 编程（下）：使用 Rust 为 Python 写一个扩展 | 唐刚-Rust语言从入门到实战</title>
    <meta name="description" content="Rust语言从入门到实战">
    <meta name="generator" content="VitePress v1.6.3">
    <link rel="preload stylesheet" href="/tanggang_rust/assets/style.Dmb1gw5t.css" as="style">
    <link rel="preload stylesheet" href="/tanggang_rust/vp-icons.css" as="style">
    
    <script type="module" src="/tanggang_rust/assets/app.DakBAcEX.js"></script>
    <link rel="preload" href="/tanggang_rust/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/tanggang_rust/assets/chunks/theme.BYwnybAk.js">
    <link rel="modulepreload" href="/tanggang_rust/assets/chunks/framework.D2WelYEY.js">
    <link rel="modulepreload" href="/tanggang_rust/assets/Document_30｜Unsafe编程（下）：使用Rust为Python写一个扩展.md.tPXz85a6.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-5d98c3a5><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0b0ada53></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0b0ada53>Skip to content</a><!--]--><!----><header class="VPNav" data-v-5d98c3a5 data-v-ae24b3ad><div class="VPNavBar" data-v-ae24b3ad data-v-6aa21345><div class="wrapper" data-v-6aa21345><div class="container" data-v-6aa21345><div class="title" data-v-6aa21345><div class="VPNavBarTitle has-sidebar" data-v-6aa21345 data-v-1168a8e4><a class="title" href="/tanggang_rust/" data-v-1168a8e4><!--[--><!--]--><!--[--><img class="VPImage logo" src="/tanggang_rust/img/buding.svg" alt data-v-8426fc1a><!--]--><span data-v-1168a8e4>Rust语言从入门到实战</span><!--[--><!--]--></a></div></div><div class="content" data-v-6aa21345><div class="content-body" data-v-6aa21345><!--[--><!--]--><div class="VPNavBarSearch search" data-v-6aa21345><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索文档"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">搜索文档</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><!----><!----><div class="VPNavBarAppearance appearance" data-v-6aa21345 data-v-6c893767><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-6c893767 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div><!----><div class="VPFlyout VPNavBarExtra extra" data-v-6aa21345 data-v-bb2aa2f0 data-v-cf11d7a2><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-cf11d7a2><span class="vpi-more-horizontal icon" data-v-cf11d7a2></span></button><div class="menu" data-v-cf11d7a2><div class="VPMenu" data-v-cf11d7a2 data-v-b98bc113><!----><!--[--><!--[--><!----><div class="group" data-v-bb2aa2f0><div class="item appearance" data-v-bb2aa2f0><p class="label" data-v-bb2aa2f0>Appearance</p><div class="appearance-action" data-v-bb2aa2f0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-bb2aa2f0 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div></div></div><!----><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-6aa21345 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-6aa21345><div class="divider-line" data-v-6aa21345></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-5d98c3a5 data-v-a6f0e41e><div class="container" data-v-a6f0e41e><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-a6f0e41e><span class="vpi-align-left menu-icon" data-v-a6f0e41e></span><span class="menu-text" data-v-a6f0e41e>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-a6f0e41e data-v-8a42e2b4><button data-v-8a42e2b4>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-5d98c3a5 data-v-319d5ca6><div class="curtain" data-v-319d5ca6></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-319d5ca6><span class="visually-hidden" id="sidebar-aria-label" data-v-319d5ca6> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-c40bc020><section class="VPSidebarItem level-0 has-active" data-v-c40bc020 data-v-b3fd67f8><!----><div class="items" data-v-b3fd67f8><!--[--><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/00%EF%BD%9C%E5%BC%80%E7%AF%87%E8%AF%8D%EF%BD%9C%E6%8B%A5%E6%8A%B1Rust%E6%B5%AA%E6%BD%AE%EF%BC%8C%E8%BF%8E%E6%8E%A5%E6%9B%B4%E6%9E%81%E8%87%B4%E7%9A%84%E7%BC%96%E7%A8%8B%E4%BD%93%E9%AA%8C" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>00｜开篇词｜拥抱Rust浪潮，迎接更极致的编程体验</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/01%EF%BD%9C%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%EF%BC%9ARust%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9B%E4%BD%A0%E4%B8%8D%E5%BE%97%E4%B8%8D%E4%BA%86%E8%A7%A3%E7%9A%84%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>01｜快速入门：Rust中有哪些你不得不了解的基础语法？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/02%EF%BD%9C%E6%89%80%E6%9C%89%E6%9D%83%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9ARust%E6%98%AF%E5%A6%82%E4%BD%95%E7%AE%A1%E7%90%86%E7%A8%8B%E5%BA%8F%E4%B8%AD%E7%9A%84%E8%B5%84%E6%BA%90%E7%9A%84%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>02｜所有权（上）：Rust是如何管理程序中的资源的？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/03%EF%BD%9C%E6%89%80%E6%9C%89%E6%9D%83%EF%BC%88%E4%B8%8B%EF%BC%89%EF%BC%9ARust%E4%B8%AD%E5%80%9F%E7%94%A8%E4%B8%8E%E5%BC%95%E7%94%A8%E7%9A%84%E8%A7%84%E5%88%99%E6%98%AF%E6%80%8E%E6%A0%B7%E7%9A%84%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>03｜所有权（下）：Rust中借用与引用的规则是怎样的？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/04%EF%BD%9C%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%9A%E5%AF%B9%E5%8F%B7%E5%85%A5%E5%BA%A7%EF%BC%8C%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%85%B6%E5%AE%9E%E6%B2%A1%E9%82%A3%E4%B9%88%E5%8F%AF%E6%80%95%EF%BC%81" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>04｜字符串：对号入座，字符串其实没那么可怕！</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/05%EF%BD%9C%E5%A4%8D%E5%90%88%E7%B1%BB%E5%9E%8B%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9A%E7%BB%93%E6%9E%84%E4%BD%93%E4%B8%8E%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%89%B9%E6%80%A7" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>05｜复合类型（上）：结构体与面向对象特性</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/06%EF%BD%9C%E5%A4%8D%E5%90%88%E7%B1%BB%E5%9E%8B%EF%BC%88%E4%B8%8B%EF%BC%89%EF%BC%9A%E6%9E%9A%E4%B8%BE%E4%B8%8E%E6%A8%A1%E5%BC%8F%E5%8C%B9%E9%85%8D" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>06｜复合类型（下）：枚举与模式匹配</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/07%EF%BD%9C%E7%B1%BB%E5%9E%8B%E4%B8%8E%E7%B1%BB%E5%9E%8B%E5%8F%82%E6%95%B0%EF%BC%9A%E7%BB%99Rust%E5%B0%8F%E5%8A%A9%E6%89%8B%E6%8F%90%E4%BE%9B%E6%9B%B4%E5%A4%9A%E4%BF%A1%E6%81%AF" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>07｜类型与类型参数：给Rust小助手提供更多信息</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/08%EF%BD%9COption-T-%E4%B8%8EResult-T,E-%E3%80%81%E8%BF%AD%E4%BB%A3%E5%99%A8" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>08｜Option-T-与Result-T,E-、迭代器</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/09%EF%BD%9C%E5%88%9D%E8%AF%86trait%EF%BC%9A%E5%8D%8F%E8%AE%AE%E7%BA%A6%E6%9D%9F%E4%B8%8E%E8%83%BD%E5%8A%9B%E9%85%8D%E7%BD%AE" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>09｜初识trait：协议约束与能力配置</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/10%EF%BD%9C%E5%86%8D%E6%8E%A2trait%EF%BC%9A%E5%B8%A6%E7%B1%BB%E5%9E%8B%E5%8F%82%E6%95%B0%E7%9A%84trait%E5%8F%8Atraitobject" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>10｜再探trait：带类型参数的trait及traitobject</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/11%EF%BD%9C%E5%B8%B8%E8%A7%81trait%E8%A7%A3%E6%9E%90%EF%BC%9A%E6%A0%87%E5%87%86%E5%BA%93%E4%B8%AD%E7%9A%84%E5%B8%B8%E8%A7%81trait%E5%BA%94%E8%AF%A5%E6%80%8E%E4%B9%88%E7%94%A8%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>11｜常见trait解析：标准库中的常见trait应该怎么用？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/%E7%AD%94%E7%96%91%E8%AF%BE%E5%A0%82%EF%BC%88%E4%B8%80%EF%BC%89%EF%BD%9C%E7%AC%AC%E4%B8%80%E7%AB%A0Rust%E5%9F%BA%E7%A1%80%E7%AF%87%E6%80%9D%E8%80%83%E9%A2%98%E7%AD%94%E6%A1%88" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>答疑课堂（一）｜第一章Rust基础篇思考题答案</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/12%EF%BD%9C%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88%EF%BC%9A%E4%BB%8E%E6%89%80%E6%9C%89%E6%9D%83%E7%9C%8B%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>12｜智能指针：从所有权看智能指针</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/13%EF%BD%9C%E7%8B%AC%E7%AB%8B%E7%8E%8B%E5%9B%BD%EF%BC%9A%E5%88%9D%E6%AD%A5%E4%BA%86%E8%A7%A3Rust%E5%BC%82%E6%AD%A5%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>13｜独立王国：初步了解Rust异步并发编程</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/14%EF%BD%9Ctokio%E5%AE%9E%E6%88%98%EF%BC%9A%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E7%BD%91%E7%BB%9C%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%A8%8B%E5%BA%8F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>14｜tokio实战：编写一个网络命令行程序</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/15%EF%BD%9Ctokio%E7%BC%96%E7%A8%8B%EF%BC%9A%E5%9C%A8%E5%A4%9A%E4%BB%BB%E5%8A%A1%E4%B9%8B%E9%97%B4%E6%93%8D%E4%BD%9C%E5%90%8C%E4%B8%80%E7%89%87%E6%95%B0%E6%8D%AE" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>15｜tokio编程：在多任务之间操作同一片数据</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/16%EF%BD%9Ctokio%E7%BC%96%E7%A8%8B%EF%BC%9A%E4%BD%BF%E7%94%A8channel%E5%9C%A8%E4%B8%8D%E5%90%8C%E4%BB%BB%E5%8A%A1%E9%97%B4%E9%80%9A%E4%BF%A1%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>16｜tokio编程：使用channel在不同任务间通信？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/17%EF%BD%9Ctokio%E7%BC%96%E7%A8%8B%EF%BC%9ARust%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E8%BF%98%E6%9C%89%E5%93%AA%E4%BA%9B%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E7%82%B9%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>17｜tokio编程：Rust异步编程还有哪些需要注意的点？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/18%EF%BD%9C%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E7%B3%BB%E7%BB%9F%EF%BC%9A%E9%94%99%E8%AF%AF%E7%9A%84%E6%9E%84%E5%BB%BA%E3%80%81%E4%BC%A0%E9%80%92%E5%92%8C%E5%A4%84%E7%90%86" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>18｜错误处理系统：错误的构建、传递和处理</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/19%EF%BD%9CRust%E7%9A%84%E5%AE%8F%E4%BD%93%E7%B3%BB%EF%BC%9A%E4%B8%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E9%A1%B9%E7%9B%AE%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E5%A3%B0%E6%98%8E%E5%AE%8F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>19｜Rust的宏体系：为自己的项目写一个简单的声明宏</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/20%EF%BD%9C%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%EF%BC%9ARust%E5%A6%82%E4%BD%95%E5%81%9A%E5%9F%BA%E6%9C%AC%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AC%A6%E5%8F%B7%E6%A0%87%E6%B3%A8%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>20｜生命周期：Rust如何做基本的生命周期符号标注？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/%E7%AD%94%E7%96%91%E8%AF%BE%E5%A0%82%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BD%9C%E7%AC%AC%E4%BA%8C%E7%AB%A0Rust%E8%BF%9B%E9%98%B6%E7%AF%87%E6%80%9D%E8%80%83%E9%A2%98%E7%AD%94%E6%A1%88" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>答疑课堂（二）｜第二章Rust进阶篇思考题答案</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/21%EF%BD%9CWeb%E5%BC%80%E5%8F%91%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9A%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8Axum%E6%A1%86%E6%9E%B6%E8%BF%9B%E8%A1%8CWeb%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>21｜Web开发（上）：如何使用Axum框架进行Web后端开发？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/22%EF%BD%9CWeb%E5%BC%80%E5%8F%91%EF%BC%88%E4%B8%8B%EF%BC%89%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AATodoList%E5%BA%94%E7%94%A8%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>22｜Web开发（下）：如何实现一个TodoList应用？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/23%EF%BD%9CRust%E4%B8%8E%E5%A4%A7%E6%A8%A1%E5%9E%8B%EF%BC%9A%E7%94%A8Candle%E5%81%9A%E4%B8%80%E4%B8%AA%E8%81%8A%E5%A4%A9%E6%9C%BA%E5%99%A8%E4%BA%BA" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>23｜Rust与大模型：用Candle做一个聊天机器人</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/24%EF%BD%9CRust%E5%9B%BE%E5%83%8F%E8%AF%86%E5%88%AB%EF%BC%9A%E5%88%A9%E7%94%A8YOLOv8%E8%AF%86%E5%88%AB%E5%AF%B9%E8%B1%A1" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>24｜Rust图像识别：利用YOLOv8识别对象</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/25%EF%BD%9CRustGUI%E7%BC%96%E7%A8%8B%EF%BC%9A%E7%94%A8Slint%E4%B8%BAChatbot%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%95%8C%E9%9D%A2" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>25｜RustGUI编程：用Slint为Chatbot实现一个界面</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/26%EF%BD%9CRustGUI%E7%BC%96%E7%A8%8B%EF%BC%9A%E7%94%A8Slint%E4%B8%BAYOLOv8%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%95%8C%E9%9D%A2" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>26｜RustGUI编程：用Slint为YOLOv8实现一个界面</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/27%EF%BD%9CRustBevy%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%EF%BC%9A%E7%94%A8300%E8%A1%8C%E4%BB%A3%E7%A0%81%E5%81%9A%E4%B8%80%E4%B8%AA%E8%B4%AA%E5%90%83%E8%9B%87%E6%B8%B8%E6%88%8F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>27｜RustBevy游戏开发：用300行代码做一个贪吃蛇游戏</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/28%EF%BD%9CNom%EF%BC%9A%E7%94%A8Rust%E5%86%99%E4%B8%80%E4%B8%AAParser%E8%A7%A3%E6%9E%90%E5%99%A8" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>28｜Nom：用Rust写一个Parser解析器</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/29%EF%BD%9CUnsafe%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9AUnsafeRust%E4%B8%AD%E9%82%A3%E4%BA%9B%E8%A2%AB%E5%B0%81%E5%8D%B0%E7%9A%84%E8%83%BD%E5%8A%9B" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>29｜Unsafe编程（上）：UnsafeRust中那些被封印的能力</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/30%EF%BD%9CUnsafe%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%8B%EF%BC%89%EF%BC%9A%E4%BD%BF%E7%94%A8Rust%E4%B8%BAPython%E5%86%99%E4%B8%80%E4%B8%AA%E6%89%A9%E5%B1%95" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>30｜Unsafe编程（下）：使用Rust为Python写一个扩展</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/%E7%AD%94%E7%96%91%E8%AF%BE%E5%A0%82%EF%BC%88%E4%B8%89%EF%BC%89%EF%BD%9C%E7%AC%AC%E4%B8%89%E7%AB%A0Rust%E5%BA%94%E7%94%A8%E7%AF%87%E6%80%9D%E8%80%83%E9%A2%98%E7%AD%94%E6%A1%88" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>答疑课堂（三）｜第三章Rust应用篇思考题答案</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/%E7%BB%93%E8%AF%BE%E6%B5%8B%E8%AF%95%EF%BD%9C%E6%9D%A5%E8%B5%B4%E4%B8%80%E5%9C%BA%E6%BB%A1%E5%88%86%E4%B9%8B%E7%BA%A6" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>结课测试｜来赴一场满分之约</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/%E7%BB%93%E6%9D%9F%E8%AF%AD%EF%BD%9C%E6%9C%AA%E6%9D%A5%E8%AE%A9Rust%E5%B8%A6%E4%BD%A0%E2%80%9C%E9%94%88%E2%80%9D%E5%88%B0%E8%B5%B7%E9%A3%9E" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>结束语｜未来让Rust带你“锈”到起飞</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-5d98c3a5 data-v-1428d186><div class="VPDoc has-sidebar has-aside" data-v-1428d186 data-v-39a288b8><!--[--><!--]--><div class="container" data-v-39a288b8><div class="aside" data-v-39a288b8><div class="aside-curtain" data-v-39a288b8></div><div class="aside-container" data-v-39a288b8><div class="aside-content" data-v-39a288b8><div class="VPDocAside" data-v-39a288b8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-3f215769 data-v-a5bbad30><div class="content" data-v-a5bbad30><div class="outline-marker" data-v-a5bbad30></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-a5bbad30>⚡️文档内容大纲</div><ul class="VPDocOutlineItem root" data-v-a5bbad30 data-v-b933a997><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-39a288b8><div class="content-container" data-v-39a288b8><!--[--><!--]--><main class="main" data-v-39a288b8><div style="position:relative;" class="vp-doc _tanggang_rust_Document_30%EF%BD%9CUnsafe%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%8B%EF%BC%89%EF%BC%9A%E4%BD%BF%E7%94%A8Rust%E4%B8%BAPython%E5%86%99%E4%B8%80%E4%B8%AA%E6%89%A9%E5%B1%95" data-v-39a288b8><div><h1 id="_30-unsafe-编程-下-使用-rust-为-python-写一个扩展" tabindex="-1">30 ｜ Unsafe 编程（下）：使用 Rust 为 Python 写一个扩展 <a class="header-anchor" href="#_30-unsafe-编程-下-使用-rust-为-python-写一个扩展" aria-label="Permalink to &quot;30 ｜ Unsafe 编程（下）：使用 Rust 为 Python 写一个扩展&quot;">​</a></h1><p>你好，我是 Mike。</p><p>上一讲我们了解了 Unsafe Rust 的所属定位和基本性质，这一讲我们就来看看 Rust FFI 编程到底是怎样一种形式。</p><p>FFI 是与外部语言进行交互的接口，在 Safe Rust 看来，它是不可信的，也就是说 Rust 编译不能保证它是安全的，只能由程序员自己来保证，因此在 Rust 里调用这些外部的代码功能就需要把它们包在 <code>unsafe {}</code> 中。</p><p>Rust 和 C 有血缘关系，具有 ABI 上的一致性，所以 <strong>Rust 和 C 之间可以实现双向互调，并且不会损失性能。</strong></p><h2 id="rust-调用-c" tabindex="-1">Rust 调用 C <a class="header-anchor" href="#rust-调用-c" aria-label="Permalink to &quot;Rust 调用 C&quot;">​</a></h2><p>我们先来看在 Rust 中如何调用 C 库的代码。</p><p>一般各个平台下都有 libm 库，它是操作系统基本的数学 math 库。下面我们以 Linux 为例来说明。下面的示例代码来自 <a href="https://doc.rust-lang.org/rust-by-example/std_misc/ffi.html" target="_blank" rel="noreferrer">Rust By Example</a>。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> std</span><span style="color:#ABB2BF;">::fmt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 连接到系统的 libm 库</span></span>
<span class="line"><span style="color:#ABB2BF;">#[link(name </span><span style="color:#56B6C2;">=</span><span style="color:#98C379;"> &quot;m&quot;</span><span style="color:#ABB2BF;">)]</span></span>
<span class="line"><span style="color:#C678DD;">extern</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 这是一个外部函数，计算单精度复数的方根</span></span>
<span class="line"><span style="color:#C678DD;">    fn</span><span style="color:#61AFEF;"> csqrtf</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">z</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Complex</span><span style="color:#ABB2BF;">) -&gt; </span><span style="color:#E5C07B;">Complex</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 计算复数的余弦值</span></span>
<span class="line"><span style="color:#C678DD;">    fn</span><span style="color:#61AFEF;"> ccosf</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">z</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Complex</span><span style="color:#ABB2BF;">) -&gt; </span><span style="color:#E5C07B;">Complex</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 对unsafe调用的safe封装，从此以后，就按safe函数方式使用这个接口</span></span>
<span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> cos</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">z</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Complex</span><span style="color:#ABB2BF;">) -&gt; </span><span style="color:#E5C07B;">Complex</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">    unsafe</span><span style="color:#ABB2BF;"> { </span><span style="color:#61AFEF;">ccosf</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">z</span><span style="color:#ABB2BF;">) }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // z = -1 + 0i</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> z</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> Complex</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">re</span><span style="color:#ABB2BF;">: -</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">., </span><span style="color:#E06C75;">im</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">. };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 调用m库中的函数，需要用 unsafe {} 包起来</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> z_sqrt</span><span style="color:#56B6C2;"> =</span><span style="color:#C678DD;"> unsafe</span><span style="color:#ABB2BF;"> { </span><span style="color:#61AFEF;">csqrtf</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">z</span><span style="color:#ABB2BF;">) };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">    println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;the square root of {:?} is {:?}&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">z</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">z_sqrt</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 调用安全封装后的函数</span></span>
<span class="line"><span style="color:#61AFEF;">    println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;cos({:?}) = {:?}&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">z</span><span style="color:#ABB2BF;">, </span><span style="color:#61AFEF;">cos</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">z</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 用 repr(C) 标注，定义Rust结构体的ABI格式，按C的ABI来</span></span>
<span class="line"><span style="color:#ABB2BF;">#[repr(</span><span style="color:#E5C07B;">C</span><span style="color:#ABB2BF;">)]</span></span>
<span class="line"><span style="color:#ABB2BF;">#[derive(</span><span style="color:#E5C07B;">Clone</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">Copy</span><span style="color:#ABB2BF;">)]</span></span>
<span class="line"><span style="color:#C678DD;">struct</span><span style="color:#E5C07B;"> Complex</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">    re</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">f32</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">    im</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">f32</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 实现复数的打印输出</span></span>
<span class="line"><span style="color:#C678DD;">impl</span><span style="color:#E5C07B;"> fmt</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">Debug</span><span style="color:#C678DD;"> for</span><span style="color:#E5C07B;"> Complex</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">    fn</span><span style="color:#61AFEF;"> fmt</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#E5C07B;">self</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">f</span><span style="color:#ABB2BF;">: &amp;</span><span style="color:#C678DD;">mut</span><span style="color:#E5C07B;"> fmt</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">Formatter</span><span style="color:#ABB2BF;">) -&gt; </span><span style="color:#E5C07B;">fmt</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E5C07B;"> self</span><span style="color:#ABB2BF;">.im </span><span style="color:#56B6C2;">&lt;</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">. {</span></span>
<span class="line"><span style="color:#61AFEF;">            write!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">f</span><span style="color:#ABB2BF;">, </span><span style="color:#98C379;">&quot;{}-{}i&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">self</span><span style="color:#ABB2BF;">.re, -</span><span style="color:#E5C07B;">self</span><span style="color:#ABB2BF;">.im)</span></span>
<span class="line"><span style="color:#ABB2BF;">        } </span><span style="color:#C678DD;">else</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#61AFEF;">            write!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">f</span><span style="color:#ABB2BF;">, </span><span style="color:#98C379;">&quot;{}+{}i&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">self</span><span style="color:#ABB2BF;">.re, </span><span style="color:#E5C07B;">self</span><span style="color:#ABB2BF;">.im)</span></span>
<span class="line"><span style="color:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>libm 库是用 C 语言实现的，我们要调用它，需要用这样的标注。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">#[link(name </span><span style="color:#56B6C2;">=</span><span style="color:#98C379;"> &quot;m&quot;</span><span style="color:#ABB2BF;">)]</span></span>
<span class="line"><span style="color:#C678DD;">extern</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>用 lnk 属性宏将 libm 库连接进来，以便去里面找对应的函数。然后把需要的外部函数导入进来。你可以看一下 <code>csqrtf()</code> 函数和 <code>ccosf()</code> 的 C 语言签名。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">float</span><span style="color:#E06C75;"> complex</span><span style="color:#61AFEF;"> csqrtf</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">float</span><span style="color:#E06C75;"> complex</span><span style="color:#E06C75;"> z</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E06C75;">float</span><span style="color:#E06C75;"> complex</span><span style="color:#E06C75;"> ccosf</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;">float</span><span style="color:#E06C75;"> complex</span><span style="color:#E06C75;"> z</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>导入的时候，要翻译成 Rust 函数的签名形式。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> csqrtf</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">z</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Complex</span><span style="color:#ABB2BF;">) -&gt; </span><span style="color:#E5C07B;">Complex</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> ccosf</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">z</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Complex</span><span style="color:#ABB2BF;">) -&gt; </span><span style="color:#E5C07B;">Complex</span><span style="color:#ABB2BF;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>调用这两个函数的时候，都需要用 <code>unsafe {}</code> 包起来。</p><p>然后我们仔细看一下在 Rust 中对应到 libm 中的复数的定义。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">#[repr(</span><span style="color:#E5C07B;">C</span><span style="color:#ABB2BF;">)]</span></span>
<span class="line"><span style="color:#ABB2BF;">#[derive(</span><span style="color:#E5C07B;">Clone</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">Copy</span><span style="color:#ABB2BF;">)]</span></span>
<span class="line"><span style="color:#C678DD;">struct</span><span style="color:#E5C07B;"> Complex</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">    re</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">f32</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;">    im</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">f32</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>对应的 C 语言中的结构定义在 <a href="https://en.cppreference.com/w/c/numeric/complex" target="_blank" rel="noreferrer">complex.h 头文件</a> 中，它是 C99 标准引入的数据类型。</p><p>本身这个定义非常简单，就是定义复数的实部和虚部就可以了，不过一定要用 <code>#[repr(C)]</code> 标注。它的意思是这个类型编译的时候，要使用 C 语言的 ABI 格式。我们一般都使用 C 语言 ABI 格式，但是也有一些其他的 ABI 格式，你可以点击我给出的 <a href="https://doc.rust-lang.org/nomicon/ffi.html#foreign-calling-conventions" target="_blank" rel="noreferrer">链接</a>，查到 Rust 中支持的 ABI 格式列表。</p><p>一般来讲，我们会使用 Rust 函数对这些外部 unsafe 函数做一下封装。像 cos 函数这样，你可以参看一下示例代码。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> cos</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">z</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Complex</span><span style="color:#ABB2BF;">) -&gt; </span><span style="color:#E5C07B;">Complex</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">    unsafe</span><span style="color:#ABB2BF;"> { </span><span style="color:#61AFEF;">ccosf</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">z</span><span style="color:#ABB2BF;">) }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>执行 <code>cargo run</code>，输出了下面这两行代码。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">the</span><span style="color:#E06C75;"> square</span><span style="color:#E06C75;"> root</span><span style="color:#E06C75;"> of</span><span style="color:#ABB2BF;"> -</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">+</span><span style="color:#E06C75;">0i</span><span style="color:#E06C75;"> is</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">+</span><span style="color:#E06C75;">1i</span></span>
<span class="line"><span style="color:#61AFEF;">cos</span><span style="color:#ABB2BF;">(-</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">+</span><span style="color:#E06C75;">0i</span><span style="color:#ABB2BF;">) </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 0.5403023</span><span style="color:#ABB2BF;">+</span><span style="color:#E06C75;">0i</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>注：项目代码链接 <a href="https://github.com/miketang84/jikeshijian/tree/master/30-ffi/rust_call_c" target="_blank" rel="noreferrer">https://github.com/miketang84/jikeshijian/tree/master/30-ffi/rust_call_c</a></p><h3 id="bindgen" tabindex="-1">bindgen <a class="header-anchor" href="#bindgen" aria-label="Permalink to &quot;bindgen&quot;">​</a></h3><p>Rust 官方出了一个 <a href="https://github.com/rust-lang/rust-bindgen" target="_blank" rel="noreferrer">bindgen</a> 项目，可以帮助我们快速从 C 库的头文件生成 Rust FFI 绑定层代码。之所以能这样做，是因为我们发现，C 的接口转换成 Rust 的接口形式是非常固定的，转换的过程需要写大量的样板代码，所以就可以用 bindgen 这种工具自动转换。</p><p>比如某个 C 头文件里定义了这样的类型和函数：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">typedef</span><span style="color:#C678DD;"> struct</span><span style="color:#E5C07B;"> Doggo</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">    int</span><span style="color:#E06C75;"> many</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;">    char</span><span style="color:#E06C75;"> wow</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">} </span><span style="color:#E5C07B;">Doggo</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;">void</span><span style="color:#61AFEF;"> eleven_out_of_ten_majestic_af</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Doggo</span><span style="color:#ABB2BF;">* </span><span style="color:#E06C75;">pupper</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>使用 bindgen 自动生成 FFI 绑定后，可以生成类似这样的代码：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">/* automatically generated by rust-bindgen 0.99.9 */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">#[repr(</span><span style="color:#E5C07B;">C</span><span style="color:#ABB2BF;">)]</span></span>
<span class="line"><span style="color:#C678DD;">pub</span><span style="color:#C678DD;"> struct</span><span style="color:#E5C07B;"> Doggo</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">    pub</span><span style="color:#E06C75;"> many</span><span style="color:#ABB2BF;">: ::</span><span style="color:#E5C07B;">std</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">os</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">raw</span><span style="color:#ABB2BF;">::</span><span style="color:#E06C75;">c_int</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#C678DD;">    pub</span><span style="color:#E06C75;"> wow</span><span style="color:#ABB2BF;">: ::</span><span style="color:#E5C07B;">std</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">os</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">raw</span><span style="color:#ABB2BF;">::</span><span style="color:#E06C75;">c_char</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">extern</span><span style="color:#98C379;"> &quot;C&quot;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">    pub</span><span style="color:#C678DD;"> fn</span><span style="color:#61AFEF;"> eleven_out_of_ten_majestic_af</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">pupper</span><span style="color:#ABB2BF;">: *</span><span style="color:#C678DD;">mut</span><span style="color:#E5C07B;"> Doggo</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>你可能发现了，Rust 里有一批类型，以 c_ 前缀开头。比如 C 语言的 int 类型，对应 std 中的类型你可以通过我给出的 <a href="https://doc.rust-lang.org/std/ffi/type.c_int.html" target="_blank" rel="noreferrer">链接</a> 找到。</p><p>这些就是 Rust 里定义的与 C 完全相同的类型。我们可以看一下 <a href="https://doc.rust-lang.org/std/ffi/type.c_char.html" target="_blank" rel="noreferrer">c_char</a> 的定义。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">pub</span><span style="color:#C678DD;"> type</span><span style="color:#E06C75;"> c_char</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> i8</span><span style="color:#ABB2BF;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>竟然直接是一个 i8。因为 C 语言里的 char 就是一个普通字节，和 Rust 里的 char 完全不同。这是在 Rust 中完全兼容 C 必要的一步，就是 <strong>把 C 中的类型全部映射过来，并加上 c_ 前缀</strong>。这样单独搞一批类型就是因为有的类型没办法直接映射到 Rust 的 char 上来，比如刚刚说的这个 c_char。</p><p>典型的，还有 C 语言中的 void 类型，它在 Rust 里没有对应物，所以就映射成了 <a href="https://doc.rust-lang.org/std/ffi/enum.c_void.html" target="_blank" rel="noreferrer">c_void</a>，在 Rust 中定义成了一个 enum。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">#[repr(</span><span style="color:#E5C07B;">u8</span><span style="color:#ABB2BF;">)]</span></span>
<span class="line"><span style="color:#C678DD;">pub</span><span style="color:#C678DD;"> enum</span><span style="color:#E06C75;"> c_void</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // some variants omitted</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>下面我们继续看，反过来，在 C 中如何调用 Rust 代码。</p><h2 id="c-调用-rust" tabindex="-1">C 调用 Rust <a class="header-anchor" href="#c-调用-rust" aria-label="Permalink to &quot;C 调用 Rust&quot;">​</a></h2><p>在 C 中调用 Rust 代码的基本思路是，Rust 代码编译成 <code>.so</code> 或 <code>.dll</code> 动态链接库，在 C 语言里面编译的时候，连接就可以了。</p><p>在 lib.rs 文件中，写这样一个函数：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">#[no_mangle]</span></span>
<span class="line"><span style="color:#C678DD;">pub</span><span style="color:#C678DD;"> extern</span><span style="color:#98C379;"> &quot;C&quot;</span><span style="color:#C678DD;"> fn</span><span style="color:#61AFEF;"> hello_from_rust</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#61AFEF;">    println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;Hello from Rust!&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>注意属性宏 <code>#[no_mangle]</code>，在 Rust 中，no_mangle 用于告诉 Rust 编译器不要修改函数的名称，这种修改叫做 Mangling，它是编译器在解析名称时，修改我们定义的函数名称，增加一些用于其编译过程的额外信息。但在和其他语言交互时，如果函数名称被编译器修改，程序开发者就没办法知道修改后的函数名称了，其他语言也无法按原名称调用。因此，#[no_mangle] 在这种场景下就非常有用了。</p><p>Cargo.toml 要加个配置，表示编译的这个库是 C ABI 格式的动态链接库。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">[</span><span style="color:#E06C75;">lib</span><span style="color:#ABB2BF;">]</span></span>
<span class="line"><span style="color:#C678DD;">crate</span><span style="color:#ABB2BF;">-</span><span style="color:#C678DD;">type</span><span style="color:#56B6C2;"> =</span><span style="color:#ABB2BF;"> [</span><span style="color:#98C379;">&quot;cdylib&quot;</span><span style="color:#ABB2BF;">]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>然后用 <code>cargo build</code> 编译输出。你可以在 target/debug 目录下面看到你的 <code>.so</code> 库文件，比如下面这个样子：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">$ </span><span style="color:#E06C75;">ls</span><span style="color:#E06C75;"> target</span><span style="color:#ABB2BF;">/</span><span style="color:#E06C75;">debug</span><span style="color:#ABB2BF;">/</span></span>
<span class="line"><span style="color:#E06C75;">build</span><span style="color:#E06C75;">  deps</span><span style="color:#E06C75;">  examples</span><span style="color:#E06C75;">  incremental</span><span style="color:#E06C75;">  libc_call_rust</span><span style="color:#ABB2BF;">.d  </span><span style="color:#E06C75;">libc_call_rust</span><span style="color:#ABB2BF;">.so</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这里这个 libc_call_rust.so 就是我们的动态链接库，其中 <code>c_call_rust</code> 是我们这个 crate 的名字。</p><p>下面是 C 的部分，代码如下：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">extern</span><span style="color:#E06C75;"> void</span><span style="color:#61AFEF;"> hello_from_rust</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;">int</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">void</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#61AFEF;">    hello_from_rust</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>存成 call_rust.c 文件。用下面这种形式编译：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">gcc</span><span style="color:#E06C75;"> call_rust</span><span style="color:#ABB2BF;">.c -</span><span style="color:#E06C75;">o</span><span style="color:#E06C75;"> call_rust</span><span style="color:#ABB2BF;"> -</span><span style="color:#E06C75;">lc_call_rust</span><span style="color:#ABB2BF;"> -</span><span style="color:#E5C07B;">L</span><span style="color:#ABB2BF;">./</span><span style="color:#E06C75;">target</span><span style="color:#ABB2BF;">/</span><span style="color:#E06C75;">debug</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>运行：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#D19A66;">LD_LIBRARY_PATH</span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;">./</span><span style="color:#E06C75;">target</span><span style="color:#ABB2BF;">/</span><span style="color:#E06C75;">debug</span><span style="color:#ABB2BF;"> ./</span><span style="color:#E06C75;">call_rust</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>你可以看到输出内容 <code>Hello from Rust!</code>。</p><p>注：完整可测试代码 <a href="https://github.com/miketang84/jikeshijian/tree/master/30-ffi/c_call_rust" target="_blank" rel="noreferrer">https://github.com/miketang84/jikeshijian/tree/master/30-ffi/c_call_rust</a></p><p>当然，这只是最简单的形式，万里长征我们刚踏出第一步，还有各种复杂的 FFI 场景等着你去探索。</p><h3 id="cbindgen" tabindex="-1">Cbindgen <a class="header-anchor" href="#cbindgen" aria-label="Permalink to &quot;Cbindgen&quot;">​</a></h3><p>在实际工作中，当你需要以 Rust 仓库为主，为其他语言导出 C 接口的时候，一般还需要生成 C 的头文件，这时，你应该会对 <a href="https://github.com/mozilla/cbindgen" target="_blank" rel="noreferrer">cbindgen</a> 项目很感兴趣，它也算半官方的（在 Mozilla 名下），它的作用与前面的 bindgen 刚好相反，是从 Rust 代码中生成 C 可以调用的代码签名。</p><p>Rust 与 C 的交互我们先讨论到这里，下面我们要研究一下如何用 Rust 给 Python 写扩展。</p><h2 id="使用-rust-给-python-写扩展" tabindex="-1">使用 Rust 给 Python 写扩展 <a class="header-anchor" href="#使用-rust-给-python-写扩展" aria-label="Permalink to &quot;使用 Rust 给 Python 写扩展&quot;">​</a></h2><p>标准的 Python 扩展是用 C/C++ 写的，Python 官方有 <a href="https://docs.python.org/3/extending/extending.html" target="_blank" rel="noreferrer">教程</a>，感兴趣的话你可以研究一下。我们这节课聚焦于如何用 Rust 给 Python 写扩展。</p><p>其实，只要你将 Rust 的代码扩展到 C 可以调用，那么再进一步，按 Python 官方教程那样，继续将 C 代码封装成 Python 扩展就可以了，下面我们讲的基本思路也是这样。</p><p>在实际实现的时候，我们会写非常多的样板代码，写起来比较痛苦。但是 Rust 社区有非常优秀的项目：PyO3，它可以帮助我们减轻这种烦恼，自动帮我们处理好中间样板封装过程。</p><h3 id="pyo3" tabindex="-1">PyO3 <a class="header-anchor" href="#pyo3" aria-label="Permalink to &quot;PyO3&quot;">​</a></h3><p>PyO3 是 Rust 社区里非常火的与 Python 绑定的框架，它不仅可以实现用 Rust 给 Python 写扩展，还能在 Rust 的二进制程序中直接执行 Python 代码。所以实际 PyO3 是一个双向绑定库。</p><p>PyO3 封装了底层 FFI 绑定的各种细节。这些细节其实不是那么简单，你可以想一下，如何将 Python 的 Class 正确映射到 Rust 中对应的类型，如何正确处理模块、函数、参数、返回值类型，这里面有各种细节，想想就头痛。</p><p>而 PyO3 把这一切都封装在了 Rust 属性宏里面。我们来看一个示例。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> num_bigint</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">BigUint</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> num_traits</span><span style="color:#ABB2BF;">::{</span><span style="color:#E5C07B;">One</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">Zero</span><span style="color:#ABB2BF;">};</span></span>
<span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> pyo3</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">prelude</span><span style="color:#ABB2BF;">::*;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// Calculate large fibonacci numbers.</span></span>
<span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> fib</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">n</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">usize</span><span style="color:#ABB2BF;">) -&gt; </span><span style="color:#E5C07B;">BigUint</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> f0</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">BigUint</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> Zero</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">zero</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> f1</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">BigUint</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> One</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">one</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> _</span><span style="color:#C678DD;"> in</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">..</span><span style="color:#E06C75;">n</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">        let</span><span style="color:#E06C75;"> f2</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> f0</span><span style="color:#ABB2BF;"> + &amp;</span><span style="color:#E06C75;">f1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        f0</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> f1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;">        f1</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> f2</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#E06C75;">    f0</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">#[pyfunction]</span></span>
<span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> calc_fib</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">n</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">usize</span><span style="color:#ABB2BF;">) -&gt; </span><span style="color:#E5C07B;">PyResult</span><span style="color:#ABB2BF;">&lt;()&gt; {</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> _</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> fib</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">n</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#E5C07B;">    Ok</span><span style="color:#ABB2BF;">(())</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">#[pymodule]</span></span>
<span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> rust_fib</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">_py</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Python</span><span style="color:#ABB2BF;">&lt;&#39;</span><span style="color:#E5C07B;">_</span><span style="color:#ABB2BF;">&gt;, </span><span style="color:#E06C75;">m</span><span style="color:#ABB2BF;">: &amp;</span><span style="color:#E5C07B;">PyModule</span><span style="color:#ABB2BF;">) -&gt; </span><span style="color:#E5C07B;">PyResult</span><span style="color:#ABB2BF;">&lt;()&gt; {</span></span>
<span class="line"><span style="color:#E06C75;">    m</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add_function</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">wrap_pyfunction!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">calc_fib</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">m</span><span style="color:#ABB2BF;">)?)?;</span></span>
<span class="line"><span style="color:#E5C07B;">    Ok</span><span style="color:#ABB2BF;">(())</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>这个示例的作用是计算斐波那契数列的第 N 项。当这个 N 值比较大的时候，斐波那契数是一个非常大的数，一个 u64 装不下，因此我们要使用大数类型。在 Rust 中，num-bigint 是一个常用的大数类型实现库。而在 Python 中，int 默认就支持大数。</p><p>代码中， <code>fib()</code> 函数是真正计算斐波那契数的函数，然后在 <code>calc_fib()</code> 中封装给了 Python 使用，请注意这个函数头上的 <code>#[pyfunction]</code> 标注，它表明这个函数会导出给 Python 使用，是一个函数。</p><p>而下面的 <code>rust_fib()</code> 函数，则是标准的样板代码，它表示创建一个 Python 的模块，这个模块的名字叫做 <code>rust_fib</code>，这个名字会在 Python 代码中以 <code>import rust_fib</code> 的形式导入。 <code>#[pymodule]</code> 就起这个自动转化的作用。这个函数中的 m 参数就表示模块实例， <code>m.add_function()</code> 将 <code>calc_fib()</code> 添加到这个模块中。所以我们这个 crate 库会被编译成一个共识库，并被导入为 Python 的一个模块。</p><p>你可以看一下 Cargo.toml 的新增配置。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">[</span><span style="color:#E06C75;">lib</span><span style="color:#ABB2BF;">]</span></span>
<span class="line"><span style="color:#E06C75;">name</span><span style="color:#56B6C2;"> =</span><span style="color:#98C379;"> &quot;rust_fib&quot;</span></span>
<span class="line"><span style="color:#C678DD;">crate</span><span style="color:#ABB2BF;">-</span><span style="color:#C678DD;">type</span><span style="color:#56B6C2;"> =</span><span style="color:#ABB2BF;"> [</span><span style="color:#98C379;">&quot;cdylib&quot;</span><span style="color:#ABB2BF;">]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在 Python 中这样调用：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">import</span><span style="color:#E06C75;"> rust_fib</span></span>
<span class="line"><span style="color:#E06C75;">rust_fib</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">calc_fib</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">2000000</span><span style="color:#ABB2BF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>注：完整的可运行代码 <a href="https://github.com/miketang84/jikeshijian/blob/master/30-ffi/bigint-pyo3" target="_blank" rel="noreferrer">https://github.com/miketang84/jikeshijian/blob/master/30-ffi/bigint-pyo3</a></p><p>这样 PyO3 项目的一个关键是，需要使用 maturin 这种构建工具。你可以下载代码后，按下面的脚本准备好虚拟环境，并在这个虚拟环境里安装好 maturin。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">$ </span><span style="color:#E06C75;">cd</span><span style="color:#E06C75;"> bigint</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">pyo3</span></span>
<span class="line"><span style="color:#ABB2BF;">$ </span><span style="color:#E06C75;">python</span><span style="color:#ABB2BF;"> -</span><span style="color:#E06C75;">m</span><span style="color:#E06C75;"> venv</span><span style="color:#ABB2BF;"> .env</span></span>
<span class="line"><span style="color:#ABB2BF;">$ </span><span style="color:#E06C75;">source</span><span style="color:#ABB2BF;"> .env/</span><span style="color:#E06C75;">bin</span><span style="color:#ABB2BF;">/</span><span style="color:#E06C75;">activate</span></span>
<span class="line"><span style="color:#ABB2BF;">$ </span><span style="color:#E06C75;">pip</span><span style="color:#E06C75;"> install</span><span style="color:#E06C75;"> maturin</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在项目目录下运行：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">maturin</span><span style="color:#E06C75;"> develop</span><span style="color:#ABB2BF;"> -</span><span style="color:#E06C75;">r</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>这个指令会编译 Rust 代码为 release 模式，并把编译后的文件安装到 Python module 库的目录组织里去。</p><p>然后运行：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">$ </span><span style="color:#E06C75;">time</span><span style="color:#E06C75;"> python</span><span style="color:#E06C75;"> fib_rust</span><span style="color:#ABB2BF;">.py</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;">real</span><span style="color:#E06C75;">    0m12</span><span style="color:#ABB2BF;">.452s</span></span>
<span class="line"><span style="color:#E06C75;">user</span><span style="color:#E06C75;">    0m12</span><span style="color:#ABB2BF;">.431s</span></span>
<span class="line"><span style="color:#E06C75;">sys</span><span style="color:#E06C75;">     0m0</span><span style="color:#ABB2BF;">.020s</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>我们对比一下纯 Python 版本运行的时间。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">$ </span><span style="color:#E06C75;">time</span><span style="color:#E06C75;"> python</span><span style="color:#E06C75;"> fib</span><span style="color:#ABB2BF;">.py</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;">real</span><span style="color:#E06C75;">    0m21</span><span style="color:#ABB2BF;">.730s</span></span>
<span class="line"><span style="color:#E06C75;">user</span><span style="color:#E06C75;">    0m21</span><span style="color:#ABB2BF;">.490s</span></span>
<span class="line"><span style="color:#E06C75;">sys</span><span style="color:#E06C75;">     0m0</span><span style="color:#ABB2BF;">.240s</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这是计算第 200 万项斐波那契数，可以看到用 Rust 实现的版本快将近一倍。</p><p>PyO3 给我们提供的编程界面非常清爽，只要你跟着操作一遍，很快就能用 Rust 给 Python 写扩展了。PyO3 的 <a href="https://pyo3.rs" target="_blank" rel="noreferrer">文档</a> 也写得非常好，上面有更全面的功能介绍，一定要读一读。</p><h3 id="性能优化示例-文本单词统计" tabindex="-1">性能优化示例：文本单词统计 <a class="header-anchor" href="#性能优化示例-文本单词统计" aria-label="Permalink to &quot;性能优化示例：文本单词统计&quot;">​</a></h3><p>Python 的 GIL（Global Interpreter Lock）是一个被人诟病的特性，它限制很多 Python 代码只能以单线程的形式来跑。因此也就大大限制了 Python 的性能。而 Rust 原生支持系统级多线程（thread）以及轻量级线程（tokio task 等），能够非常方便地充分压榨所有 CPU 核。既然我们可以使用 Rust 给 Python 写扩展，那一个点子就顺理成章冒出来了——可以使用 Rust 给 Python 写扩展实现并行计算。</p><p>下面我们就以官方的示例 word_count 来说明如何使用。这个程序要解决这样一个问题：统计出一个文本文件里，某一个单词出现的次数。这个文本文件是按换行符分隔成一行一行的，行与行之间互不干涉。因此可以采用按行分割的形式来并行化处理。</p><p>Rust 中有一个著名的并行化库 Rayon，可以将串行迭代器转换成一个并行化版本的迭代器，从而实现程序的并行化。下面我们来看代码：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> pyo3</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">prelude</span><span style="color:#ABB2BF;">::*;</span></span>
<span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> rayon</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">prelude</span><span style="color:#ABB2BF;">::*;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">/// 并行化版本的搜索功能实现</span></span>
<span class="line"><span style="color:#ABB2BF;">#[pyfunction]</span></span>
<span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> search</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">contents</span><span style="color:#ABB2BF;">: &amp;</span><span style="color:#E5C07B;">str</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">needle</span><span style="color:#ABB2BF;">: &amp;</span><span style="color:#E5C07B;">str</span><span style="color:#ABB2BF;">) -&gt; </span><span style="color:#E5C07B;">usize</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">    contents</span></span>
<span class="line"><span style="color:#ABB2BF;">        .</span><span style="color:#61AFEF;">par_lines</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">        .</span><span style="color:#61AFEF;">map</span><span style="color:#ABB2BF;">(</span><span style="color:#56B6C2;">|</span><span style="color:#E06C75;">line</span><span style="color:#56B6C2;">|</span><span style="color:#61AFEF;"> count_line</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">line</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">needle</span><span style="color:#ABB2BF;">))</span></span>
<span class="line"><span style="color:#ABB2BF;">        .</span><span style="color:#61AFEF;">sum</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">/// 将行按空格分割，统计目标单词数目</span></span>
<span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> count_line</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">line</span><span style="color:#ABB2BF;">: &amp;</span><span style="color:#E5C07B;">str</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">needle</span><span style="color:#ABB2BF;">: &amp;</span><span style="color:#E5C07B;">str</span><span style="color:#ABB2BF;">) -&gt; </span><span style="color:#E5C07B;">usize</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> total</span><span style="color:#56B6C2;"> =</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> word</span><span style="color:#C678DD;"> in</span><span style="color:#E06C75;"> line</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">split</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39; &#39;</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> word</span><span style="color:#56B6C2;"> ==</span><span style="color:#E06C75;"> needle</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">            total</span><span style="color:#56B6C2;"> +=</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#E06C75;">    total</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 导出到Python module</span></span>
<span class="line"><span style="color:#ABB2BF;">#[pymodule]</span></span>
<span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> word_count</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">_py</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Python</span><span style="color:#ABB2BF;">&lt;&#39;</span><span style="color:#E5C07B;">_</span><span style="color:#ABB2BF;">&gt;, </span><span style="color:#E06C75;">m</span><span style="color:#ABB2BF;">: &amp;</span><span style="color:#E5C07B;">PyModule</span><span style="color:#ABB2BF;">) -&gt; </span><span style="color:#E5C07B;">PyResult</span><span style="color:#ABB2BF;">&lt;()&gt; {</span></span>
<span class="line"><span style="color:#E06C75;">    m</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">add_function</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">wrap_pyfunction!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">search</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">m</span><span style="color:#ABB2BF;">)?)?;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;">    Ok</span><span style="color:#ABB2BF;">(())</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>代码中， <code>search()</code> 函数中 <code>contents.par_lines()</code> 这一行就是使用的 Rayon 里的 <code>par_lines()</code> 迭代器，它是 <code>lines()</code> 迭代器的并行化版本。上面的 search 实现对应下面的 Python 版本。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">def</span><span style="color:#61AFEF;"> search_py</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">contents</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">str</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">needle</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">str</span><span style="color:#ABB2BF;">) -&gt; </span><span style="color:#E06C75;">int</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span style="color:#E06C75;">    total</span><span style="color:#56B6C2;"> =</span><span style="color:#D19A66;"> 0</span></span>
<span class="line"><span style="color:#C678DD;">    for</span><span style="color:#E06C75;"> line</span><span style="color:#C678DD;"> in</span><span style="color:#E06C75;"> contents</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">splitlines</span><span style="color:#ABB2BF;">():</span></span>
<span class="line"><span style="color:#C678DD;">        for</span><span style="color:#E06C75;"> word</span><span style="color:#C678DD;"> in</span><span style="color:#E06C75;"> line</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">split</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot; &quot;</span><span style="color:#ABB2BF;">):</span></span>
<span class="line"><span style="color:#C678DD;">            if</span><span style="color:#E06C75;"> word</span><span style="color:#56B6C2;"> ==</span><span style="color:#E06C75;"> needle</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span style="color:#E06C75;">                total</span><span style="color:#56B6C2;"> +=</span><span style="color:#D19A66;"> 1</span></span>
<span class="line"><span style="color:#C678DD;">    return</span><span style="color:#E06C75;"> total</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>你可以看一下 <a href="https://github.com/miketang84/jikeshijian/tree/master/30-ffi/word-count" target="_blank" rel="noreferrer">项目代码</a>，这个项目使用 <code>pytest-benchmark</code> 来做性能评测。要运行性能评测，你需要安装 nox。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// 先安装项目依赖</span></span>
<span class="line"><span style="color:#E06C75;">pip</span><span style="color:#E06C75;"> install</span><span style="color:#ABB2BF;"> .</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 再安装 nox 工具</span></span>
<span class="line"><span style="color:#E06C75;">pip</span><span style="color:#E06C75;"> install</span><span style="color:#E06C75;"> nox</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然后在项目根目录下运行：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">nox</span><span style="color:#ABB2BF;"> -</span><span style="color:#E06C75;">s</span><span style="color:#E06C75;"> bench</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>稍等片刻，我们会得到如下输出：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">$ </span><span style="color:#E06C75;">nox</span><span style="color:#ABB2BF;"> -</span><span style="color:#E06C75;">s</span><span style="color:#E06C75;"> bench</span></span>
<span class="line"><span style="color:#E06C75;">nox</span><span style="color:#56B6C2;"> &gt;</span><span style="color:#E5C07B;"> Running</span><span style="color:#E06C75;"> session</span><span style="color:#E06C75;"> bench</span></span>
<span class="line"><span style="color:#E06C75;">nox</span><span style="color:#56B6C2;"> &gt;</span><span style="color:#E5C07B;"> Creating</span><span style="color:#C678DD;"> virtual</span><span style="color:#E06C75;"> environment</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;">virtualenv</span><span style="color:#ABB2BF;">) </span><span style="color:#E06C75;">using</span><span style="color:#E06C75;"> python3</span><span style="color:#C678DD;"> in</span><span style="color:#ABB2BF;"> .nox/</span><span style="color:#E06C75;">bench</span></span>
<span class="line"><span style="color:#E06C75;">nox</span><span style="color:#56B6C2;"> &gt;</span><span style="color:#E06C75;"> python</span><span style="color:#ABB2BF;"> -</span><span style="color:#E06C75;">m</span><span style="color:#E06C75;"> pip</span><span style="color:#E06C75;"> install</span><span style="color:#98C379;"> &#39;.[dev]&#39;</span></span>
<span class="line"><span style="color:#E06C75;">nox</span><span style="color:#56B6C2;"> &gt;</span><span style="color:#E06C75;"> pytest</span><span style="color:#ABB2BF;"> --</span><span style="color:#E06C75;">benchmark</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">enable</span></span>
<span class="line"><span style="color:#56B6C2;">===========================================================</span><span style="color:#E06C75;"> test</span><span style="color:#E06C75;"> session</span><span style="color:#E06C75;"> starts</span><span style="color:#56B6C2;"> ============================================================</span></span>
<span class="line"><span style="color:#E06C75;">platform</span><span style="color:#E06C75;"> linux</span><span style="color:#ABB2BF;"> -- </span><span style="color:#E5C07B;">Python</span><span style="color:#D19A66;"> 3.10</span><span style="color:#ABB2BF;">.</span><span style="color:#D19A66;">12</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">pytest</span><span style="color:#ABB2BF;">-</span><span style="color:#D19A66;">7.4</span><span style="color:#ABB2BF;">.</span><span style="color:#D19A66;">3</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">pluggy</span><span style="color:#ABB2BF;">-</span><span style="color:#D19A66;">1.3</span><span style="color:#ABB2BF;">.</span><span style="color:#D19A66;">0</span></span>
<span class="line"><span style="color:#E06C75;">benchmark</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">4.0</span><span style="color:#ABB2BF;">.</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;">defaults</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">timer</span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;">time</span><span style="color:#ABB2BF;">.perf_counter </span><span style="color:#E06C75;">disable_gc</span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;">False</span><span style="color:#E06C75;"> min_rounds</span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;">5</span><span style="color:#E06C75;"> min_time</span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;">0.000005</span><span style="color:#E06C75;"> max_time</span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;">1.0</span><span style="color:#E06C75;"> calibration_precision</span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;">10</span><span style="color:#E06C75;"> warmup</span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;">False</span><span style="color:#E06C75;"> warmup_iterations</span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;">100000</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#E06C75;">rootdir</span><span style="color:#ABB2BF;">: /</span><span style="color:#E06C75;">home</span><span style="color:#ABB2BF;">/</span><span style="color:#E06C75;">mike</span><span style="color:#ABB2BF;">/</span><span style="color:#E06C75;">works</span><span style="color:#ABB2BF;">/</span><span style="color:#E06C75;">pyo3works</span><span style="color:#ABB2BF;">/</span><span style="color:#E06C75;">word</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">count</span></span>
<span class="line"><span style="color:#E06C75;">configfile</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">pyproject</span><span style="color:#ABB2BF;">.toml</span></span>
<span class="line"><span style="color:#E06C75;">plugins</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">benchmark</span><span style="color:#ABB2BF;">-</span><span style="color:#D19A66;">4.0</span><span style="color:#ABB2BF;">.</span><span style="color:#D19A66;">0</span></span>
<span class="line"><span style="color:#E06C75;">collected</span><span style="color:#D19A66;"> 2</span><span style="color:#E06C75;"> items</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;">tests</span><span style="color:#ABB2BF;">/</span><span style="color:#E06C75;">test_word_count</span><span style="color:#ABB2BF;">.py ..                                                                                                          [</span><span style="color:#D19A66;">100</span><span style="color:#ABB2BF;">%]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">----------------------------------------------------------------------------------------- </span><span style="color:#E06C75;">benchmark</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">2</span><span style="color:#E06C75;"> tests</span><span style="color:#ABB2BF;"> ----------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#E5C07B;">Name</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;">time</span><span style="color:#C678DD;"> in</span><span style="color:#E06C75;"> ms</span><span style="color:#ABB2BF;">)                         </span><span style="color:#E5C07B;">Min</span><span style="color:#E5C07B;">                Max</span><span style="color:#E5C07B;">               Mean</span><span style="color:#E5C07B;">            StdDev</span><span style="color:#E5C07B;">             Median</span><span style="color:#D19A66;">               IQR</span><span style="color:#E5C07B;">            Outliers</span><span style="color:#D19A66;">      OPS</span><span style="color:#E5C07B;">            Rounds</span><span style="color:#E5C07B;">  Iterations</span></span>
<span class="line"><span style="color:#ABB2BF;">-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#E06C75;">test_word_count_rust_parallel</span><span style="color:#D19A66;">         19.6740</span><span style="color:#ABB2BF;"> (</span><span style="color:#D19A66;">1.0</span><span style="color:#ABB2BF;">)      </span><span style="color:#D19A66;">50.2725</span><span style="color:#ABB2BF;"> (</span><span style="color:#D19A66;">1.0</span><span style="color:#ABB2BF;">)      </span><span style="color:#D19A66;">27.9049</span><span style="color:#ABB2BF;"> (</span><span style="color:#D19A66;">1.0</span><span style="color:#ABB2BF;">)      </span><span style="color:#D19A66;">9.7562</span><span style="color:#ABB2BF;"> (</span><span style="color:#D19A66;">2.27</span><span style="color:#ABB2BF;">)     </span><span style="color:#D19A66;">22.9368</span><span style="color:#ABB2BF;"> (</span><span style="color:#D19A66;">1.0</span><span style="color:#ABB2BF;">)      </span><span style="color:#D19A66;">8.5993</span><span style="color:#ABB2BF;"> (</span><span style="color:#D19A66;">1.13</span><span style="color:#ABB2BF;">)          </span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">;</span><span style="color:#D19A66;">2</span><span style="color:#D19A66;">  35.8360</span><span style="color:#ABB2BF;"> (</span><span style="color:#D19A66;">1.0</span><span style="color:#ABB2BF;">)          </span><span style="color:#D19A66;">13</span><span style="color:#D19A66;">           1</span></span>
<span class="line"><span style="color:#E06C75;">test_word_count_python_sequential</span><span style="color:#D19A66;">     78.4158</span><span style="color:#ABB2BF;"> (</span><span style="color:#D19A66;">3.99</span><span style="color:#ABB2BF;">)     </span><span style="color:#D19A66;">91.5790</span><span style="color:#ABB2BF;"> (</span><span style="color:#D19A66;">1.82</span><span style="color:#ABB2BF;">)     </span><span style="color:#D19A66;">84.4852</span><span style="color:#ABB2BF;"> (</span><span style="color:#D19A66;">3.03</span><span style="color:#ABB2BF;">)     </span><span style="color:#D19A66;">4.3023</span><span style="color:#ABB2BF;"> (</span><span style="color:#D19A66;">1.0</span><span style="color:#ABB2BF;">)      </span><span style="color:#D19A66;">84.7501</span><span style="color:#ABB2BF;"> (</span><span style="color:#D19A66;">3.69</span><span style="color:#ABB2BF;">)     </span><span style="color:#D19A66;">7.6210</span><span style="color:#ABB2BF;"> (</span><span style="color:#D19A66;">1.0</span><span style="color:#ABB2BF;">)           </span><span style="color:#D19A66;">5</span><span style="color:#ABB2BF;">;</span><span style="color:#D19A66;">0</span><span style="color:#D19A66;">  11.8364</span><span style="color:#ABB2BF;"> (</span><span style="color:#D19A66;">0.33</span><span style="color:#ABB2BF;">)         </span><span style="color:#D19A66;">13</span><span style="color:#D19A66;">           1</span></span>
<span class="line"><span style="color:#ABB2BF;">-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;">Legend</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span style="color:#E5C07B;">  Outliers</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">1</span><span style="color:#E5C07B;"> Standard</span><span style="color:#E5C07B;"> Deviation</span><span style="color:#E06C75;"> from</span><span style="color:#E5C07B;"> Mean</span><span style="color:#ABB2BF;">; </span><span style="color:#D19A66;">1.5</span><span style="color:#D19A66;"> IQR</span><span style="color:#ABB2BF;"> (</span><span style="color:#E5C07B;">InterQuartile</span><span style="color:#E5C07B;"> Range</span><span style="color:#ABB2BF;">) </span><span style="color:#E06C75;">from</span><span style="color:#E06C75;"> 1st</span><span style="color:#E5C07B;"> Quartile</span><span style="color:#E06C75;"> and</span><span style="color:#E06C75;"> 3rd</span><span style="color:#E5C07B;"> Quartile</span><span style="color:#ABB2BF;">.</span></span>
<span class="line"><span style="color:#D19A66;">  OPS</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Operations</span><span style="color:#E5C07B;"> Per</span><span style="color:#E5C07B;"> Second</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">computed</span><span style="color:#C678DD;"> as</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;"> / </span><span style="color:#E5C07B;">Mean</span></span>
<span class="line"><span style="color:#56B6C2;">============================================================</span><span style="color:#D19A66;"> 2</span><span style="color:#E06C75;"> passed</span><span style="color:#C678DD;"> in</span><span style="color:#D19A66;"> 2.</span><span style="color:#ABB2BF;">78s </span><span style="color:#56B6C2;">=============================================================</span></span>
<span class="line"><span style="color:#E06C75;">nox</span><span style="color:#56B6C2;"> &gt;</span><span style="color:#E5C07B;"> Session</span><span style="color:#E06C75;"> bench</span><span style="color:#E06C75;"> was</span><span style="color:#E06C75;"> successful</span><span style="color:#ABB2BF;">.</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>可以看到，Rust 并行化版本比 Python 顺序化版本的平均性能提升了 3 倍左右（并行化版本消耗时间为顺序化版本的 1/3 左右），实际上被处理的文件越大，这个性能提升就越明显。</p><h2 id="业界知名-pyo3-绑定项目介绍" tabindex="-1">业界知名 PyO3 绑定项目介绍 <a class="header-anchor" href="#业界知名-pyo3-绑定项目介绍" aria-label="Permalink to &quot;业界知名 PyO3 绑定项目介绍&quot;">​</a></h2><p>目前，Rust 生态和 Python 之间已经有一些知名的项目使用 PyO3 实现绑定了，我选了几个比较不错的放在下面，你可以点击链接深入了解一下。</p><ul><li>OpenDAL 的 Python 绑定： <a href="https://github.com/apache/incubator-opendal/tree/main/bindings/python" target="_blank" rel="noreferrer">https://github.com/apache/incubator-opendal/tree/main/bindings/python</a></li><li>Polars 的 Python 绑定： <a href="https://github.com/pola-rs/polars/tree/main/py-polars" target="_blank" rel="noreferrer">https://github.com/pola-rs/polars/tree/main/py-polars</a></li><li>Delta Lake 的 Python 绑定： <a href="https://github.com/delta-io/delta-rs/tree/main/python" target="_blank" rel="noreferrer">https://github.com/delta-io/delta-rs/tree/main/python</a></li><li>Arrow-Datafusion 的 Python 绑定： <a href="https://github.com/apache/arrow-datafusion-python" target="_blank" rel="noreferrer">https://github.com/apache/arrow-datafusion-python</a></li><li>tokenizers 的 Python 绑定： <a href="https://github.com/huggingface/tokenizers/tree/main/bindings/python" target="_blank" rel="noreferrer">https://github.com/huggingface/tokenizers/tree/main/bindings/python</a></li></ul><h2 id="小结" tabindex="-1">小结 <a class="header-anchor" href="#小结" aria-label="Permalink to &quot;小结&quot;">​</a></h2><p>这节课我们通过 4 个示例展示了如何在 Rust 中调用 C 函数，如何在 C 函数中调用 Rust 函数，以及在 Python 中调用 Rust 实现的模块和函数。并且通过对比 Rust 的实现版本与 Python 原生的实现版本，我们发现使用 Rust 写 Python 扩展性能更好。</p><p>Unsafe Rust 编程大量出现在底层性能的优化和与其他语言交互的场景中，体现了 Rust 这门语言一个奇特的地方：Rust 语言本身对安全性和性能的追求，不但让 Rust 本身脱颖而出，而且还反哺了 C 语言的生态，用 Rust 重新实现一部分模块，同时还能无缝地接入之前的 C 系统中，提升了之前 C 系统的安全性。并且这是一种渐进的做法，非常有利于历史遗留系统的迭代更新。</p><p>此外，Unsafe Rust 编程还可以赋能其他语言社区，将 Rust 的澎湃动力和安全扩展到了 Python、JavaScript 等其他语言。它们之前的扩展使用 C/C++编写，同样会存在安全性和稳定性的问题，而 Rust 解决了这个问题。</p><p>不过涉及到 Unsafe Rust 和 FFI 的场景，想要封装一个真正好用的库或扩展，还有大量的细节知识待你探索。不管怎样，我们已经踏上了安全提升和性能提升之路，有 Rust 为你输出动力，保驾护航，你便可以放开手脚，大胆去干。</p><h2 id="思考题" tabindex="-1">思考题 <a class="header-anchor" href="#思考题" aria-label="Permalink to &quot;思考题&quot;">​</a></h2><p>请你聊一聊，C 语言中的 char 与 Rust 中的 char 的区别在哪里？C 语言的字符串与 Rust 中的 String 区别在哪里？如何将 C 语言的字符串类型映射到 Rust 的类型中来？欢迎你把自己的思考分享到评论区，也欢迎你把这节课的内容分享给其他朋友，我们下节课再见！</p></div></div></main><footer class="VPDocFooter" data-v-39a288b8 data-v-e257564d><!--[--><!--]--><div class="edit-info" data-v-e257564d><div class="edit-link" data-v-e257564d><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/muyaCode/FrontEndLearnNotes/edit/main/docs/Document/30｜Unsafe编程（下）：使用Rust为Python写一个扩展.md" target="_blank" rel="noreferrer" data-v-e257564d><!--[--><span class="vpi-square-pen edit-link-icon" data-v-e257564d></span> 在 GitHub 上编辑此页<!--]--></a></div><div class="last-updated" data-v-e257564d><p class="VPLastUpdated" data-v-e257564d data-v-e98dd255>上次更新：: <time datetime="2025-02-28T18:19:24.000Z" data-v-e98dd255></time></p></div></div><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-e257564d><span class="visually-hidden" id="doc-footer-aria-label" data-v-e257564d>Pager</span><div class="pager" data-v-e257564d><a class="VPLink link pager-link prev" href="/tanggang_rust/Document/29%EF%BD%9CUnsafe%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9AUnsafeRust%E4%B8%AD%E9%82%A3%E4%BA%9B%E8%A2%AB%E5%B0%81%E5%8D%B0%E7%9A%84%E8%83%BD%E5%8A%9B" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>上一篇</span><span class="title" data-v-e257564d>29｜Unsafe编程（上）：UnsafeRust中那些被封印的能力</span><!--]--></a></div><div class="pager" data-v-e257564d><a class="VPLink link pager-link next" href="/tanggang_rust/Document/%E7%AD%94%E7%96%91%E8%AF%BE%E5%A0%82%EF%BC%88%E4%B8%89%EF%BC%89%EF%BD%9C%E7%AC%AC%E4%B8%89%E7%AB%A0Rust%E5%BA%94%E7%94%A8%E7%AF%87%E6%80%9D%E8%80%83%E9%A2%98%E7%AD%94%E6%A1%88" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>下一篇</span><span class="title" data-v-e257564d>答疑课堂（三）｜第三章Rust应用篇思考题答案</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-5d98c3a5 data-v-e315a0ad><div class="container" data-v-e315a0ad><p class="message" data-v-e315a0ad>Released under the MIT License.</p><p class="copyright" data-v-e315a0ad>Copyright © 2025  MuYa</p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"document_00｜开篇词｜拥抱rust浪潮，迎接更极致的编程体验.md\":\"Bx6ruBRE\",\"document_01｜快速入门：rust中有哪些你不得不了解的基础语法？.md\":\"YEQ1UjRq\",\"document_02｜所有权（上）：rust是如何管理程序中的资源的？.md\":\"Bvb116GB\",\"document_03｜所有权（下）：rust中借用与引用的规则是怎样的？.md\":\"BJwhWwWd\",\"document_04｜字符串：对号入座，字符串其实没那么可怕！.md\":\"Bv5l_4z9\",\"document_05｜复合类型（上）：结构体与面向对象特性.md\":\"CITkKTJg\",\"document_06｜复合类型（下）：枚举与模式匹配.md\":\"Ct8Xedp7\",\"document_07｜类型与类型参数：给rust小助手提供更多信息.md\":\"EbjW2AkC\",\"document_08｜option-t-与result-t_e-、迭代器.md\":\"BNKn_0uw\",\"document_09｜初识trait：协议约束与能力配置.md\":\"llurKKcW\",\"document_10｜再探trait：带类型参数的trait及traitobject.md\":\"CMwHA5A-\",\"document_11｜常见trait解析：标准库中的常见trait应该怎么用？.md\":\"BGa5CpQf\",\"document_12｜智能指针：从所有权看智能指针.md\":\"Cxvwfxu6\",\"document_13｜独立王国：初步了解rust异步并发编程.md\":\"DSU5sdFT\",\"document_14｜tokio实战：编写一个网络命令行程序.md\":\"C1JeQOSl\",\"document_15｜tokio编程：在多任务之间操作同一片数据.md\":\"Bwzc0tpF\",\"document_16｜tokio编程：使用channel在不同任务间通信？.md\":\"DKrhaVoh\",\"document_17｜tokio编程：rust异步编程还有哪些需要注意的点？.md\":\"CmxLkup0\",\"document_18｜错误处理系统：错误的构建、传递和处理.md\":\"BWw-vDDL\",\"document_19｜rust的宏体系：为自己的项目写一个简单的声明宏.md\":\"DXluFKAD\",\"document_20｜生命周期：rust如何做基本的生命周期符号标注？.md\":\"Bt1xgIs6\",\"document_21｜web开发（上）：如何使用axum框架进行web后端开发？.md\":\"DXd_p46T\",\"document_22｜web开发（下）：如何实现一个todolist应用？.md\":\"Bi1r-Ulj\",\"document_23｜rust与大模型：用candle做一个聊天机器人.md\":\"CDaEmFi3\",\"document_24｜rust图像识别：利用yolov8识别对象.md\":\"CMFa5k75\",\"document_25｜rustgui编程：用slint为chatbot实现一个界面.md\":\"CSQiE64f\",\"document_26｜rustgui编程：用slint为yolov8实现一个界面.md\":\"8_AGledo\",\"document_27｜rustbevy游戏开发：用300行代码做一个贪吃蛇游戏.md\":\"DcZ-wJin\",\"document_28｜nom：用rust写一个parser解析器.md\":\"DtpKzSZI\",\"document_29｜unsafe编程（上）：unsaferust中那些被封印的能力.md\":\"DkGls-cm\",\"document_30｜unsafe编程（下）：使用rust为python写一个扩展.md\":\"tPXz85a6\",\"document_答疑课堂（一）｜第一章rust基础篇思考题答案.md\":\"CC_0mUbW\",\"document_答疑课堂（三）｜第三章rust应用篇思考题答案.md\":\"He3Na2GY\",\"document_答疑课堂（二）｜第二章rust进阶篇思考题答案.md\":\"rq96ZBKO\",\"document_结束语｜未来让rust带你“锈”到起飞.md\":\"CDoEtXUj\",\"document_结课测试｜来赴一场满分之约.md\":\"BDMdH3Zr\",\"index.md\":\"ZlsnMKnR\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh\",\"dir\":\"ltr\",\"title\":\"唐刚-Rust语言从入门到实战\",\"description\":\"Rust语言从入门到实战\",\"base\":\"/tanggang_rust/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"logo\":\"/img/buding.svg\",\"siteTitle\":\"Rust语言从入门到实战\",\"outlineTitle\":\"⚡️文档内容大纲\",\"outline\":\"deep\",\"search\":{\"provider\":\"local\",\"options\":{\"locales\":{\"root\":{\"translations\":{\"button\":{\"buttonText\":\"搜索文档\",\"buttonAriaLabel\":\"搜索文档\"},\"modal\":{\"noResultsText\":\"无法找到相关结果\",\"displayDetails\":\"显示详细信息\",\"resetButtonTitle\":\"清除查询条件\",\"backButtonTitle\":\"返回搜索结果\",\"footer\":{\"selectText\":\"选择\",\"selectKeyAriaLabel\":\"enter\",\"navigateText\":\"切换\",\"navigateUpKeyAriaLabel\":\"up arrow\",\"navigateDownKeyAriaLabel\":\"down arrow\",\"closeText\":\"关闭\",\"closeKeyAriaLabel\":\"escape\"}}}}},\"miniSearch\":{\"options\":{},\"searchOptions\":{}}}},\"sidebar\":{\"/\":[{\"text\":\"00｜开篇词｜拥抱Rust浪潮，迎接更极致的编程体验\",\"link\":\"/Document/00｜开篇词｜拥抱Rust浪潮，迎接更极致的编程体验\"},{\"text\":\"01｜快速入门：Rust中有哪些你不得不了解的基础语法？\",\"link\":\"/Document/01｜快速入门：Rust中有哪些你不得不了解的基础语法？\"},{\"text\":\"02｜所有权（上）：Rust是如何管理程序中的资源的？\",\"link\":\"/Document/02｜所有权（上）：Rust是如何管理程序中的资源的？\"},{\"text\":\"03｜所有权（下）：Rust中借用与引用的规则是怎样的？\",\"link\":\"/Document/03｜所有权（下）：Rust中借用与引用的规则是怎样的？\"},{\"text\":\"04｜字符串：对号入座，字符串其实没那么可怕！\",\"link\":\"/Document/04｜字符串：对号入座，字符串其实没那么可怕！\"},{\"text\":\"05｜复合类型（上）：结构体与面向对象特性\",\"link\":\"/Document/05｜复合类型（上）：结构体与面向对象特性\"},{\"text\":\"06｜复合类型（下）：枚举与模式匹配\",\"link\":\"/Document/06｜复合类型（下）：枚举与模式匹配\"},{\"text\":\"07｜类型与类型参数：给Rust小助手提供更多信息\",\"link\":\"/Document/07｜类型与类型参数：给Rust小助手提供更多信息\"},{\"text\":\"08｜Option-T-与Result-T,E-、迭代器\",\"link\":\"/Document/08｜Option-T-与Result-T,E-、迭代器\"},{\"text\":\"09｜初识trait：协议约束与能力配置\",\"link\":\"/Document/09｜初识trait：协议约束与能力配置\"},{\"text\":\"10｜再探trait：带类型参数的trait及traitobject\",\"link\":\"/Document/10｜再探trait：带类型参数的trait及traitobject\"},{\"text\":\"11｜常见trait解析：标准库中的常见trait应该怎么用？\",\"link\":\"/Document/11｜常见trait解析：标准库中的常见trait应该怎么用？\"},{\"text\":\"答疑课堂（一）｜第一章Rust基础篇思考题答案\",\"link\":\"/Document/答疑课堂（一）｜第一章Rust基础篇思考题答案\"},{\"text\":\"12｜智能指针：从所有权看智能指针\",\"link\":\"/Document/12｜智能指针：从所有权看智能指针\"},{\"text\":\"13｜独立王国：初步了解Rust异步并发编程\",\"link\":\"/Document/13｜独立王国：初步了解Rust异步并发编程\"},{\"text\":\"14｜tokio实战：编写一个网络命令行程序\",\"link\":\"/Document/14｜tokio实战：编写一个网络命令行程序\"},{\"text\":\"15｜tokio编程：在多任务之间操作同一片数据\",\"link\":\"/Document/15｜tokio编程：在多任务之间操作同一片数据\"},{\"text\":\"16｜tokio编程：使用channel在不同任务间通信？\",\"link\":\"/Document/16｜tokio编程：使用channel在不同任务间通信？\"},{\"text\":\"17｜tokio编程：Rust异步编程还有哪些需要注意的点？\",\"link\":\"/Document/17｜tokio编程：Rust异步编程还有哪些需要注意的点？\"},{\"text\":\"18｜错误处理系统：错误的构建、传递和处理\",\"link\":\"/Document/18｜错误处理系统：错误的构建、传递和处理\"},{\"text\":\"19｜Rust的宏体系：为自己的项目写一个简单的声明宏\",\"link\":\"/Document/19｜Rust的宏体系：为自己的项目写一个简单的声明宏\"},{\"text\":\"20｜生命周期：Rust如何做基本的生命周期符号标注？\",\"link\":\"/Document/20｜生命周期：Rust如何做基本的生命周期符号标注？\"},{\"text\":\"答疑课堂（二）｜第二章Rust进阶篇思考题答案\",\"link\":\"/Document/答疑课堂（二）｜第二章Rust进阶篇思考题答案\"},{\"text\":\"21｜Web开发（上）：如何使用Axum框架进行Web后端开发？\",\"link\":\"/Document/21｜Web开发（上）：如何使用Axum框架进行Web后端开发？\"},{\"text\":\"22｜Web开发（下）：如何实现一个TodoList应用？\",\"link\":\"/Document/22｜Web开发（下）：如何实现一个TodoList应用？\"},{\"text\":\"23｜Rust与大模型：用Candle做一个聊天机器人\",\"link\":\"/Document/23｜Rust与大模型：用Candle做一个聊天机器人\"},{\"text\":\"24｜Rust图像识别：利用YOLOv8识别对象\",\"link\":\"/Document/24｜Rust图像识别：利用YOLOv8识别对象\"},{\"text\":\"25｜RustGUI编程：用Slint为Chatbot实现一个界面\",\"link\":\"/Document/25｜RustGUI编程：用Slint为Chatbot实现一个界面\"},{\"text\":\"26｜RustGUI编程：用Slint为YOLOv8实现一个界面\",\"link\":\"/Document/26｜RustGUI编程：用Slint为YOLOv8实现一个界面\"},{\"text\":\"27｜RustBevy游戏开发：用300行代码做一个贪吃蛇游戏\",\"link\":\"/Document/27｜RustBevy游戏开发：用300行代码做一个贪吃蛇游戏\"},{\"text\":\"28｜Nom：用Rust写一个Parser解析器\",\"link\":\"/Document/28｜Nom：用Rust写一个Parser解析器\"},{\"text\":\"29｜Unsafe编程（上）：UnsafeRust中那些被封印的能力\",\"link\":\"/Document/29｜Unsafe编程（上）：UnsafeRust中那些被封印的能力\"},{\"text\":\"30｜Unsafe编程（下）：使用Rust为Python写一个扩展\",\"link\":\"/Document/30｜Unsafe编程（下）：使用Rust为Python写一个扩展\"},{\"text\":\"答疑课堂（三）｜第三章Rust应用篇思考题答案\",\"link\":\"/Document/答疑课堂（三）｜第三章Rust应用篇思考题答案\"},{\"text\":\"结课测试｜来赴一场满分之约\",\"link\":\"/Document/结课测试｜来赴一场满分之约\"},{\"text\":\"结束语｜未来让Rust带你“锈”到起飞\",\"link\":\"/Document/结束语｜未来让Rust带你“锈”到起飞\"}]},\"editLink\":{\"pattern\":\"https://github.com/muyaCode/FrontEndLearnNotes/edit/main/docs/:path\",\"text\":\"在 GitHub 上编辑此页\"},\"lastUpdated\":{\"text\":\"上次更新：\",\"formatOptions\":{\"dateStyle\":\"full\",\"timeStyle\":\"medium\"}},\"docFooter\":{\"prev\":\"上一篇\",\"next\":\"下一篇\"},\"footer\":{\"message\":\"Released under the MIT License.\",\"copyright\":\"Copyright © 2025  MuYa\"}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":true}");</script>
    
  </body>
</html>