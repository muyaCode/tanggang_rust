<!DOCTYPE html>
<html lang="zh" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>15 ｜ tokio 编程：在多任务之间操作同一片数据 | 唐刚-Rust语言从入门到实战</title>
    <meta name="description" content="Rust语言从入门到实战">
    <meta name="generator" content="VitePress v1.6.3">
    <link rel="preload stylesheet" href="/tanggang_rust/assets/style.Dmb1gw5t.css" as="style">
    <link rel="preload stylesheet" href="/tanggang_rust/vp-icons.css" as="style">
    
    <script type="module" src="/tanggang_rust/assets/app.DakBAcEX.js"></script>
    <link rel="preload" href="/tanggang_rust/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/tanggang_rust/assets/chunks/theme.BYwnybAk.js">
    <link rel="modulepreload" href="/tanggang_rust/assets/chunks/framework.D2WelYEY.js">
    <link rel="modulepreload" href="/tanggang_rust/assets/Document_15｜tokio编程：在多任务之间操作同一片数据.md.Bwzc0tpF.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-5d98c3a5><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0b0ada53></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0b0ada53>Skip to content</a><!--]--><!----><header class="VPNav" data-v-5d98c3a5 data-v-ae24b3ad><div class="VPNavBar" data-v-ae24b3ad data-v-6aa21345><div class="wrapper" data-v-6aa21345><div class="container" data-v-6aa21345><div class="title" data-v-6aa21345><div class="VPNavBarTitle has-sidebar" data-v-6aa21345 data-v-1168a8e4><a class="title" href="/tanggang_rust/" data-v-1168a8e4><!--[--><!--]--><!--[--><img class="VPImage logo" src="/tanggang_rust/img/buding.svg" alt data-v-8426fc1a><!--]--><span data-v-1168a8e4>Rust语言从入门到实战</span><!--[--><!--]--></a></div></div><div class="content" data-v-6aa21345><div class="content-body" data-v-6aa21345><!--[--><!--]--><div class="VPNavBarSearch search" data-v-6aa21345><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索文档"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">搜索文档</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><!----><!----><div class="VPNavBarAppearance appearance" data-v-6aa21345 data-v-6c893767><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-6c893767 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div><!----><div class="VPFlyout VPNavBarExtra extra" data-v-6aa21345 data-v-bb2aa2f0 data-v-cf11d7a2><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-cf11d7a2><span class="vpi-more-horizontal icon" data-v-cf11d7a2></span></button><div class="menu" data-v-cf11d7a2><div class="VPMenu" data-v-cf11d7a2 data-v-b98bc113><!----><!--[--><!--[--><!----><div class="group" data-v-bb2aa2f0><div class="item appearance" data-v-bb2aa2f0><p class="label" data-v-bb2aa2f0>Appearance</p><div class="appearance-action" data-v-bb2aa2f0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-bb2aa2f0 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div></div></div><!----><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-6aa21345 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-6aa21345><div class="divider-line" data-v-6aa21345></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-5d98c3a5 data-v-a6f0e41e><div class="container" data-v-a6f0e41e><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-a6f0e41e><span class="vpi-align-left menu-icon" data-v-a6f0e41e></span><span class="menu-text" data-v-a6f0e41e>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-a6f0e41e data-v-8a42e2b4><button data-v-8a42e2b4>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-5d98c3a5 data-v-319d5ca6><div class="curtain" data-v-319d5ca6></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-319d5ca6><span class="visually-hidden" id="sidebar-aria-label" data-v-319d5ca6> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-c40bc020><section class="VPSidebarItem level-0 has-active" data-v-c40bc020 data-v-b3fd67f8><!----><div class="items" data-v-b3fd67f8><!--[--><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/00%EF%BD%9C%E5%BC%80%E7%AF%87%E8%AF%8D%EF%BD%9C%E6%8B%A5%E6%8A%B1Rust%E6%B5%AA%E6%BD%AE%EF%BC%8C%E8%BF%8E%E6%8E%A5%E6%9B%B4%E6%9E%81%E8%87%B4%E7%9A%84%E7%BC%96%E7%A8%8B%E4%BD%93%E9%AA%8C" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>00｜开篇词｜拥抱Rust浪潮，迎接更极致的编程体验</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/01%EF%BD%9C%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%EF%BC%9ARust%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9B%E4%BD%A0%E4%B8%8D%E5%BE%97%E4%B8%8D%E4%BA%86%E8%A7%A3%E7%9A%84%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>01｜快速入门：Rust中有哪些你不得不了解的基础语法？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/02%EF%BD%9C%E6%89%80%E6%9C%89%E6%9D%83%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9ARust%E6%98%AF%E5%A6%82%E4%BD%95%E7%AE%A1%E7%90%86%E7%A8%8B%E5%BA%8F%E4%B8%AD%E7%9A%84%E8%B5%84%E6%BA%90%E7%9A%84%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>02｜所有权（上）：Rust是如何管理程序中的资源的？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/03%EF%BD%9C%E6%89%80%E6%9C%89%E6%9D%83%EF%BC%88%E4%B8%8B%EF%BC%89%EF%BC%9ARust%E4%B8%AD%E5%80%9F%E7%94%A8%E4%B8%8E%E5%BC%95%E7%94%A8%E7%9A%84%E8%A7%84%E5%88%99%E6%98%AF%E6%80%8E%E6%A0%B7%E7%9A%84%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>03｜所有权（下）：Rust中借用与引用的规则是怎样的？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/04%EF%BD%9C%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%9A%E5%AF%B9%E5%8F%B7%E5%85%A5%E5%BA%A7%EF%BC%8C%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%85%B6%E5%AE%9E%E6%B2%A1%E9%82%A3%E4%B9%88%E5%8F%AF%E6%80%95%EF%BC%81" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>04｜字符串：对号入座，字符串其实没那么可怕！</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/05%EF%BD%9C%E5%A4%8D%E5%90%88%E7%B1%BB%E5%9E%8B%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9A%E7%BB%93%E6%9E%84%E4%BD%93%E4%B8%8E%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%89%B9%E6%80%A7" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>05｜复合类型（上）：结构体与面向对象特性</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/06%EF%BD%9C%E5%A4%8D%E5%90%88%E7%B1%BB%E5%9E%8B%EF%BC%88%E4%B8%8B%EF%BC%89%EF%BC%9A%E6%9E%9A%E4%B8%BE%E4%B8%8E%E6%A8%A1%E5%BC%8F%E5%8C%B9%E9%85%8D" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>06｜复合类型（下）：枚举与模式匹配</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/07%EF%BD%9C%E7%B1%BB%E5%9E%8B%E4%B8%8E%E7%B1%BB%E5%9E%8B%E5%8F%82%E6%95%B0%EF%BC%9A%E7%BB%99Rust%E5%B0%8F%E5%8A%A9%E6%89%8B%E6%8F%90%E4%BE%9B%E6%9B%B4%E5%A4%9A%E4%BF%A1%E6%81%AF" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>07｜类型与类型参数：给Rust小助手提供更多信息</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/08%EF%BD%9COption-T-%E4%B8%8EResult-T,E-%E3%80%81%E8%BF%AD%E4%BB%A3%E5%99%A8" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>08｜Option-T-与Result-T,E-、迭代器</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/09%EF%BD%9C%E5%88%9D%E8%AF%86trait%EF%BC%9A%E5%8D%8F%E8%AE%AE%E7%BA%A6%E6%9D%9F%E4%B8%8E%E8%83%BD%E5%8A%9B%E9%85%8D%E7%BD%AE" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>09｜初识trait：协议约束与能力配置</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/10%EF%BD%9C%E5%86%8D%E6%8E%A2trait%EF%BC%9A%E5%B8%A6%E7%B1%BB%E5%9E%8B%E5%8F%82%E6%95%B0%E7%9A%84trait%E5%8F%8Atraitobject" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>10｜再探trait：带类型参数的trait及traitobject</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/11%EF%BD%9C%E5%B8%B8%E8%A7%81trait%E8%A7%A3%E6%9E%90%EF%BC%9A%E6%A0%87%E5%87%86%E5%BA%93%E4%B8%AD%E7%9A%84%E5%B8%B8%E8%A7%81trait%E5%BA%94%E8%AF%A5%E6%80%8E%E4%B9%88%E7%94%A8%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>11｜常见trait解析：标准库中的常见trait应该怎么用？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/%E7%AD%94%E7%96%91%E8%AF%BE%E5%A0%82%EF%BC%88%E4%B8%80%EF%BC%89%EF%BD%9C%E7%AC%AC%E4%B8%80%E7%AB%A0Rust%E5%9F%BA%E7%A1%80%E7%AF%87%E6%80%9D%E8%80%83%E9%A2%98%E7%AD%94%E6%A1%88" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>答疑课堂（一）｜第一章Rust基础篇思考题答案</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/12%EF%BD%9C%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88%EF%BC%9A%E4%BB%8E%E6%89%80%E6%9C%89%E6%9D%83%E7%9C%8B%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>12｜智能指针：从所有权看智能指针</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/13%EF%BD%9C%E7%8B%AC%E7%AB%8B%E7%8E%8B%E5%9B%BD%EF%BC%9A%E5%88%9D%E6%AD%A5%E4%BA%86%E8%A7%A3Rust%E5%BC%82%E6%AD%A5%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>13｜独立王国：初步了解Rust异步并发编程</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/14%EF%BD%9Ctokio%E5%AE%9E%E6%88%98%EF%BC%9A%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E7%BD%91%E7%BB%9C%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%A8%8B%E5%BA%8F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>14｜tokio实战：编写一个网络命令行程序</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/15%EF%BD%9Ctokio%E7%BC%96%E7%A8%8B%EF%BC%9A%E5%9C%A8%E5%A4%9A%E4%BB%BB%E5%8A%A1%E4%B9%8B%E9%97%B4%E6%93%8D%E4%BD%9C%E5%90%8C%E4%B8%80%E7%89%87%E6%95%B0%E6%8D%AE" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>15｜tokio编程：在多任务之间操作同一片数据</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/16%EF%BD%9Ctokio%E7%BC%96%E7%A8%8B%EF%BC%9A%E4%BD%BF%E7%94%A8channel%E5%9C%A8%E4%B8%8D%E5%90%8C%E4%BB%BB%E5%8A%A1%E9%97%B4%E9%80%9A%E4%BF%A1%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>16｜tokio编程：使用channel在不同任务间通信？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/17%EF%BD%9Ctokio%E7%BC%96%E7%A8%8B%EF%BC%9ARust%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E8%BF%98%E6%9C%89%E5%93%AA%E4%BA%9B%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E7%82%B9%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>17｜tokio编程：Rust异步编程还有哪些需要注意的点？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/18%EF%BD%9C%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E7%B3%BB%E7%BB%9F%EF%BC%9A%E9%94%99%E8%AF%AF%E7%9A%84%E6%9E%84%E5%BB%BA%E3%80%81%E4%BC%A0%E9%80%92%E5%92%8C%E5%A4%84%E7%90%86" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>18｜错误处理系统：错误的构建、传递和处理</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/19%EF%BD%9CRust%E7%9A%84%E5%AE%8F%E4%BD%93%E7%B3%BB%EF%BC%9A%E4%B8%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E9%A1%B9%E7%9B%AE%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E5%A3%B0%E6%98%8E%E5%AE%8F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>19｜Rust的宏体系：为自己的项目写一个简单的声明宏</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/20%EF%BD%9C%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%EF%BC%9ARust%E5%A6%82%E4%BD%95%E5%81%9A%E5%9F%BA%E6%9C%AC%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AC%A6%E5%8F%B7%E6%A0%87%E6%B3%A8%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>20｜生命周期：Rust如何做基本的生命周期符号标注？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/%E7%AD%94%E7%96%91%E8%AF%BE%E5%A0%82%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BD%9C%E7%AC%AC%E4%BA%8C%E7%AB%A0Rust%E8%BF%9B%E9%98%B6%E7%AF%87%E6%80%9D%E8%80%83%E9%A2%98%E7%AD%94%E6%A1%88" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>答疑课堂（二）｜第二章Rust进阶篇思考题答案</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/21%EF%BD%9CWeb%E5%BC%80%E5%8F%91%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9A%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8Axum%E6%A1%86%E6%9E%B6%E8%BF%9B%E8%A1%8CWeb%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>21｜Web开发（上）：如何使用Axum框架进行Web后端开发？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/22%EF%BD%9CWeb%E5%BC%80%E5%8F%91%EF%BC%88%E4%B8%8B%EF%BC%89%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AATodoList%E5%BA%94%E7%94%A8%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>22｜Web开发（下）：如何实现一个TodoList应用？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/23%EF%BD%9CRust%E4%B8%8E%E5%A4%A7%E6%A8%A1%E5%9E%8B%EF%BC%9A%E7%94%A8Candle%E5%81%9A%E4%B8%80%E4%B8%AA%E8%81%8A%E5%A4%A9%E6%9C%BA%E5%99%A8%E4%BA%BA" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>23｜Rust与大模型：用Candle做一个聊天机器人</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/24%EF%BD%9CRust%E5%9B%BE%E5%83%8F%E8%AF%86%E5%88%AB%EF%BC%9A%E5%88%A9%E7%94%A8YOLOv8%E8%AF%86%E5%88%AB%E5%AF%B9%E8%B1%A1" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>24｜Rust图像识别：利用YOLOv8识别对象</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/25%EF%BD%9CRustGUI%E7%BC%96%E7%A8%8B%EF%BC%9A%E7%94%A8Slint%E4%B8%BAChatbot%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%95%8C%E9%9D%A2" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>25｜RustGUI编程：用Slint为Chatbot实现一个界面</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/26%EF%BD%9CRustGUI%E7%BC%96%E7%A8%8B%EF%BC%9A%E7%94%A8Slint%E4%B8%BAYOLOv8%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%95%8C%E9%9D%A2" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>26｜RustGUI编程：用Slint为YOLOv8实现一个界面</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/27%EF%BD%9CRustBevy%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%EF%BC%9A%E7%94%A8300%E8%A1%8C%E4%BB%A3%E7%A0%81%E5%81%9A%E4%B8%80%E4%B8%AA%E8%B4%AA%E5%90%83%E8%9B%87%E6%B8%B8%E6%88%8F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>27｜RustBevy游戏开发：用300行代码做一个贪吃蛇游戏</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/28%EF%BD%9CNom%EF%BC%9A%E7%94%A8Rust%E5%86%99%E4%B8%80%E4%B8%AAParser%E8%A7%A3%E6%9E%90%E5%99%A8" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>28｜Nom：用Rust写一个Parser解析器</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/29%EF%BD%9CUnsafe%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9AUnsafeRust%E4%B8%AD%E9%82%A3%E4%BA%9B%E8%A2%AB%E5%B0%81%E5%8D%B0%E7%9A%84%E8%83%BD%E5%8A%9B" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>29｜Unsafe编程（上）：UnsafeRust中那些被封印的能力</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/30%EF%BD%9CUnsafe%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%8B%EF%BC%89%EF%BC%9A%E4%BD%BF%E7%94%A8Rust%E4%B8%BAPython%E5%86%99%E4%B8%80%E4%B8%AA%E6%89%A9%E5%B1%95" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>30｜Unsafe编程（下）：使用Rust为Python写一个扩展</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/%E7%AD%94%E7%96%91%E8%AF%BE%E5%A0%82%EF%BC%88%E4%B8%89%EF%BC%89%EF%BD%9C%E7%AC%AC%E4%B8%89%E7%AB%A0Rust%E5%BA%94%E7%94%A8%E7%AF%87%E6%80%9D%E8%80%83%E9%A2%98%E7%AD%94%E6%A1%88" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>答疑课堂（三）｜第三章Rust应用篇思考题答案</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/%E7%BB%93%E8%AF%BE%E6%B5%8B%E8%AF%95%EF%BD%9C%E6%9D%A5%E8%B5%B4%E4%B8%80%E5%9C%BA%E6%BB%A1%E5%88%86%E4%B9%8B%E7%BA%A6" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>结课测试｜来赴一场满分之约</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/%E7%BB%93%E6%9D%9F%E8%AF%AD%EF%BD%9C%E6%9C%AA%E6%9D%A5%E8%AE%A9Rust%E5%B8%A6%E4%BD%A0%E2%80%9C%E9%94%88%E2%80%9D%E5%88%B0%E8%B5%B7%E9%A3%9E" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>结束语｜未来让Rust带你“锈”到起飞</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-5d98c3a5 data-v-1428d186><div class="VPDoc has-sidebar has-aside" data-v-1428d186 data-v-39a288b8><!--[--><!--]--><div class="container" data-v-39a288b8><div class="aside" data-v-39a288b8><div class="aside-curtain" data-v-39a288b8></div><div class="aside-container" data-v-39a288b8><div class="aside-content" data-v-39a288b8><div class="VPDocAside" data-v-39a288b8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-3f215769 data-v-a5bbad30><div class="content" data-v-a5bbad30><div class="outline-marker" data-v-a5bbad30></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-a5bbad30>⚡️文档内容大纲</div><ul class="VPDocOutlineItem root" data-v-a5bbad30 data-v-b933a997><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-39a288b8><div class="content-container" data-v-39a288b8><!--[--><!--]--><main class="main" data-v-39a288b8><div style="position:relative;" class="vp-doc _tanggang_rust_Document_15%EF%BD%9Ctokio%E7%BC%96%E7%A8%8B%EF%BC%9A%E5%9C%A8%E5%A4%9A%E4%BB%BB%E5%8A%A1%E4%B9%8B%E9%97%B4%E6%93%8D%E4%BD%9C%E5%90%8C%E4%B8%80%E7%89%87%E6%95%B0%E6%8D%AE" data-v-39a288b8><div><h1 id="_15-tokio-编程-在多任务之间操作同一片数据" tabindex="-1">15 ｜ tokio 编程：在多任务之间操作同一片数据 <a class="header-anchor" href="#_15-tokio-编程-在多任务之间操作同一片数据" aria-label="Permalink to &quot;15 ｜ tokio 编程：在多任务之间操作同一片数据&quot;">​</a></h1><p>你好，我是 Mike。今天我们一起来学习如何在 tokio 的多个任务之间共享同一片数据。</p><p>并发任务之间如何共享数据是一个非常重要的课题，在所有语言中都会碰到。不同的语言提供的方案支持不尽相同，比如 Erlang 语言默认只提供消息模型，Golang 也推荐使用 channel 来在并发任务之间进行同步。</p><p>Rust 语言考虑到其应用领域的广泛性和多样性，提供了多种机制来达到这一目的，需要我们根据不同的场景自行选择最合适的机制。所以相对来说，Rust 在这方面要学的知识点要多一些，好处是它在几乎所有场景中都能做到最好。</p><h2 id="任务目标" tabindex="-1">任务目标 <a class="header-anchor" href="#任务目标" aria-label="Permalink to &quot;任务目标&quot;">​</a></h2><p>定义一个内存数据库 db，在不同的子任务中，并发地向这个内存数据库更新数据。</p><h2 id="潜在问题" tabindex="-1">潜在问题 <a class="header-anchor" href="#潜在问题" aria-label="Permalink to &quot;潜在问题&quot;">​</a></h2><p>为了简化问题，我们把 <code>Vec&lt;u32&gt;</code> 当作 db。比如这个 db 中现在有 10 个数据。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> db</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Vec</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> vec!</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">3</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">5</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">6</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">7</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">8</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">9</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">10</span><span style="color:#ABB2BF;">];</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>现在有两个任务 task_a 和 task_b，它们都想更新 db 里的第 5 个元素的数据 db[4]。</p><p>task_a 想把它更新成 50，task_b 想把它更新成 100。这两个任务之间是没有协同机制的，也就是互相不知道对方的存在，更不知道对方要干嘛。于是就可能出现这样的情况，两个任务几乎同时发起更新请求，假如 task_a 领先一点点时间，先把 db[4] 更新成 50 了，但是它得校验一下更新正确了没有，所以它得发起一个索引请求，把 db[4] 的数据取出来看看是不是 50。</p><p>但是在 task_a 去检查 db[4] 的值之前极小的一个时间片段里面，task_b 对 db[4]更新操作也发生了，于是 db[4] 被更新成了 100。然后 task_a 取回值之后，发现值是 100。很奇怪，并且判断自己没有更新成功这个数据，有可能会再更新一次，再次把 db[4] 置为 50。这又可能对 task_b 的校验机制造成干扰。于是整个系统就开始紊乱了。</p><p>这就是多个任务操作共享数据可能会发生的问题。下面我们看看在 Rust 中怎么去解决这个问题。</p><h2 id="方案尝试" tabindex="-1">方案尝试 <a class="header-anchor" href="#方案尝试" aria-label="Permalink to &quot;方案尝试&quot;">​</a></h2><p>我们可以先从最简单的思路开始，设计如下方案。</p><h3 id="方案一-全局变量" tabindex="-1">方案一：全局变量 <a class="header-anchor" href="#方案一-全局变量" aria-label="Permalink to &quot;方案一：全局变量&quot;">​</a></h3><p>如果你有其他语言编程经验的话，应该很容易就能想到一个方案，就是利用全局变量来实现多个任务的数据共享。假如我们有一个全局变量 DB，为 <code>Vec&lt;u32&gt;</code> 类型，每个任务都可以访问到这个 DB，并可以向里面 push 数据。</p><p>我们先来试试直接在 main 函数里对这个 DB 全局变量进行操作。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">static</span><span style="color:#D19A66;"> DB</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Vec</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Vec</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">new</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#D19A66;">    DB</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">push</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">10</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>发现不行，编译会报错：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">error</span><span style="color:#ABB2BF;">[</span><span style="color:#E5C07B;">E0596</span><span style="color:#ABB2BF;">]: </span><span style="color:#E06C75;">cannot</span><span style="color:#E06C75;"> borrow</span><span style="color:#E06C75;"> immutable</span><span style="color:#C678DD;"> static</span><span style="color:#E06C75;"> item</span><span style="color:#ABB2BF;"> `</span><span style="color:#D19A66;">DB</span><span style="color:#ABB2BF;">` </span><span style="color:#C678DD;">as</span><span style="color:#E06C75;"> mutable</span></span>
<span class="line"><span style="color:#ABB2BF;"> --&gt; </span><span style="color:#E06C75;">src</span><span style="color:#ABB2BF;">/</span><span style="color:#E06C75;">main</span><span style="color:#ABB2BF;">.rs:</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">:</span><span style="color:#D19A66;">5</span></span>
<span class="line"><span style="color:#56B6C2;">  |</span></span>
<span class="line"><span style="color:#D19A66;">4</span><span style="color:#56B6C2;"> |</span><span style="color:#D19A66;">     DB</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">push</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">10</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#56B6C2;">  |</span><span style="color:#56B6C2;">     ^^^^^^^^^^^</span><span style="color:#E06C75;"> cannot</span><span style="color:#E06C75;"> borrow</span><span style="color:#C678DD;"> as</span><span style="color:#E06C75;"> mutable</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>可能是没加 mut？加上试一试。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">static</span><span style="color:#C678DD;"> mut</span><span style="color:#D19A66;"> DB</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Vec</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Vec</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">new</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#D19A66;">    DB</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">push</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">10</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>还是出错：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">error</span><span style="color:#ABB2BF;">[</span><span style="color:#E5C07B;">E0133</span><span style="color:#ABB2BF;">]: </span><span style="color:#C678DD;">use</span><span style="color:#ABB2BF;"> of mutable </span><span style="color:#C678DD;">static</span><span style="color:#ABB2BF;"> is </span><span style="color:#C678DD;">unsafe</span><span style="color:#ABB2BF;"> and requires </span><span style="color:#C678DD;">unsafe</span><span style="color:#ABB2BF;"> function or block</span></span>
<span class="line"><span style="color:#ABB2BF;"> --&gt; src/main.rs:4:5</span></span>
<span class="line"><span style="color:#56B6C2;">  |</span></span>
<span class="line"><span style="color:#ABB2BF;">4 </span><span style="color:#56B6C2;">|</span><span style="color:#E5C07B;">     DB</span><span style="color:#ABB2BF;">.push(10);</span></span>
<span class="line"><span style="color:#56B6C2;">  |</span><span style="color:#56B6C2;">     ^^^^^^^^^^^</span><span style="color:#C678DD;"> use</span><span style="color:#ABB2BF;"> of mutable </span><span style="color:#C678DD;">static</span></span>
<span class="line"><span style="color:#56B6C2;">  |</span></span>
<span class="line"><span style="color:#56B6C2;">  =</span><span style="color:#ABB2BF;"> note: mutable statics can be mutated by multiple threads: aliasing violations or data races will cause undefined behavior</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Rust 编译器报错说，要使用可变的静态全局变量是不安全的，需要用到 unsafe 功能。unsafe 功能我们还没讲，而且不是这节课的重点，所以这里不展开。总之， <strong>Rust 不推荐我们使用全局（静态）变量</strong>。因为全局变量不是一个好的方案，特别是对于多任务并发程序来说，应该尽可能避免。</p><p>那既然全局变量不能用了，有一个可行的选择是，在 main 函数中创建一个对象实例，把这个实例传给各个任务。因为这个实例是在 main 函数中创建的，它的生命期跟 main 函数一样长，所以也相当于全局变量了。</p><h3 id="方案二-main-函数中的对象" tabindex="-1">方案二：main 函数中的对象 <a class="header-anchor" href="#方案二-main-函数中的对象" aria-label="Permalink to &quot;方案二：main 函数中的对象&quot;">​</a></h3><p>稍微改一下上面的代码，这下可以了。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> db</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Vec</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> vec!</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">3</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">5</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">6</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">7</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">8</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">9</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">10</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"><span style="color:#E06C75;">    db</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">] </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 50</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>下面我们尝试在 main 函数中创建一个 tokio 任务。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">#[tokio::main]</span></span>
<span class="line"><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> fn</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> db</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Vec</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> vec!</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">3</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">5</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">6</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">7</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">8</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">9</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">10</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> task_a</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> tokio</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">task</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">spawn</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">async</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">        db</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">] </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 50</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    });</span></span>
<span class="line"><span style="color:#E06C75;">    _</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> task_a</span><span style="color:#ABB2BF;">.</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unwrap</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">    println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;{:?}&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">db</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这是一段稀松平常的代码，目的就是起一个 task，更新一下 Vec 里的元素，然后等待这个任务结束，打印这个 Vec 的值。但是，在 Rust 中，这段代码无法通过，Rust 编译器会报错。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">error</span><span style="color:#ABB2BF;">[</span><span style="color:#E5C07B;">E0373</span><span style="color:#ABB2BF;">]: </span><span style="color:#C678DD;">async</span><span style="color:#E06C75;"> block</span><span style="color:#E06C75;"> may</span><span style="color:#E06C75;"> outlive</span><span style="color:#E06C75;"> the</span><span style="color:#E06C75;"> current</span><span style="color:#E06C75;"> function</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">but</span><span style="color:#E06C75;"> it</span><span style="color:#E06C75;"> borrows</span><span style="color:#ABB2BF;"> `</span><span style="color:#E06C75;">db</span><span style="color:#ABB2BF;">`, </span><span style="color:#E06C75;">which</span><span style="color:#E06C75;"> is</span><span style="color:#E06C75;"> owned</span><span style="color:#E06C75;"> by</span><span style="color:#E06C75;"> the</span><span style="color:#E06C75;"> current</span><span style="color:#E06C75;"> function</span></span>
<span class="line"><span style="color:#ABB2BF;"> --&gt; </span><span style="color:#E06C75;">src</span><span style="color:#ABB2BF;">/</span><span style="color:#E06C75;">main</span><span style="color:#ABB2BF;">.rs:</span><span style="color:#D19A66;">5</span><span style="color:#ABB2BF;">:</span><span style="color:#D19A66;">37</span></span>
<span class="line"><span style="color:#56B6C2;">  |</span></span>
<span class="line"><span style="color:#D19A66;">5</span><span style="color:#56B6C2;"> |</span><span style="color:#C678DD;">       let</span><span style="color:#E06C75;"> task_a</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> tokio</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">task</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">spawn</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">async</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#56B6C2;">  |</span><span style="color:#E06C75;">  _____________________________________</span><span style="color:#56B6C2;">^</span></span>
<span class="line"><span style="color:#D19A66;">6</span><span style="color:#56B6C2;"> |</span><span style="color:#56B6C2;"> |</span><span style="color:#E06C75;">         db</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">] </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 50</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#56B6C2;">  |</span><span style="color:#56B6C2;"> |</span><span style="color:#ABB2BF;">         -- `</span><span style="color:#E06C75;">db</span><span style="color:#ABB2BF;">` </span><span style="color:#E06C75;">is</span><span style="color:#E06C75;"> borrowed</span><span style="color:#E06C75;"> here</span></span>
<span class="line"><span style="color:#D19A66;">7</span><span style="color:#56B6C2;"> |</span><span style="color:#56B6C2;"> |</span><span style="color:#ABB2BF;">     });</span></span>
<span class="line"><span style="color:#56B6C2;">  |</span><span style="color:#56B6C2;"> |</span><span style="color:#E06C75;">_____</span><span style="color:#56B6C2;">^</span><span style="color:#E06C75;"> may</span><span style="color:#E06C75;"> outlive</span><span style="color:#E06C75;"> borrowed</span><span style="color:#E06C75;"> value</span><span style="color:#ABB2BF;"> `</span><span style="color:#E06C75;">db</span><span style="color:#ABB2BF;">`</span></span>
<span class="line"><span style="color:#56B6C2;">  |</span></span>
<span class="line"><span style="color:#56B6C2;">  =</span><span style="color:#E06C75;"> note</span><span style="color:#ABB2BF;">: </span><span style="color:#C678DD;">async</span><span style="color:#E06C75;"> blocks</span><span style="color:#E06C75;"> are</span><span style="color:#E06C75;"> not</span><span style="color:#E06C75;"> executed</span><span style="color:#E06C75;"> immediately</span><span style="color:#E06C75;"> and</span><span style="color:#E06C75;"> must</span><span style="color:#E06C75;"> either</span><span style="color:#E06C75;"> take</span><span style="color:#E06C75;"> a</span><span style="color:#E06C75;"> reference</span><span style="color:#E06C75;"> or</span><span style="color:#E06C75;"> ownership</span><span style="color:#E06C75;"> of</span><span style="color:#E06C75;"> outside</span><span style="color:#E06C75;"> variables</span><span style="color:#E06C75;"> they</span><span style="color:#C678DD;"> use</span></span>
<span class="line"><span style="color:#ABB2BF;">help: to force the </span><span style="color:#C678DD;">async</span><span style="color:#ABB2BF;"> block to take ownership of `db` (and any other referenced variables), </span><span style="color:#C678DD;">use</span><span style="color:#ABB2BF;"> the `</span><span style="color:#C678DD;">move</span><span style="color:#ABB2BF;">` keyword</span></span>
<span class="line"><span style="color:#56B6C2;">  |</span></span>
<span class="line"><span style="color:#ABB2BF;">5 </span><span style="color:#56B6C2;">|</span><span style="color:#C678DD;">     let</span><span style="color:#ABB2BF;"> task_a </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> tokio</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">task</span><span style="color:#ABB2BF;">::spawn(</span><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> move</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#56B6C2;">  |</span><span style="color:#ABB2BF;">                                           ++++</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>我们来分析一下这个错误提示，错误提示第 1 行说，任何异步块都有可能超出当前函数的生存期，但是它里面依赖的 db 是在当前函数定义的，因此在异步块执行的时候，db 指向的对象有可能会消失，从而出错。你可能已经猜到了，错误原因跟所有权相关。原因是这个 task_a 运行的生存时间段，有可能超过 main task 生存的时间段，所以 task_a 里的 async 块中直接借用 main 函数中的局部变量 db 会有所有权相关风险。</p><p>不过这里还有一点疑问，我们不是在 main 中手动 <code>.await</code> 了吗？会等待这个子 task 的返回结果，但是 Rust 并没有分析到这一点。它可能会觉得你在 <code>task_a.await</code> 这一句之前其实是有机会将 db 给弄消失的，比如手动 <code>drop()</code> 掉这个 db，或者说调用了什么别的函数，把 db 的所有权在那里给消耗了。</p><p>它在错误信息第 12 行建议我们在 async 后加 move 修饰符，这样指明强制将 db 的所有权移动进 task_里去。我们按照建议修改一下。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">#[tokio::main]</span></span>
<span class="line"><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> fn</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> db</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Vec</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> vec!</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">3</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">5</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">6</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">7</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">8</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">9</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">10</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> task_a</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> tokio</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">task</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">spawn</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> move</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">        db</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">] </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 50</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    });</span></span>
<span class="line"><span style="color:#E06C75;">    _</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> task_a</span><span style="color:#ABB2BF;">.</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unwrap</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">    println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;{:?}&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">db</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>仍然编译出错，报错信息换了。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">error</span><span style="color:#ABB2BF;">[</span><span style="color:#E5C07B;">E0382</span><span style="color:#ABB2BF;">]: </span><span style="color:#E06C75;">borrow</span><span style="color:#E06C75;"> of</span><span style="color:#E06C75;"> moved</span><span style="color:#E06C75;"> value</span><span style="color:#ABB2BF;">: `</span><span style="color:#E06C75;">db</span><span style="color:#ABB2BF;">`</span></span>
<span class="line"><span style="color:#ABB2BF;">  --&gt; </span><span style="color:#E06C75;">src</span><span style="color:#ABB2BF;">/</span><span style="color:#E06C75;">main</span><span style="color:#ABB2BF;">.rs:</span><span style="color:#D19A66;">10</span><span style="color:#ABB2BF;">:</span><span style="color:#D19A66;">22</span></span>
<span class="line"><span style="color:#56B6C2;">   |</span></span>
<span class="line"><span style="color:#D19A66;">3</span><span style="color:#56B6C2;">  |</span><span style="color:#C678DD;">       let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> db</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Vec</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> vec!</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">3</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">5</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">6</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">7</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">8</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">9</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">10</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"><span style="color:#56B6C2;">   |</span><span style="color:#ABB2BF;">           ------ </span><span style="color:#C678DD;">move</span><span style="color:#E06C75;"> occurs</span><span style="color:#E06C75;"> because</span><span style="color:#ABB2BF;"> `</span><span style="color:#E06C75;">db</span><span style="color:#ABB2BF;">` </span><span style="color:#E06C75;">has</span><span style="color:#C678DD;"> type</span><span style="color:#ABB2BF;"> `</span><span style="color:#E5C07B;">Vec</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt;`, </span><span style="color:#E06C75;">which</span><span style="color:#E06C75;"> does</span><span style="color:#E06C75;"> not</span><span style="color:#E06C75;"> implement</span><span style="color:#E06C75;"> the</span><span style="color:#ABB2BF;"> `</span><span style="color:#E5C07B;">Copy</span><span style="color:#ABB2BF;">` </span><span style="color:#C678DD;">trait</span></span>
<span class="line"><span style="color:#D19A66;">4</span><span style="color:#56B6C2;">  |</span></span>
<span class="line"><span style="color:#D19A66;">5</span><span style="color:#56B6C2;">  |</span><span style="color:#C678DD;">       let</span><span style="color:#E06C75;"> task_a</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> tokio</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">task</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">spawn</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> move</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#56B6C2;">   |</span><span style="color:#E06C75;">  _____________________________________</span><span style="color:#ABB2BF;">-</span></span>
<span class="line"><span style="color:#D19A66;">6</span><span style="color:#56B6C2;">  |</span><span style="color:#56B6C2;"> |</span><span style="color:#E06C75;">         db</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">] </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 50</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#56B6C2;">   |</span><span style="color:#56B6C2;"> |</span><span style="color:#ABB2BF;">         -- </span><span style="color:#E06C75;">variable</span><span style="color:#E06C75;"> moved</span><span style="color:#E06C75;"> due</span><span style="color:#E06C75;"> to</span><span style="color:#C678DD;"> use</span><span style="color:#C678DD;"> in</span><span style="color:#E06C75;"> generator</span></span>
<span class="line"><span style="color:#D19A66;">7</span><span style="color:#56B6C2;">  |</span><span style="color:#56B6C2;"> |</span><span style="color:#ABB2BF;">     });</span></span>
<span class="line"><span style="color:#56B6C2;">   |</span><span style="color:#56B6C2;"> |</span><span style="color:#E06C75;">_____</span><span style="color:#ABB2BF;">- </span><span style="color:#E06C75;">value</span><span style="color:#E06C75;"> moved</span><span style="color:#E06C75;"> here</span></span>
<span class="line"><span style="color:#ABB2BF;">...</span></span>
<span class="line"><span style="color:#D19A66;">10</span><span style="color:#56B6C2;"> |</span><span style="color:#61AFEF;">       println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;{:?}&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">db</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#56B6C2;">   |</span><span style="color:#56B6C2;">                        ^^</span><span style="color:#E06C75;"> value</span><span style="color:#E06C75;"> borrowed</span><span style="color:#E06C75;"> here</span><span style="color:#E06C75;"> after</span><span style="color:#C678DD;"> move</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>它说，db 已经被移动到了 task_a 里了，所以在 main 函数中访问不到。这种严苛性，对于从其他语言过来的新手来说，确实令人崩溃。不过反过来想想 Rust 确实把细节抠得很死，这也是它比其他语言安全的原因。</p><p>那么我们就听小助手的话，不在 main 函数中打印了。这样确实能编译通过。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">#[tokio::main]</span></span>
<span class="line"><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> fn</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> db</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Vec</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> vec!</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">3</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">5</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">6</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">7</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">8</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">9</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">10</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> task_a</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> tokio</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">task</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">spawn</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> move</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">        db</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">] </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 50</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    });</span></span>
<span class="line"><span style="color:#E06C75;">    _</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> task_a</span><span style="color:#ABB2BF;">.</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unwrap</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>第一步走通了，下一步我们要测试多任务并发的情况，所以我们需要再增加一个任务。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> tokio</span><span style="color:#ABB2BF;">::task;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">#[tokio::main]</span></span>
<span class="line"><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> fn</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> db</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Vec</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> vec!</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">3</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">5</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">6</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">7</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">8</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">9</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">10</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> task_a</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> task</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">spawn</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> move</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">        db</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">] </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 50</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    });</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> task_b</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> task</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">spawn</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> move</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">        db</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">] </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 100</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    });</span></span>
<span class="line"><span style="color:#E06C75;">    _</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> task_a</span><span style="color:#ABB2BF;">.</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unwrap</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E06C75;">    _</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> task_b</span><span style="color:#ABB2BF;">.</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unwrap</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>这种写法明显会有问题，我们甚至不需要编译就可以知道，因为出现了两次 async move 块。如果你是一步步学过来的话，应该知道，db 在第一个 async move 时已经被移动进 task_a 了，后面不可能再移动进 task_b。</p><p>编译验证后，确实如此。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">error</span><span style="color:#ABB2BF;">[</span><span style="color:#E5C07B;">E0382</span><span style="color:#ABB2BF;">]: </span><span style="color:#C678DD;">use</span><span style="color:#ABB2BF;"> of moved value: `db`</span></span>
<span class="line"><span style="color:#ABB2BF;">  --&gt; src/main.rs:10:30</span></span>
<span class="line"><span style="color:#56B6C2;">   |</span></span>
<span class="line"><span style="color:#ABB2BF;">5  </span><span style="color:#56B6C2;">|</span><span style="color:#C678DD;">       let</span><span style="color:#C678DD;"> mut</span><span style="color:#ABB2BF;"> db: </span><span style="color:#E5C07B;">Vec</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> vec</span><span style="color:#56B6C2;">!</span><span style="color:#ABB2BF;">[1,2,3,4,5,6,7,8,9,10];</span></span>
<span class="line"><span style="color:#56B6C2;">   |</span><span style="color:#ABB2BF;">           ------ </span><span style="color:#C678DD;">move</span><span style="color:#E06C75;"> occurs</span><span style="color:#E06C75;"> because</span><span style="color:#ABB2BF;"> `</span><span style="color:#E06C75;">db</span><span style="color:#ABB2BF;">` </span><span style="color:#E06C75;">has</span><span style="color:#C678DD;"> type</span><span style="color:#ABB2BF;"> `</span><span style="color:#E5C07B;">Vec</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt;`, </span><span style="color:#E06C75;">which</span><span style="color:#E06C75;"> does</span><span style="color:#E06C75;"> not</span><span style="color:#E06C75;"> implement</span><span style="color:#E06C75;"> the</span><span style="color:#ABB2BF;"> `</span><span style="color:#E5C07B;">Copy</span><span style="color:#ABB2BF;">` </span><span style="color:#C678DD;">trait</span></span>
<span class="line"><span style="color:#D19A66;">6</span><span style="color:#56B6C2;">  |</span></span>
<span class="line"><span style="color:#D19A66;">7</span><span style="color:#56B6C2;">  |</span><span style="color:#C678DD;">       let</span><span style="color:#E06C75;"> task_a</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> task</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">spawn</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> move</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#56B6C2;">   |</span><span style="color:#E06C75;">  ______________________________</span><span style="color:#ABB2BF;">-</span></span>
<span class="line"><span style="color:#D19A66;">8</span><span style="color:#56B6C2;">  |</span><span style="color:#56B6C2;"> |</span><span style="color:#E06C75;">         db</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">] </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 50</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#56B6C2;">   |</span><span style="color:#56B6C2;"> |</span><span style="color:#ABB2BF;">         -- </span><span style="color:#E06C75;">variable</span><span style="color:#E06C75;"> moved</span><span style="color:#E06C75;"> due</span><span style="color:#E06C75;"> to</span><span style="color:#C678DD;"> use</span><span style="color:#C678DD;"> in</span><span style="color:#E06C75;"> generator</span></span>
<span class="line"><span style="color:#D19A66;">9</span><span style="color:#56B6C2;">  |</span><span style="color:#56B6C2;"> |</span><span style="color:#ABB2BF;">     });</span></span>
<span class="line"><span style="color:#56B6C2;">   |</span><span style="color:#56B6C2;"> |</span><span style="color:#E06C75;">_____</span><span style="color:#ABB2BF;">- </span><span style="color:#E06C75;">value</span><span style="color:#E06C75;"> moved</span><span style="color:#E06C75;"> here</span></span>
<span class="line"><span style="color:#D19A66;">10</span><span style="color:#56B6C2;"> |</span><span style="color:#C678DD;">       let</span><span style="color:#E06C75;"> task_b</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> task</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">spawn</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> move</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#56B6C2;">   |</span><span style="color:#E06C75;">  ______________________________</span><span style="color:#56B6C2;">^</span></span>
<span class="line"><span style="color:#D19A66;">11</span><span style="color:#56B6C2;"> |</span><span style="color:#56B6C2;"> |</span><span style="color:#E06C75;">         db</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">] </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 100</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#56B6C2;">   |</span><span style="color:#56B6C2;"> |</span><span style="color:#ABB2BF;">         -- </span><span style="color:#C678DD;">use</span><span style="color:#E06C75;"> occurs</span><span style="color:#E06C75;"> due</span><span style="color:#E06C75;"> to</span><span style="color:#C678DD;"> use</span><span style="color:#C678DD;"> in</span><span style="color:#E06C75;"> generator</span></span>
<span class="line"><span style="color:#D19A66;">12</span><span style="color:#56B6C2;"> |</span><span style="color:#56B6C2;"> |</span><span style="color:#ABB2BF;">     });</span></span>
<span class="line"><span style="color:#56B6C2;">   |</span><span style="color:#56B6C2;"> |</span><span style="color:#E06C75;">_____</span><span style="color:#56B6C2;">^</span><span style="color:#E06C75;"> value</span><span style="color:#E06C75;"> used</span><span style="color:#E06C75;"> here</span><span style="color:#E06C75;"> after</span><span style="color:#C678DD;"> move</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>那应该怎么办呢？</p><h3 id="方案三-利用-arc" tabindex="-1">方案三：利用 Arc <a class="header-anchor" href="#方案三-利用-arc" aria-label="Permalink to &quot;方案三：利用 Arc&quot;">​</a></h3><p>回想一下 <a href="https://time.geekbang.org/column/article/725815" target="_blank" rel="noreferrer">第 12 讲</a> 我们讲到过的 Arc 这个智能指针，它可以让多个持有者共享对同一资源的所有权。但是 Arc 也有一个巨大的限制，就是它无法修改被包裹的值。但不管怎样，我们还是碰碰运气，改动一下。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> std</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">sync</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">Arc</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">#[tokio::main]</span></span>
<span class="line"><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> fn</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> db</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Vec</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> vec!</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">3</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">5</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">6</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">7</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">8</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">9</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">10</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> arc_db</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> Arc</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">new</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">db</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> arc_db2</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> arc_db</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">clone</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> task_a</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> tokio</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">task</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">spawn</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> move</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">        arc_db</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">] </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 50</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    });</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> task_b</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> tokio</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">task</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">spawn</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> move</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;">        arc_db2</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">] </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 100</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    });</span></span>
<span class="line"><span style="color:#E06C75;">    _</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> task_a</span><span style="color:#ABB2BF;">.</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unwrap</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E06C75;">    _</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> task_b</span><span style="color:#ABB2BF;">.</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unwrap</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // println!(&quot;{:?}&quot;, db);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>不出所料，Rust 编译不通过，这说明通过 <code>Arc&lt;T&gt;</code> 没办法修改里面的值。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">error</span><span style="color:#ABB2BF;">[</span><span style="color:#E5C07B;">E0596</span><span style="color:#ABB2BF;">]: </span><span style="color:#E06C75;">cannot</span><span style="color:#E06C75;"> borrow</span><span style="color:#E06C75;"> data</span><span style="color:#C678DD;"> in</span><span style="color:#E06C75;"> an</span><span style="color:#ABB2BF;"> `</span><span style="color:#E5C07B;">Arc</span><span style="color:#ABB2BF;">` </span><span style="color:#C678DD;">as</span><span style="color:#E06C75;"> mutable</span></span>
<span class="line"><span style="color:#ABB2BF;">  --&gt; </span><span style="color:#E06C75;">src</span><span style="color:#ABB2BF;">/</span><span style="color:#E06C75;">main</span><span style="color:#ABB2BF;">.rs:</span><span style="color:#D19A66;">10</span><span style="color:#ABB2BF;">:</span><span style="color:#D19A66;">9</span></span>
<span class="line"><span style="color:#56B6C2;">   |</span></span>
<span class="line"><span style="color:#D19A66;">10</span><span style="color:#56B6C2;"> |</span><span style="color:#E06C75;">         arc_db</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">] </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 50</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#56B6C2;">   |</span><span style="color:#56B6C2;">         ^^^^^^</span><span style="color:#E06C75;"> cannot</span><span style="color:#E06C75;"> borrow</span><span style="color:#C678DD;"> as</span><span style="color:#E06C75;"> mutable</span></span>
<span class="line"><span style="color:#56B6C2;">   |</span></span>
<span class="line"><span style="color:#56B6C2;">   =</span><span style="color:#E06C75;"> help</span><span style="color:#ABB2BF;">: </span><span style="color:#C678DD;">trait</span><span style="color:#ABB2BF;"> `</span><span style="color:#E5C07B;">DerefMut</span><span style="color:#ABB2BF;">` </span><span style="color:#E06C75;">is</span><span style="color:#E06C75;"> required</span><span style="color:#E06C75;"> to</span><span style="color:#E06C75;"> modify</span><span style="color:#E06C75;"> through</span><span style="color:#E06C75;"> a</span><span style="color:#E06C75;"> dereference</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">but</span><span style="color:#E06C75;"> it</span><span style="color:#E06C75;"> is</span><span style="color:#E06C75;"> not</span><span style="color:#E06C75;"> implemented</span><span style="color:#C678DD;"> for</span><span style="color:#ABB2BF;"> `</span><span style="color:#E5C07B;">Arc</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">Vec</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt;&gt;`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75;">error</span><span style="color:#ABB2BF;">[</span><span style="color:#E5C07B;">E0596</span><span style="color:#ABB2BF;">]: </span><span style="color:#E06C75;">cannot</span><span style="color:#E06C75;"> borrow</span><span style="color:#E06C75;"> data</span><span style="color:#C678DD;"> in</span><span style="color:#E06C75;"> an</span><span style="color:#ABB2BF;"> `</span><span style="color:#E5C07B;">Arc</span><span style="color:#ABB2BF;">` </span><span style="color:#C678DD;">as</span><span style="color:#E06C75;"> mutable</span></span>
<span class="line"><span style="color:#ABB2BF;">  --&gt; </span><span style="color:#E06C75;">src</span><span style="color:#ABB2BF;">/</span><span style="color:#E06C75;">main</span><span style="color:#ABB2BF;">.rs:</span><span style="color:#D19A66;">13</span><span style="color:#ABB2BF;">:</span><span style="color:#D19A66;">9</span></span>
<span class="line"><span style="color:#56B6C2;">   |</span></span>
<span class="line"><span style="color:#D19A66;">13</span><span style="color:#56B6C2;"> |</span><span style="color:#E06C75;">         arc_db2</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">] </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 100</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#56B6C2;">   |</span><span style="color:#56B6C2;">         ^^^^^^^</span><span style="color:#E06C75;"> cannot</span><span style="color:#E06C75;"> borrow</span><span style="color:#C678DD;"> as</span><span style="color:#E06C75;"> mutable</span></span>
<span class="line"><span style="color:#56B6C2;">   |</span></span>
<span class="line"><span style="color:#56B6C2;">   =</span><span style="color:#E06C75;"> help</span><span style="color:#ABB2BF;">: </span><span style="color:#C678DD;">trait</span><span style="color:#ABB2BF;"> `</span><span style="color:#E5C07B;">DerefMut</span><span style="color:#ABB2BF;">` </span><span style="color:#E06C75;">is</span><span style="color:#E06C75;"> required</span><span style="color:#E06C75;"> to</span><span style="color:#E06C75;"> modify</span><span style="color:#E06C75;"> through</span><span style="color:#E06C75;"> a</span><span style="color:#E06C75;"> dereference</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">but</span><span style="color:#E06C75;"> it</span><span style="color:#E06C75;"> is</span><span style="color:#E06C75;"> not</span><span style="color:#E06C75;"> implemented</span><span style="color:#C678DD;"> for</span><span style="color:#ABB2BF;"> `</span><span style="color:#E5C07B;">Arc</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">Vec</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt;&gt;`</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>虽然现在我们的代码还是没有编译通过，但是思路是没问题的：要在并发的多个任务中，访问同一个资源，那么必然涉及到多所有权，所以使用 Arc 是完全没有问题的。现在的问题是， <strong>有没有办法更改被 Arc 包裹起来的值</strong>。</p><p>答案是有的，利用 Mutex 就可以。</p><h3 id="方案四-arc-mutex" tabindex="-1">方案四：Arc+Mutex <a class="header-anchor" href="#方案四-arc-mutex" aria-label="Permalink to &quot;方案四：Arc+Mutex&quot;">​</a></h3><p>一个多任务并发编程要修改同一个值，那必然要防止修改冲突，这就不得不用到计算机领域里一个常见的工具——锁。</p><p>Mutex 是一种互斥锁，被 Mutex 包裹住的对象，同时只能存在一个 reader 或一个 writer。使用的时候，要先获得 Mutex 锁，成功后，才能读或写这个锁里面的值。多个任务不能同时获得同一个 Mutex 锁，当一个任务持有 Mutex 锁时，其他任务会处于等待状态，直到那个任务用完了 Mutex 锁，并自动释放了它。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> std</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">sync</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">Arc</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> tokio</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">sync</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">Mutex</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">#[tokio::main]</span></span>
<span class="line"><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> fn</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> db</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Vec</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u32</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#61AFEF;"> vec!</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">3</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">5</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">6</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">7</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">8</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">9</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">10</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> arc_db</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> Arc</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">new</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Mutex</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">new</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">db</span><span style="color:#ABB2BF;">));  </span><span style="color:#7F848E;font-style:italic;">// 加锁</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> arc_db2</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> arc_db</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">clone</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> arc_db3</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> arc_db</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">clone</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> task_a</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> tokio</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">task</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">spawn</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> move</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">        let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> db</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> arc_db</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">lock</span><span style="color:#ABB2BF;">().</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">;  </span><span style="color:#7F848E;font-style:italic;">// 获取锁</span></span>
<span class="line"><span style="color:#E06C75;">        db</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">] </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 50</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">        assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">db</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">], </span><span style="color:#D19A66;">50</span><span style="color:#ABB2BF;">);             </span><span style="color:#7F848E;font-style:italic;">// 校验值</span></span>
<span class="line"><span style="color:#ABB2BF;">    });</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> task_b</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> tokio</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">task</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">spawn</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> move</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">        let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> db</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> arc_db2</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">lock</span><span style="color:#ABB2BF;">().</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">;  </span><span style="color:#7F848E;font-style:italic;">// 获取锁</span></span>
<span class="line"><span style="color:#E06C75;">        db</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">] </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 100</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">        assert_eq!</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">db</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">], </span><span style="color:#D19A66;">100</span><span style="color:#ABB2BF;">);            </span><span style="color:#7F848E;font-style:italic;">// 校验值</span></span>
<span class="line"><span style="color:#ABB2BF;">    });</span></span>
<span class="line"><span style="color:#E06C75;">    _</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> task_a</span><span style="color:#ABB2BF;">.</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unwrap</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E06C75;">    _</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> task_b</span><span style="color:#ABB2BF;">.</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unwrap</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">    println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;{:?}&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">arc_db3</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">lock</span><span style="color:#ABB2BF;">().</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">);  </span><span style="color:#7F848E;font-style:italic;">// 获取锁</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 输出</span></span>
<span class="line"><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">3</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">4</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">100</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">6</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">7</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">8</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">9</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">10</span><span style="color:#ABB2BF;">]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>加上 Mutex，这个例子就能顺利编译并运行通过了。</p><p>这个例子里的第 7 行，我们使用 <code>Arc::new(Mutex::new())</code> 组合把 db 包了两层，外层是 Arc，里层是 Mutex。然后，我们把 arc_db 克隆了两次，这种克隆只是增加 Arc 的引用计数，代价非常低。</p><p>然后在每次使用的时候，先通过 <code>arc_db.lock().await</code> 这种方式获得锁，再等待取出锁中对象的引用，这里也就是 Vec 的引用，然后通过这个引用去更新 db 的值。</p><p>利用 Arc 与 Mutex 的组合，我们还顺便解决了在 main task 不能打印这个 db 的问题。实际上，在 Rust 中， <code>Arc&lt;Mutex&lt;T&gt;&gt;</code> 是一对很常见的组合，利用它们的组合技术，基本上可以满足绝大部分的并发编程场景。</p><p>有了这两兄弟的加持，我们用 Rust 写业务代码就变得像 Java 一样高效、便捷。相对于 Go、Python 或 JavaScript 来说，Rust 的异步并发编程代码稍微有些繁琐，但是它的模式是非常固定的，最后这个示例里的模式可以无脑使用。正因为如此，Arc、Mutex 和 clone() 一起，被社区叫做“Rust 三板斧”，就是因为它们简单粗暴，方便好用。</p><p>到这里为止，我们已经解决了这节课开头提出的问题。</p><h2 id="其他锁" tabindex="-1">其他锁 <a class="header-anchor" href="#其他锁" aria-label="Permalink to &quot;其他锁&quot;">​</a></h2><p>除了 Mutex，tokio 里还提供了一些锁，我们来看一看。</p><h3 id="tokio-sync-rwlock" tabindex="-1">tokio::sync::RwLock <a class="header-anchor" href="#tokio-sync-rwlock" aria-label="Permalink to &quot;tokio::sync::RwLock&quot;">​</a></h3><p>RwLock 是读写锁。它和 Mutex 的区别是，Mutex 不论是读还是写，同时只有一个能拿到锁。比如，一个 task 在读，而另一个 task 也想读的时候，仍然需要等待第一个 task 先释放锁。所以在读比较多的情况下，Mutex 的运行效率不是太理想。</p><p>而 RwLock 的设计是，当一个任务拿的是读锁时，其他任务也能再拿到读锁，多个读锁之间可以同时存在。当一个任务想拿写锁的时候，必须等待其他所有读锁或写锁释放后才能拿到。</p><p>当一个任务拿到了写锁时，其他任务只能等待它完成后才能继续操作，不管其他任务是要写还是读。因此对于写来讲，RwLock 是排斥型访问；对于读来讲，RwLock 提供了共享访问。这一点与不可变引用和可变引用的关系特别像。</p><p>我们来看下面的示例：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> tokio</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">sync</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">RwLock</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">#[tokio::main]</span></span>
<span class="line"><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> fn</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> lock</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> RwLock</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">new</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">5</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 多个读锁可以同时存在</span></span>
<span class="line"><span style="color:#ABB2BF;">    {</span></span>
<span class="line"><span style="color:#C678DD;">        let</span><span style="color:#E06C75;"> r1</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> lock</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">read</span><span style="color:#ABB2BF;">().</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">        let</span><span style="color:#E06C75;"> r2</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> lock</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">read</span><span style="color:#ABB2BF;">().</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">        assert_eq!</span><span style="color:#ABB2BF;">(*</span><span style="color:#E06C75;">r1</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">5</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">        assert_eq!</span><span style="color:#ABB2BF;">(*</span><span style="color:#E06C75;">r2</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">5</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    } </span><span style="color:#7F848E;font-style:italic;">// 在这一句结束时，两个读锁都释放掉了</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 同时只能存在一个写锁</span></span>
<span class="line"><span style="color:#ABB2BF;">    {</span></span>
<span class="line"><span style="color:#C678DD;">        let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> w</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> lock</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">write</span><span style="color:#ABB2BF;">().</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">        *</span><span style="color:#E06C75;">w</span><span style="color:#56B6C2;"> +=</span><span style="color:#D19A66;"> 1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">        assert_eq!</span><span style="color:#ABB2BF;">(*</span><span style="color:#E06C75;">w</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">6</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    } </span><span style="color:#7F848E;font-style:italic;">// 在这一句结束时，写锁释放掉了</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>可以看到，RwLock 的使用非常简单，在读操作比写操作多很多的情况下，RwLock 的性能会比 Mutex 好很多。</p><p>Rust 标准库中还有一些用于简单类型的原子锁。</p><h3 id="std-sync-atomic" tabindex="-1">std::sync::atomic <a class="header-anchor" href="#std-sync-atomic" aria-label="Permalink to &quot;std::sync::atomic&quot;">​</a></h3><p>如果共享数据的只是一些简单的类型，比如 bool、i32、u8、usize 等等，就不需要使用 Mutex 或 RwLock 把这些类型包起来，比如像这样 <code>Arc&lt;Mutex&lt;u32&gt;&gt;</code>，可以直接用 Rust 标准库里提供的原子类型。 <code>std::sync::atomic</code> 这个模块下面提供了很多原子类型，比如 AtomicBool、AtomicI8、AtomicI16 等等。</p><p><code>Mutex&lt;u32&gt;</code> 对应的原子类型是 <code>std::sync::atomic::AtomicU32</code>。</p><p>像下面这样使用：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> std</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">sync</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">atomic</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">AtomicU32</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 创建</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> atomic_forty_two</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> AtomicU32</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">new</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">42</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> arc_data</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> Arc</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">new</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">atomic_forty_two</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> some_var</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> AtomicU32</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">new</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">10</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 更新</span></span>
<span class="line"><span style="color:#ABB2BF;">    *</span><span style="color:#E06C75;">some_var</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get_mut</span><span style="color:#ABB2BF;">() </span><span style="color:#56B6C2;">=</span><span style="color:#D19A66;"> 5</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">    assert_eq!</span><span style="color:#ABB2BF;">(*</span><span style="color:#E06C75;">some_var</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get_mut</span><span style="color:#ABB2BF;">(), </span><span style="color:#D19A66;">5</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>其他类型按类似的方式使用就可以了。原子类型之所以会单独提出来，是因为它是锁的基础，其他的锁会建立在这些基础原子类型之上，这些原子类型也可以充分利用硬件提供的关于原子操作的支持，从而提高应用的性能。</p><blockquote><p>注：在多核 CPU 中，常见的硬件支持原子操作的方法包括 CPU 中的缓存一致性协议、总线锁定等机制，可以使多个线程或进程同时对同一变量进行原子操作时，不会出现数据竞争和线程同步的问题。</p></blockquote><p>锁（lock）和无锁（lock-free）是计算机科学领域一个非常大的课题，Rust 有本书 <a href="https://marabos.nl/atomics/" target="_blank" rel="noreferrer">《Rust Atomics and Locks》</a> 专门讲这个，有兴趣的话你可以看一看。</p><h2 id="小结" tabindex="-1">小结 <a class="header-anchor" href="#小结" aria-label="Permalink to &quot;小结&quot;">​</a></h2><p>这节课我们通过一步步验证的方式，学习了在 Rust 和 tokio 中如何在多个任务中操作共享数据，经过多次被编译器拒绝的痛苦，最后我们得到了一个相当舒服的方案。这个方案可以供我们以后在做并发编程时使用，使用时的模式非常固定，没有什么心智负担。整个探索过程虽然比较辛苦，但是结果却是比较美好的。这也许就是 Rust 的学习过程吧，先苦后甜。</p><p>在整个探索过程中，我们也能深切体会 Rust 所有权模型在并发场景下发挥的重要作用。如果你想让程序编译通过，那么必须严格遵守 Rust 的所有权模型；一旦你在 Rust 的所有权指导下捣鼓出了并发代码，那么 <strong>你的并发代码就一定不会产生由于竞争条件而导致的概率性 Bug</strong>。</p><p>如果你有这方面的经验教训，你一定会特别憎恶这种概率性的 Bug，因为有可能仅仅是重现 Bug 现场就要花一个月的时间。同时，你会爱上 Rust，因为它从语言层面就帮我们杜绝了这种情况，让我们的线上服务特别稳定，晚上可以安心睡觉了。</p><h2 id="思考题" tabindex="-1">思考题 <a class="header-anchor" href="#思考题" aria-label="Permalink to &quot;思考题&quot;">​</a></h2><p>这节课代码里下面这两句的意义是什么，第一行会阻塞第二句吗？</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">    _</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> task_a</span><span style="color:#ABB2BF;">.</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unwrap</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E06C75;">    _</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> task_b</span><span style="color:#ABB2BF;">.</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unwrap</span><span style="color:#ABB2BF;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>希望你可以开动脑筋，认真思考，把你的答案分享到评论区，也欢迎你把这节课的内容分享给其他朋友，邀他们一起学习 Rust。好了，我们下节课再见吧！</p></div></div></main><footer class="VPDocFooter" data-v-39a288b8 data-v-e257564d><!--[--><!--]--><div class="edit-info" data-v-e257564d><div class="edit-link" data-v-e257564d><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/muyaCode/FrontEndLearnNotes/edit/main/docs/Document/15｜tokio编程：在多任务之间操作同一片数据.md" target="_blank" rel="noreferrer" data-v-e257564d><!--[--><span class="vpi-square-pen edit-link-icon" data-v-e257564d></span> 在 GitHub 上编辑此页<!--]--></a></div><div class="last-updated" data-v-e257564d><p class="VPLastUpdated" data-v-e257564d data-v-e98dd255>上次更新：: <time datetime="2025-02-28T18:19:24.000Z" data-v-e98dd255></time></p></div></div><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-e257564d><span class="visually-hidden" id="doc-footer-aria-label" data-v-e257564d>Pager</span><div class="pager" data-v-e257564d><a class="VPLink link pager-link prev" href="/tanggang_rust/Document/14%EF%BD%9Ctokio%E5%AE%9E%E6%88%98%EF%BC%9A%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E7%BD%91%E7%BB%9C%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%A8%8B%E5%BA%8F" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>上一篇</span><span class="title" data-v-e257564d>14｜tokio实战：编写一个网络命令行程序</span><!--]--></a></div><div class="pager" data-v-e257564d><a class="VPLink link pager-link next" href="/tanggang_rust/Document/16%EF%BD%9Ctokio%E7%BC%96%E7%A8%8B%EF%BC%9A%E4%BD%BF%E7%94%A8channel%E5%9C%A8%E4%B8%8D%E5%90%8C%E4%BB%BB%E5%8A%A1%E9%97%B4%E9%80%9A%E4%BF%A1%EF%BC%9F" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>下一篇</span><span class="title" data-v-e257564d>16｜tokio编程：使用channel在不同任务间通信？</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-5d98c3a5 data-v-e315a0ad><div class="container" data-v-e315a0ad><p class="message" data-v-e315a0ad>Released under the MIT License.</p><p class="copyright" data-v-e315a0ad>Copyright © 2025  MuYa</p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"document_00｜开篇词｜拥抱rust浪潮，迎接更极致的编程体验.md\":\"Bx6ruBRE\",\"document_01｜快速入门：rust中有哪些你不得不了解的基础语法？.md\":\"YEQ1UjRq\",\"document_02｜所有权（上）：rust是如何管理程序中的资源的？.md\":\"Bvb116GB\",\"document_03｜所有权（下）：rust中借用与引用的规则是怎样的？.md\":\"BJwhWwWd\",\"document_04｜字符串：对号入座，字符串其实没那么可怕！.md\":\"Bv5l_4z9\",\"document_05｜复合类型（上）：结构体与面向对象特性.md\":\"CITkKTJg\",\"document_06｜复合类型（下）：枚举与模式匹配.md\":\"Ct8Xedp7\",\"document_07｜类型与类型参数：给rust小助手提供更多信息.md\":\"EbjW2AkC\",\"document_08｜option-t-与result-t_e-、迭代器.md\":\"BNKn_0uw\",\"document_09｜初识trait：协议约束与能力配置.md\":\"llurKKcW\",\"document_10｜再探trait：带类型参数的trait及traitobject.md\":\"CMwHA5A-\",\"document_11｜常见trait解析：标准库中的常见trait应该怎么用？.md\":\"BGa5CpQf\",\"document_12｜智能指针：从所有权看智能指针.md\":\"Cxvwfxu6\",\"document_13｜独立王国：初步了解rust异步并发编程.md\":\"DSU5sdFT\",\"document_14｜tokio实战：编写一个网络命令行程序.md\":\"C1JeQOSl\",\"document_15｜tokio编程：在多任务之间操作同一片数据.md\":\"Bwzc0tpF\",\"document_16｜tokio编程：使用channel在不同任务间通信？.md\":\"DKrhaVoh\",\"document_17｜tokio编程：rust异步编程还有哪些需要注意的点？.md\":\"CmxLkup0\",\"document_18｜错误处理系统：错误的构建、传递和处理.md\":\"BWw-vDDL\",\"document_19｜rust的宏体系：为自己的项目写一个简单的声明宏.md\":\"DXluFKAD\",\"document_20｜生命周期：rust如何做基本的生命周期符号标注？.md\":\"Bt1xgIs6\",\"document_21｜web开发（上）：如何使用axum框架进行web后端开发？.md\":\"DXd_p46T\",\"document_22｜web开发（下）：如何实现一个todolist应用？.md\":\"Bi1r-Ulj\",\"document_23｜rust与大模型：用candle做一个聊天机器人.md\":\"CDaEmFi3\",\"document_24｜rust图像识别：利用yolov8识别对象.md\":\"CMFa5k75\",\"document_25｜rustgui编程：用slint为chatbot实现一个界面.md\":\"CSQiE64f\",\"document_26｜rustgui编程：用slint为yolov8实现一个界面.md\":\"8_AGledo\",\"document_27｜rustbevy游戏开发：用300行代码做一个贪吃蛇游戏.md\":\"DcZ-wJin\",\"document_28｜nom：用rust写一个parser解析器.md\":\"DtpKzSZI\",\"document_29｜unsafe编程（上）：unsaferust中那些被封印的能力.md\":\"DkGls-cm\",\"document_30｜unsafe编程（下）：使用rust为python写一个扩展.md\":\"tPXz85a6\",\"document_答疑课堂（一）｜第一章rust基础篇思考题答案.md\":\"CC_0mUbW\",\"document_答疑课堂（三）｜第三章rust应用篇思考题答案.md\":\"He3Na2GY\",\"document_答疑课堂（二）｜第二章rust进阶篇思考题答案.md\":\"rq96ZBKO\",\"document_结束语｜未来让rust带你“锈”到起飞.md\":\"CDoEtXUj\",\"document_结课测试｜来赴一场满分之约.md\":\"BDMdH3Zr\",\"index.md\":\"ZlsnMKnR\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh\",\"dir\":\"ltr\",\"title\":\"唐刚-Rust语言从入门到实战\",\"description\":\"Rust语言从入门到实战\",\"base\":\"/tanggang_rust/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"logo\":\"/img/buding.svg\",\"siteTitle\":\"Rust语言从入门到实战\",\"outlineTitle\":\"⚡️文档内容大纲\",\"outline\":\"deep\",\"search\":{\"provider\":\"local\",\"options\":{\"locales\":{\"root\":{\"translations\":{\"button\":{\"buttonText\":\"搜索文档\",\"buttonAriaLabel\":\"搜索文档\"},\"modal\":{\"noResultsText\":\"无法找到相关结果\",\"displayDetails\":\"显示详细信息\",\"resetButtonTitle\":\"清除查询条件\",\"backButtonTitle\":\"返回搜索结果\",\"footer\":{\"selectText\":\"选择\",\"selectKeyAriaLabel\":\"enter\",\"navigateText\":\"切换\",\"navigateUpKeyAriaLabel\":\"up arrow\",\"navigateDownKeyAriaLabel\":\"down arrow\",\"closeText\":\"关闭\",\"closeKeyAriaLabel\":\"escape\"}}}}},\"miniSearch\":{\"options\":{},\"searchOptions\":{}}}},\"sidebar\":{\"/\":[{\"text\":\"00｜开篇词｜拥抱Rust浪潮，迎接更极致的编程体验\",\"link\":\"/Document/00｜开篇词｜拥抱Rust浪潮，迎接更极致的编程体验\"},{\"text\":\"01｜快速入门：Rust中有哪些你不得不了解的基础语法？\",\"link\":\"/Document/01｜快速入门：Rust中有哪些你不得不了解的基础语法？\"},{\"text\":\"02｜所有权（上）：Rust是如何管理程序中的资源的？\",\"link\":\"/Document/02｜所有权（上）：Rust是如何管理程序中的资源的？\"},{\"text\":\"03｜所有权（下）：Rust中借用与引用的规则是怎样的？\",\"link\":\"/Document/03｜所有权（下）：Rust中借用与引用的规则是怎样的？\"},{\"text\":\"04｜字符串：对号入座，字符串其实没那么可怕！\",\"link\":\"/Document/04｜字符串：对号入座，字符串其实没那么可怕！\"},{\"text\":\"05｜复合类型（上）：结构体与面向对象特性\",\"link\":\"/Document/05｜复合类型（上）：结构体与面向对象特性\"},{\"text\":\"06｜复合类型（下）：枚举与模式匹配\",\"link\":\"/Document/06｜复合类型（下）：枚举与模式匹配\"},{\"text\":\"07｜类型与类型参数：给Rust小助手提供更多信息\",\"link\":\"/Document/07｜类型与类型参数：给Rust小助手提供更多信息\"},{\"text\":\"08｜Option-T-与Result-T,E-、迭代器\",\"link\":\"/Document/08｜Option-T-与Result-T,E-、迭代器\"},{\"text\":\"09｜初识trait：协议约束与能力配置\",\"link\":\"/Document/09｜初识trait：协议约束与能力配置\"},{\"text\":\"10｜再探trait：带类型参数的trait及traitobject\",\"link\":\"/Document/10｜再探trait：带类型参数的trait及traitobject\"},{\"text\":\"11｜常见trait解析：标准库中的常见trait应该怎么用？\",\"link\":\"/Document/11｜常见trait解析：标准库中的常见trait应该怎么用？\"},{\"text\":\"答疑课堂（一）｜第一章Rust基础篇思考题答案\",\"link\":\"/Document/答疑课堂（一）｜第一章Rust基础篇思考题答案\"},{\"text\":\"12｜智能指针：从所有权看智能指针\",\"link\":\"/Document/12｜智能指针：从所有权看智能指针\"},{\"text\":\"13｜独立王国：初步了解Rust异步并发编程\",\"link\":\"/Document/13｜独立王国：初步了解Rust异步并发编程\"},{\"text\":\"14｜tokio实战：编写一个网络命令行程序\",\"link\":\"/Document/14｜tokio实战：编写一个网络命令行程序\"},{\"text\":\"15｜tokio编程：在多任务之间操作同一片数据\",\"link\":\"/Document/15｜tokio编程：在多任务之间操作同一片数据\"},{\"text\":\"16｜tokio编程：使用channel在不同任务间通信？\",\"link\":\"/Document/16｜tokio编程：使用channel在不同任务间通信？\"},{\"text\":\"17｜tokio编程：Rust异步编程还有哪些需要注意的点？\",\"link\":\"/Document/17｜tokio编程：Rust异步编程还有哪些需要注意的点？\"},{\"text\":\"18｜错误处理系统：错误的构建、传递和处理\",\"link\":\"/Document/18｜错误处理系统：错误的构建、传递和处理\"},{\"text\":\"19｜Rust的宏体系：为自己的项目写一个简单的声明宏\",\"link\":\"/Document/19｜Rust的宏体系：为自己的项目写一个简单的声明宏\"},{\"text\":\"20｜生命周期：Rust如何做基本的生命周期符号标注？\",\"link\":\"/Document/20｜生命周期：Rust如何做基本的生命周期符号标注？\"},{\"text\":\"答疑课堂（二）｜第二章Rust进阶篇思考题答案\",\"link\":\"/Document/答疑课堂（二）｜第二章Rust进阶篇思考题答案\"},{\"text\":\"21｜Web开发（上）：如何使用Axum框架进行Web后端开发？\",\"link\":\"/Document/21｜Web开发（上）：如何使用Axum框架进行Web后端开发？\"},{\"text\":\"22｜Web开发（下）：如何实现一个TodoList应用？\",\"link\":\"/Document/22｜Web开发（下）：如何实现一个TodoList应用？\"},{\"text\":\"23｜Rust与大模型：用Candle做一个聊天机器人\",\"link\":\"/Document/23｜Rust与大模型：用Candle做一个聊天机器人\"},{\"text\":\"24｜Rust图像识别：利用YOLOv8识别对象\",\"link\":\"/Document/24｜Rust图像识别：利用YOLOv8识别对象\"},{\"text\":\"25｜RustGUI编程：用Slint为Chatbot实现一个界面\",\"link\":\"/Document/25｜RustGUI编程：用Slint为Chatbot实现一个界面\"},{\"text\":\"26｜RustGUI编程：用Slint为YOLOv8实现一个界面\",\"link\":\"/Document/26｜RustGUI编程：用Slint为YOLOv8实现一个界面\"},{\"text\":\"27｜RustBevy游戏开发：用300行代码做一个贪吃蛇游戏\",\"link\":\"/Document/27｜RustBevy游戏开发：用300行代码做一个贪吃蛇游戏\"},{\"text\":\"28｜Nom：用Rust写一个Parser解析器\",\"link\":\"/Document/28｜Nom：用Rust写一个Parser解析器\"},{\"text\":\"29｜Unsafe编程（上）：UnsafeRust中那些被封印的能力\",\"link\":\"/Document/29｜Unsafe编程（上）：UnsafeRust中那些被封印的能力\"},{\"text\":\"30｜Unsafe编程（下）：使用Rust为Python写一个扩展\",\"link\":\"/Document/30｜Unsafe编程（下）：使用Rust为Python写一个扩展\"},{\"text\":\"答疑课堂（三）｜第三章Rust应用篇思考题答案\",\"link\":\"/Document/答疑课堂（三）｜第三章Rust应用篇思考题答案\"},{\"text\":\"结课测试｜来赴一场满分之约\",\"link\":\"/Document/结课测试｜来赴一场满分之约\"},{\"text\":\"结束语｜未来让Rust带你“锈”到起飞\",\"link\":\"/Document/结束语｜未来让Rust带你“锈”到起飞\"}]},\"editLink\":{\"pattern\":\"https://github.com/muyaCode/FrontEndLearnNotes/edit/main/docs/:path\",\"text\":\"在 GitHub 上编辑此页\"},\"lastUpdated\":{\"text\":\"上次更新：\",\"formatOptions\":{\"dateStyle\":\"full\",\"timeStyle\":\"medium\"}},\"docFooter\":{\"prev\":\"上一篇\",\"next\":\"下一篇\"},\"footer\":{\"message\":\"Released under the MIT License.\",\"copyright\":\"Copyright © 2025  MuYa\"}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":true}");</script>
    
  </body>
</html>