<!DOCTYPE html>
<html lang="zh" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>14 ｜ tokio 实战：编写一个网络命令行程序 | 唐刚-Rust语言从入门到实战</title>
    <meta name="description" content="Rust语言从入门到实战">
    <meta name="generator" content="VitePress v1.6.3">
    <link rel="preload stylesheet" href="/tanggang_rust/assets/style.Dmb1gw5t.css" as="style">
    <link rel="preload stylesheet" href="/tanggang_rust/vp-icons.css" as="style">
    
    <script type="module" src="/tanggang_rust/assets/app.DakBAcEX.js"></script>
    <link rel="preload" href="/tanggang_rust/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/tanggang_rust/assets/chunks/theme.BYwnybAk.js">
    <link rel="modulepreload" href="/tanggang_rust/assets/chunks/framework.D2WelYEY.js">
    <link rel="modulepreload" href="/tanggang_rust/assets/Document_14｜tokio实战：编写一个网络命令行程序.md.C1JeQOSl.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-5d98c3a5><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0b0ada53></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0b0ada53>Skip to content</a><!--]--><!----><header class="VPNav" data-v-5d98c3a5 data-v-ae24b3ad><div class="VPNavBar" data-v-ae24b3ad data-v-6aa21345><div class="wrapper" data-v-6aa21345><div class="container" data-v-6aa21345><div class="title" data-v-6aa21345><div class="VPNavBarTitle has-sidebar" data-v-6aa21345 data-v-1168a8e4><a class="title" href="/tanggang_rust/" data-v-1168a8e4><!--[--><!--]--><!--[--><img class="VPImage logo" src="/tanggang_rust/img/buding.svg" alt data-v-8426fc1a><!--]--><span data-v-1168a8e4>Rust语言从入门到实战</span><!--[--><!--]--></a></div></div><div class="content" data-v-6aa21345><div class="content-body" data-v-6aa21345><!--[--><!--]--><div class="VPNavBarSearch search" data-v-6aa21345><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索文档"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">搜索文档</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><!----><!----><div class="VPNavBarAppearance appearance" data-v-6aa21345 data-v-6c893767><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-6c893767 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div><!----><div class="VPFlyout VPNavBarExtra extra" data-v-6aa21345 data-v-bb2aa2f0 data-v-cf11d7a2><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-cf11d7a2><span class="vpi-more-horizontal icon" data-v-cf11d7a2></span></button><div class="menu" data-v-cf11d7a2><div class="VPMenu" data-v-cf11d7a2 data-v-b98bc113><!----><!--[--><!--[--><!----><div class="group" data-v-bb2aa2f0><div class="item appearance" data-v-bb2aa2f0><p class="label" data-v-bb2aa2f0>Appearance</p><div class="appearance-action" data-v-bb2aa2f0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-bb2aa2f0 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div></div></div><!----><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-6aa21345 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-6aa21345><div class="divider-line" data-v-6aa21345></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-5d98c3a5 data-v-a6f0e41e><div class="container" data-v-a6f0e41e><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-a6f0e41e><span class="vpi-align-left menu-icon" data-v-a6f0e41e></span><span class="menu-text" data-v-a6f0e41e>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-a6f0e41e data-v-8a42e2b4><button data-v-8a42e2b4>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-5d98c3a5 data-v-319d5ca6><div class="curtain" data-v-319d5ca6></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-319d5ca6><span class="visually-hidden" id="sidebar-aria-label" data-v-319d5ca6> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-c40bc020><section class="VPSidebarItem level-0 has-active" data-v-c40bc020 data-v-b3fd67f8><!----><div class="items" data-v-b3fd67f8><!--[--><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/00%EF%BD%9C%E5%BC%80%E7%AF%87%E8%AF%8D%EF%BD%9C%E6%8B%A5%E6%8A%B1Rust%E6%B5%AA%E6%BD%AE%EF%BC%8C%E8%BF%8E%E6%8E%A5%E6%9B%B4%E6%9E%81%E8%87%B4%E7%9A%84%E7%BC%96%E7%A8%8B%E4%BD%93%E9%AA%8C" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>00｜开篇词｜拥抱Rust浪潮，迎接更极致的编程体验</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/01%EF%BD%9C%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%EF%BC%9ARust%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9B%E4%BD%A0%E4%B8%8D%E5%BE%97%E4%B8%8D%E4%BA%86%E8%A7%A3%E7%9A%84%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>01｜快速入门：Rust中有哪些你不得不了解的基础语法？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/02%EF%BD%9C%E6%89%80%E6%9C%89%E6%9D%83%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9ARust%E6%98%AF%E5%A6%82%E4%BD%95%E7%AE%A1%E7%90%86%E7%A8%8B%E5%BA%8F%E4%B8%AD%E7%9A%84%E8%B5%84%E6%BA%90%E7%9A%84%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>02｜所有权（上）：Rust是如何管理程序中的资源的？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/03%EF%BD%9C%E6%89%80%E6%9C%89%E6%9D%83%EF%BC%88%E4%B8%8B%EF%BC%89%EF%BC%9ARust%E4%B8%AD%E5%80%9F%E7%94%A8%E4%B8%8E%E5%BC%95%E7%94%A8%E7%9A%84%E8%A7%84%E5%88%99%E6%98%AF%E6%80%8E%E6%A0%B7%E7%9A%84%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>03｜所有权（下）：Rust中借用与引用的规则是怎样的？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/04%EF%BD%9C%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%9A%E5%AF%B9%E5%8F%B7%E5%85%A5%E5%BA%A7%EF%BC%8C%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%85%B6%E5%AE%9E%E6%B2%A1%E9%82%A3%E4%B9%88%E5%8F%AF%E6%80%95%EF%BC%81" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>04｜字符串：对号入座，字符串其实没那么可怕！</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/05%EF%BD%9C%E5%A4%8D%E5%90%88%E7%B1%BB%E5%9E%8B%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9A%E7%BB%93%E6%9E%84%E4%BD%93%E4%B8%8E%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%89%B9%E6%80%A7" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>05｜复合类型（上）：结构体与面向对象特性</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/06%EF%BD%9C%E5%A4%8D%E5%90%88%E7%B1%BB%E5%9E%8B%EF%BC%88%E4%B8%8B%EF%BC%89%EF%BC%9A%E6%9E%9A%E4%B8%BE%E4%B8%8E%E6%A8%A1%E5%BC%8F%E5%8C%B9%E9%85%8D" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>06｜复合类型（下）：枚举与模式匹配</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/07%EF%BD%9C%E7%B1%BB%E5%9E%8B%E4%B8%8E%E7%B1%BB%E5%9E%8B%E5%8F%82%E6%95%B0%EF%BC%9A%E7%BB%99Rust%E5%B0%8F%E5%8A%A9%E6%89%8B%E6%8F%90%E4%BE%9B%E6%9B%B4%E5%A4%9A%E4%BF%A1%E6%81%AF" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>07｜类型与类型参数：给Rust小助手提供更多信息</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/08%EF%BD%9COption-T-%E4%B8%8EResult-T,E-%E3%80%81%E8%BF%AD%E4%BB%A3%E5%99%A8" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>08｜Option-T-与Result-T,E-、迭代器</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/09%EF%BD%9C%E5%88%9D%E8%AF%86trait%EF%BC%9A%E5%8D%8F%E8%AE%AE%E7%BA%A6%E6%9D%9F%E4%B8%8E%E8%83%BD%E5%8A%9B%E9%85%8D%E7%BD%AE" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>09｜初识trait：协议约束与能力配置</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/10%EF%BD%9C%E5%86%8D%E6%8E%A2trait%EF%BC%9A%E5%B8%A6%E7%B1%BB%E5%9E%8B%E5%8F%82%E6%95%B0%E7%9A%84trait%E5%8F%8Atraitobject" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>10｜再探trait：带类型参数的trait及traitobject</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/11%EF%BD%9C%E5%B8%B8%E8%A7%81trait%E8%A7%A3%E6%9E%90%EF%BC%9A%E6%A0%87%E5%87%86%E5%BA%93%E4%B8%AD%E7%9A%84%E5%B8%B8%E8%A7%81trait%E5%BA%94%E8%AF%A5%E6%80%8E%E4%B9%88%E7%94%A8%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>11｜常见trait解析：标准库中的常见trait应该怎么用？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/%E7%AD%94%E7%96%91%E8%AF%BE%E5%A0%82%EF%BC%88%E4%B8%80%EF%BC%89%EF%BD%9C%E7%AC%AC%E4%B8%80%E7%AB%A0Rust%E5%9F%BA%E7%A1%80%E7%AF%87%E6%80%9D%E8%80%83%E9%A2%98%E7%AD%94%E6%A1%88" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>答疑课堂（一）｜第一章Rust基础篇思考题答案</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/12%EF%BD%9C%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88%EF%BC%9A%E4%BB%8E%E6%89%80%E6%9C%89%E6%9D%83%E7%9C%8B%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>12｜智能指针：从所有权看智能指针</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/13%EF%BD%9C%E7%8B%AC%E7%AB%8B%E7%8E%8B%E5%9B%BD%EF%BC%9A%E5%88%9D%E6%AD%A5%E4%BA%86%E8%A7%A3Rust%E5%BC%82%E6%AD%A5%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>13｜独立王国：初步了解Rust异步并发编程</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/14%EF%BD%9Ctokio%E5%AE%9E%E6%88%98%EF%BC%9A%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E7%BD%91%E7%BB%9C%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%A8%8B%E5%BA%8F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>14｜tokio实战：编写一个网络命令行程序</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/15%EF%BD%9Ctokio%E7%BC%96%E7%A8%8B%EF%BC%9A%E5%9C%A8%E5%A4%9A%E4%BB%BB%E5%8A%A1%E4%B9%8B%E9%97%B4%E6%93%8D%E4%BD%9C%E5%90%8C%E4%B8%80%E7%89%87%E6%95%B0%E6%8D%AE" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>15｜tokio编程：在多任务之间操作同一片数据</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/16%EF%BD%9Ctokio%E7%BC%96%E7%A8%8B%EF%BC%9A%E4%BD%BF%E7%94%A8channel%E5%9C%A8%E4%B8%8D%E5%90%8C%E4%BB%BB%E5%8A%A1%E9%97%B4%E9%80%9A%E4%BF%A1%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>16｜tokio编程：使用channel在不同任务间通信？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/17%EF%BD%9Ctokio%E7%BC%96%E7%A8%8B%EF%BC%9ARust%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E8%BF%98%E6%9C%89%E5%93%AA%E4%BA%9B%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E7%82%B9%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>17｜tokio编程：Rust异步编程还有哪些需要注意的点？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/18%EF%BD%9C%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E7%B3%BB%E7%BB%9F%EF%BC%9A%E9%94%99%E8%AF%AF%E7%9A%84%E6%9E%84%E5%BB%BA%E3%80%81%E4%BC%A0%E9%80%92%E5%92%8C%E5%A4%84%E7%90%86" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>18｜错误处理系统：错误的构建、传递和处理</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/19%EF%BD%9CRust%E7%9A%84%E5%AE%8F%E4%BD%93%E7%B3%BB%EF%BC%9A%E4%B8%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E9%A1%B9%E7%9B%AE%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E5%A3%B0%E6%98%8E%E5%AE%8F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>19｜Rust的宏体系：为自己的项目写一个简单的声明宏</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/20%EF%BD%9C%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%EF%BC%9ARust%E5%A6%82%E4%BD%95%E5%81%9A%E5%9F%BA%E6%9C%AC%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AC%A6%E5%8F%B7%E6%A0%87%E6%B3%A8%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>20｜生命周期：Rust如何做基本的生命周期符号标注？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/%E7%AD%94%E7%96%91%E8%AF%BE%E5%A0%82%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BD%9C%E7%AC%AC%E4%BA%8C%E7%AB%A0Rust%E8%BF%9B%E9%98%B6%E7%AF%87%E6%80%9D%E8%80%83%E9%A2%98%E7%AD%94%E6%A1%88" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>答疑课堂（二）｜第二章Rust进阶篇思考题答案</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/21%EF%BD%9CWeb%E5%BC%80%E5%8F%91%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9A%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8Axum%E6%A1%86%E6%9E%B6%E8%BF%9B%E8%A1%8CWeb%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>21｜Web开发（上）：如何使用Axum框架进行Web后端开发？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/22%EF%BD%9CWeb%E5%BC%80%E5%8F%91%EF%BC%88%E4%B8%8B%EF%BC%89%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AATodoList%E5%BA%94%E7%94%A8%EF%BC%9F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>22｜Web开发（下）：如何实现一个TodoList应用？</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/23%EF%BD%9CRust%E4%B8%8E%E5%A4%A7%E6%A8%A1%E5%9E%8B%EF%BC%9A%E7%94%A8Candle%E5%81%9A%E4%B8%80%E4%B8%AA%E8%81%8A%E5%A4%A9%E6%9C%BA%E5%99%A8%E4%BA%BA" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>23｜Rust与大模型：用Candle做一个聊天机器人</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/24%EF%BD%9CRust%E5%9B%BE%E5%83%8F%E8%AF%86%E5%88%AB%EF%BC%9A%E5%88%A9%E7%94%A8YOLOv8%E8%AF%86%E5%88%AB%E5%AF%B9%E8%B1%A1" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>24｜Rust图像识别：利用YOLOv8识别对象</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/25%EF%BD%9CRustGUI%E7%BC%96%E7%A8%8B%EF%BC%9A%E7%94%A8Slint%E4%B8%BAChatbot%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%95%8C%E9%9D%A2" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>25｜RustGUI编程：用Slint为Chatbot实现一个界面</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/26%EF%BD%9CRustGUI%E7%BC%96%E7%A8%8B%EF%BC%9A%E7%94%A8Slint%E4%B8%BAYOLOv8%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%95%8C%E9%9D%A2" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>26｜RustGUI编程：用Slint为YOLOv8实现一个界面</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/27%EF%BD%9CRustBevy%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%EF%BC%9A%E7%94%A8300%E8%A1%8C%E4%BB%A3%E7%A0%81%E5%81%9A%E4%B8%80%E4%B8%AA%E8%B4%AA%E5%90%83%E8%9B%87%E6%B8%B8%E6%88%8F" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>27｜RustBevy游戏开发：用300行代码做一个贪吃蛇游戏</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/28%EF%BD%9CNom%EF%BC%9A%E7%94%A8Rust%E5%86%99%E4%B8%80%E4%B8%AAParser%E8%A7%A3%E6%9E%90%E5%99%A8" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>28｜Nom：用Rust写一个Parser解析器</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/29%EF%BD%9CUnsafe%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9AUnsafeRust%E4%B8%AD%E9%82%A3%E4%BA%9B%E8%A2%AB%E5%B0%81%E5%8D%B0%E7%9A%84%E8%83%BD%E5%8A%9B" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>29｜Unsafe编程（上）：UnsafeRust中那些被封印的能力</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/30%EF%BD%9CUnsafe%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%8B%EF%BC%89%EF%BC%9A%E4%BD%BF%E7%94%A8Rust%E4%B8%BAPython%E5%86%99%E4%B8%80%E4%B8%AA%E6%89%A9%E5%B1%95" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>30｜Unsafe编程（下）：使用Rust为Python写一个扩展</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/%E7%AD%94%E7%96%91%E8%AF%BE%E5%A0%82%EF%BC%88%E4%B8%89%EF%BC%89%EF%BD%9C%E7%AC%AC%E4%B8%89%E7%AB%A0Rust%E5%BA%94%E7%94%A8%E7%AF%87%E6%80%9D%E8%80%83%E9%A2%98%E7%AD%94%E6%A1%88" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>答疑课堂（三）｜第三章Rust应用篇思考题答案</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/%E7%BB%93%E8%AF%BE%E6%B5%8B%E8%AF%95%EF%BD%9C%E6%9D%A5%E8%B5%B4%E4%B8%80%E5%9C%BA%E6%BB%A1%E5%88%86%E4%B9%8B%E7%BA%A6" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>结课测试｜来赴一场满分之约</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/tanggang_rust/Document/%E7%BB%93%E6%9D%9F%E8%AF%AD%EF%BD%9C%E6%9C%AA%E6%9D%A5%E8%AE%A9Rust%E5%B8%A6%E4%BD%A0%E2%80%9C%E9%94%88%E2%80%9D%E5%88%B0%E8%B5%B7%E9%A3%9E" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>结束语｜未来让Rust带你“锈”到起飞</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-5d98c3a5 data-v-1428d186><div class="VPDoc has-sidebar has-aside" data-v-1428d186 data-v-39a288b8><!--[--><!--]--><div class="container" data-v-39a288b8><div class="aside" data-v-39a288b8><div class="aside-curtain" data-v-39a288b8></div><div class="aside-container" data-v-39a288b8><div class="aside-content" data-v-39a288b8><div class="VPDocAside" data-v-39a288b8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-3f215769 data-v-a5bbad30><div class="content" data-v-a5bbad30><div class="outline-marker" data-v-a5bbad30></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-a5bbad30>⚡️文档内容大纲</div><ul class="VPDocOutlineItem root" data-v-a5bbad30 data-v-b933a997><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-39a288b8><div class="content-container" data-v-39a288b8><!--[--><!--]--><main class="main" data-v-39a288b8><div style="position:relative;" class="vp-doc _tanggang_rust_Document_14%EF%BD%9Ctokio%E5%AE%9E%E6%88%98%EF%BC%9A%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E7%BD%91%E7%BB%9C%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%A8%8B%E5%BA%8F" data-v-39a288b8><div><h1 id="_14-tokio-实战-编写一个网络命令行程序" tabindex="-1">14 ｜ tokio 实战：编写一个网络命令行程序 <a class="header-anchor" href="#_14-tokio-实战-编写一个网络命令行程序" aria-label="Permalink to &quot;14 ｜ tokio 实战：编写一个网络命令行程序&quot;">​</a></h1><p>你好，我是 Mike，上一节课我们了解了 Rust 异步编程和 tokio 的基础知识，今天我们就来一起用 tokio 做一个小应用。</p><h2 id="准备阶段" tabindex="-1">准备阶段 <a class="header-anchor" href="#准备阶段" aria-label="Permalink to &quot;准备阶段&quot;">​</a></h2><p>我们常常需要知道远程服务器上的一些信息，这有一些现成的工具可以做到。我们来试一下如何使用 tokio 实现这一功能。</p><p><strong>目标：</strong> 编写一个获取服务器时间的命令行程序。</p><p><strong>任务分解：</strong></p><ol><li>命令行：这个工具取名为 getinfo, 参数格式是 <code>getinfo {ip}</code>，就是在 getinfo 后接 IP 地址，获取服务器时间。</li><li>tcp server：监听 8888 端口，获取从客户端来的请求，然后获取服务器本地时间，返回。</li><li>tcp client：连接服务端地址 <code>ip:port</code>，向服务端发送获取服务器时间指令。</li><li>测试。</li></ol><h2 id="实现" tabindex="-1">实现 <a class="header-anchor" href="#实现" aria-label="Permalink to &quot;实现&quot;">​</a></h2><p>下面我们开始实现。</p><h3 id="创建项目" tabindex="-1">创建项目 <a class="header-anchor" href="#创建项目" aria-label="Permalink to &quot;创建项目&quot;">​</a></h3><p>我们打开终端或者 IDE 中的 Terminal，执行：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">cargo</span><span style="color:#E06C75;"> new</span><span style="color:#ABB2BF;"> --</span><span style="color:#E06C75;">bin</span><span style="color:#E06C75;"> getinfo</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="命令行雏形" tabindex="-1">命令行雏形 <a class="header-anchor" href="#命令行雏形" aria-label="Permalink to &quot;命令行雏形&quot;">​</a></h3><p>Rust 标准库中实际已经有获取命令行参数的功能， <code>std::env</code> 提供了一种获取命令行参数的方法 <a href="https://doc.rust-lang.org/std/index.html" target="_blank" rel="noreferrer">std</a>:: <a href="https://doc.rust-lang.org/std/env/index.html" target="_blank" rel="noreferrer">env</a>:: <a href="https://doc.rust-lang.org/std/env/fn.args.html#" target="_blank" rel="noreferrer">args</a>()，可以将命令行参数转换成一个迭代器，通过 for 循环就可以遍历所有命令行参数，当然也可以使用迭代器上的 <code>.nth()</code> 直接定位到某一个参数。比如：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">let</span><span style="color:#E06C75;"> addr</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> env</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">args</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">    .</span><span style="color:#61AFEF;">nth</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">    .</span><span style="color:#61AFEF;">unwrap_or_else</span><span style="color:#ABB2BF;">(</span><span style="color:#56B6C2;">||</span><span style="color:#98C379;"> &quot;127.0.0.1:8888&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">());</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>有了这个功能，我们就可以得到命令行的初始版本。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> std</span><span style="color:#ABB2BF;">::env;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">fn</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#C678DD;">  let</span><span style="color:#E06C75;"> addr</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> env</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">args</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">    .</span><span style="color:#61AFEF;">nth</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">    .</span><span style="color:#61AFEF;">unwrap_or</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;127.0.0.1:8888&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">  println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;{}&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">addr</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>检查一下 Cargo.toml 中的配置，我们的应用名字应该叫 getinfo。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">[</span><span style="color:#E06C75;">package</span><span style="color:#ABB2BF;">]</span></span>
<span class="line"><span style="color:#E06C75;">name</span><span style="color:#56B6C2;"> =</span><span style="color:#98C379;"> &quot;getinfo&quot;</span></span>
<span class="line"><span style="color:#E06C75;">version</span><span style="color:#56B6C2;"> =</span><span style="color:#98C379;"> &quot;0.1.0&quot;</span></span>
<span class="line"><span style="color:#E06C75;">edition</span><span style="color:#56B6C2;"> =</span><span style="color:#98C379;"> &quot;2021&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;"># </span><span style="color:#E5C07B;">See</span><span style="color:#E06C75;"> more</span><span style="color:#E06C75;"> keys</span><span style="color:#E06C75;"> and</span><span style="color:#E06C75;"> their</span><span style="color:#E06C75;"> definitions</span><span style="color:#E06C75;"> at</span><span style="color:#E06C75;"> https</span><span style="color:#ABB2BF;">:</span><span style="color:#7F848E;font-style:italic;">//doc.rust-lang.org/cargo/reference/manifest.html</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">[</span><span style="color:#E06C75;">dependencies</span><span style="color:#ABB2BF;">]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>执行 cargo build 编译，会出现 target 目录。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E5C07B;">Cargo</span><span style="color:#ABB2BF;">.lock  </span><span style="color:#E5C07B;">Cargo</span><span style="color:#ABB2BF;">.toml  </span><span style="color:#E06C75;">src</span><span style="color:#ABB2BF;">/  </span><span style="color:#E06C75;">target</span><span style="color:#ABB2BF;">/</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>执行 <code>cargo run</code> 或 <code>./target/debug/getinfo</code>。可以得到输出 <code>127.0.0.1:8888</code>。</p><p>而执行 <code>cargo run -- 127.0.0.1:8000</code> 或 <code>./target/debug/getinfo 127.0.0.1:8000</code>，可以得到输出 <code>127.0.0.1:8000</code>。</p><p>这里我们来分析一下这个命令行的形式。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">./</span><span style="color:#E06C75;">target</span><span style="color:#ABB2BF;">/</span><span style="color:#E06C75;">debug</span><span style="color:#ABB2BF;">/</span><span style="color:#E06C75;">getinfo</span><span style="color:#E06C75;"> ip_address</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>命令行参数从左到右按序号从 0 开始计数，上面命令中， <code>./target/debug/getinfo</code> 序号为 0， <code>ip_address</code> 部分序号就是 1，如果后面还有其他参数，那么序号依次递增。所以你就可以理解为什么我们上面的代码中，使用 <code>.nth(1)</code> 取 IP 地址的信息。</p><p>标准库中命令行相关的功能虽然比较初级，但是对于我们的例子来说，已经够用了。Rust 生态中有个非常好用的写命令行的库： <a href="https://crates.io/crates/clap" target="_blank" rel="noreferrer">clap</a>，如果你想写一个功能丰富的命令行程序，可以去尝试一下这个 clap。</p><p>下面我们就要开始 tokio tcp server 的创建。</p><h3 id="添加依赖" tabindex="-1">添加依赖 <a class="header-anchor" href="#添加依赖" aria-label="Permalink to &quot;添加依赖&quot;">​</a></h3><p>先加入 tokio 的依赖，在项目目录下执行命令。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">cargo</span><span style="color:#E06C75;"> add</span><span style="color:#E06C75;"> tokio</span><span style="color:#ABB2BF;"> --</span><span style="color:#E06C75;">features</span><span style="color:#E06C75;"> full</span></span>
<span class="line"><span style="color:#E06C75;">cargo</span><span style="color:#E06C75;"> add</span><span style="color:#E06C75;"> tokio</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">util</span><span style="color:#ABB2BF;"> --</span><span style="color:#E06C75;">features</span><span style="color:#E06C75;"> full</span></span>
<span class="line"><span style="color:#E06C75;">cargo</span><span style="color:#E06C75;"> add</span><span style="color:#E06C75;"> futures</span></span>
<span class="line"><span style="color:#E06C75;">cargo</span><span style="color:#E06C75;"> add</span><span style="color:#E06C75;"> bytes</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>执行完这几个添加依赖的命令后，Cargo.toml 文件现在看起来是类似下面这个样子：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">mike</span><span style="color:#ABB2BF;">@</span><span style="color:#D19A66;">LAPTOP</span><span style="color:#ABB2BF;">-04V0EV33:~/</span><span style="color:#E06C75;">works</span><span style="color:#ABB2BF;">/</span><span style="color:#E06C75;">jikeshijian</span><span style="color:#ABB2BF;">/</span><span style="color:#E06C75;">getinfo</span><span style="color:#ABB2BF;">$ </span><span style="color:#E06C75;">cat</span><span style="color:#E5C07B;"> Cargo</span><span style="color:#ABB2BF;">.toml</span></span>
<span class="line"><span style="color:#ABB2BF;">[</span><span style="color:#E06C75;">package</span><span style="color:#ABB2BF;">]</span></span>
<span class="line"><span style="color:#E06C75;">name</span><span style="color:#56B6C2;"> =</span><span style="color:#98C379;"> &quot;getinfo&quot;</span></span>
<span class="line"><span style="color:#E06C75;">version</span><span style="color:#56B6C2;"> =</span><span style="color:#98C379;"> &quot;0.1.0&quot;</span></span>
<span class="line"><span style="color:#E06C75;">edition</span><span style="color:#56B6C2;"> =</span><span style="color:#98C379;"> &quot;2021&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;"># </span><span style="color:#E5C07B;">See</span><span style="color:#E06C75;"> more</span><span style="color:#E06C75;"> keys</span><span style="color:#E06C75;"> and</span><span style="color:#E06C75;"> their</span><span style="color:#E06C75;"> definitions</span><span style="color:#E06C75;"> at</span><span style="color:#E06C75;"> https</span><span style="color:#ABB2BF;">:</span><span style="color:#7F848E;font-style:italic;">//doc.rust-lang.org/cargo/reference/manifest.html</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">[</span><span style="color:#E06C75;">dependencies</span><span style="color:#ABB2BF;">]</span></span>
<span class="line"><span style="color:#E06C75;">bytes</span><span style="color:#56B6C2;"> =</span><span style="color:#98C379;"> &quot;1.5.0&quot;</span></span>
<span class="line"><span style="color:#E06C75;">futures</span><span style="color:#56B6C2;"> =</span><span style="color:#98C379;"> &quot;0.3.29&quot;</span></span>
<span class="line"><span style="color:#E06C75;">tokio</span><span style="color:#56B6C2;"> =</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">version</span><span style="color:#56B6C2;"> =</span><span style="color:#98C379;"> &quot;1.33.0&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">features</span><span style="color:#56B6C2;"> =</span><span style="color:#ABB2BF;"> [</span><span style="color:#98C379;">&quot;full&quot;</span><span style="color:#ABB2BF;">] }</span></span>
<span class="line"><span style="color:#E06C75;">tokio</span><span style="color:#ABB2BF;">-</span><span style="color:#E06C75;">util</span><span style="color:#56B6C2;"> =</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">version</span><span style="color:#56B6C2;"> =</span><span style="color:#98C379;"> &quot;0.7.10&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">features</span><span style="color:#56B6C2;"> =</span><span style="color:#ABB2BF;"> [</span><span style="color:#98C379;">&quot;full&quot;</span><span style="color:#ABB2BF;">] }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><code>cargo add</code> 工具为我们准确配置了具体依赖库的版本号和特性。</p><h3 id="基于-tokio-实现-tcp-server" tabindex="-1">基于 tokio 实现 tcp server <a class="header-anchor" href="#基于-tokio-实现-tcp-server" aria-label="Permalink to &quot;基于 tokio 实现 tcp server&quot;">​</a></h3><p>我们的 tcp server 实际要干下面几件事儿。</p><ol><li>接收 tcp client 的连接，每一个新连接创建一个新的 task。</li><li>读取 tcp client 发过来的指令数据。</li><li>根据指令，获取服务器本地的时间信息。</li><li>将得到的信息字符串写入 socket，返回给客户端。</li></ol><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> std</span><span style="color:#ABB2BF;">::env;</span></span>
<span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> tokio</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">io</span><span style="color:#ABB2BF;">::{</span><span style="color:#E5C07B;">AsyncReadExt</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">AsyncWriteExt</span><span style="color:#ABB2BF;">};</span></span>
<span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> tokio</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">net</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">TcpListener</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> tokio</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">process</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">Command</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">#[tokio::main]</span></span>
<span class="line"><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> fn</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">() -&gt; </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">&lt;(), </span><span style="color:#E5C07B;">Box</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">dyn</span><span style="color:#E06C75;"> std</span><span style="color:#ABB2BF;">::</span><span style="color:#E06C75;">error</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">Error</span><span style="color:#ABB2BF;">&gt;&gt; {</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> addr</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> env</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">args</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">        .</span><span style="color:#61AFEF;">nth</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">        .</span><span style="color:#61AFEF;">unwrap_or_else</span><span style="color:#ABB2BF;">(</span><span style="color:#56B6C2;">||</span><span style="color:#98C379;"> &quot;127.0.0.1:8888&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#61AFEF;">    println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;Listening on: {}&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">addr</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> listener</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> TcpListener</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">bind</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#E06C75;">addr</span><span style="color:#ABB2BF;">).</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">?;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 注意这里是一个无条件循环，表明始终处于服务状态</span></span>
<span class="line"><span style="color:#C678DD;">    loop</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 等待客户端请求连上来</span></span>
<span class="line"><span style="color:#C678DD;">        let</span><span style="color:#ABB2BF;"> (</span><span style="color:#C678DD;">mut</span><span style="color:#E06C75;"> socket</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">_</span><span style="color:#ABB2BF;">) </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> listener</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">accept</span><span style="color:#ABB2BF;">().</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">?;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 来一个客户端连接，创建一个对应的新任务</span></span>
<span class="line"><span style="color:#E5C07B;">        tokio</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">spawn</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> move</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // 分配一个缓冲存</span></span>
<span class="line"><span style="color:#C678DD;">            let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> buf</span><span style="color:#56B6C2;"> =</span><span style="color:#ABB2BF;"> [</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">; </span><span style="color:#D19A66;">1024</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"><span style="color:#C678DD;">            let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> offset</span><span style="color:#56B6C2;"> =</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // 循环读，因为不能确保一次能从网络线路上读完数据</span></span>
<span class="line"><span style="color:#C678DD;">            loop</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // 读操作，返回的n表示读了多少个字节</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // 正常情况下，读到数据才会返回，如果没有读到，就会等待</span></span>
<span class="line"><span style="color:#C678DD;">                let</span><span style="color:#E06C75;"> n</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> socket</span></span>
<span class="line"><span style="color:#ABB2BF;">                    .</span><span style="color:#61AFEF;">read</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#C678DD;">mut</span><span style="color:#E06C75;"> buf</span><span style="color:#ABB2BF;">[</span><span style="color:#E06C75;">offset</span><span style="color:#ABB2BF;">..])</span></span>
<span class="line"><span style="color:#ABB2BF;">                    .</span><span style="color:#C678DD;">await</span></span>
<span class="line"><span style="color:#ABB2BF;">                    .</span><span style="color:#61AFEF;">expect</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;failed to read data from socket&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // n返回0的情况，是碰到了EOF，表明远端的写操作已断开，这个一定要判断</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#E06C75;"> n</span><span style="color:#56B6C2;"> ==</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    // 碰到了EOF就直接返回结束此任务，因为后面的操作没了意义</span></span>
<span class="line"><span style="color:#C678DD;">                    return</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">                }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">                println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;offset: {offset}, n: {n}&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">                let</span><span style="color:#E06C75;"> end</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> offset</span><span style="color:#ABB2BF;"> + </span><span style="color:#E06C75;">n</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                // 转换指令为字符串</span></span>
<span class="line"><span style="color:#C678DD;">                if</span><span style="color:#C678DD;"> let</span><span style="color:#E5C07B;"> Ok</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">directive</span><span style="color:#ABB2BF;">) </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> std</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">str</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">from_utf8</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#E06C75;">buf</span><span style="color:#ABB2BF;">[..</span><span style="color:#E06C75;">end</span><span style="color:#ABB2BF;">]) {</span></span>
<span class="line"><span style="color:#61AFEF;">                    println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;{directive}&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    // 执行指令对应的工作</span></span>
<span class="line"><span style="color:#C678DD;">                    let</span><span style="color:#E06C75;"> output</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> process</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">directive</span><span style="color:#ABB2BF;">).</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">                    println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;{output}&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    // 向客户端返回处理结果</span></span>
<span class="line"><span style="color:#E06C75;">                    socket</span></span>
<span class="line"><span style="color:#ABB2BF;">                        .</span><span style="color:#61AFEF;">write_all</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#E06C75;">output</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">as_bytes</span><span style="color:#ABB2BF;">())</span></span>
<span class="line"><span style="color:#ABB2BF;">                        .</span><span style="color:#C678DD;">await</span></span>
<span class="line"><span style="color:#ABB2BF;">                        .</span><span style="color:#61AFEF;">expect</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;failed to write data to socket&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">                } </span><span style="color:#C678DD;">else</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    // 判断是否转换失败，如果失败，就有可能是网络上的数据还没读完</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                    // 要继续loop读下一波数据</span></span>
<span class="line"><span style="color:#E06C75;">                    offset</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> end</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">                }</span></span>
<span class="line"><span style="color:#ABB2BF;">            }</span></span>
<span class="line"><span style="color:#ABB2BF;">        });</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> fn</span><span style="color:#61AFEF;"> process</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">directive</span><span style="color:#ABB2BF;">: &amp;</span><span style="color:#E5C07B;">str</span><span style="color:#ABB2BF;">) -&gt; </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> directive</span><span style="color:#56B6C2;"> ==</span><span style="color:#98C379;"> &quot;gettime&quot;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 这里我们用了unwrap()是因为我们一般确信执行date命令不会失败</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 更可靠的做法是对返回的Result作处理</span></span>
<span class="line"><span style="color:#C678DD;">        let</span><span style="color:#E06C75;"> output</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> Command</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">new</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;date&quot;</span><span style="color:#ABB2BF;">).</span><span style="color:#61AFEF;">output</span><span style="color:#ABB2BF;">().</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unwrap</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E5C07B;">        String</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">from_utf8</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">output</span><span style="color:#ABB2BF;">.stdout).</span><span style="color:#61AFEF;">unwrap</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">    } </span><span style="color:#C678DD;">else</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 如果是其他指令，我们目前返回 无效指令</span></span>
<span class="line"><span style="color:#98C379;">        &quot;invalid command&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_owned</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div><p>代码中有详细解释，这里我也补充说明一下。</p><p>首先，我们给 main 函数指定了返回类型： <code>Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt;</code>。错误类型部分是一个用 <code>Box&lt;T&gt;</code> 装盒的 trait object，这个 trait object 是针对标准库中的 Error trait 的。在这里的意思是，凡是实现了 Error trait 的类型都可以作为错误类型从 main 函数中返回。</p><p>第 12 行 <code>let listener = TcpListener::bind(&amp;addr).await?;</code> 行末有一个问号，这是 Rust 里的问号操作符，意思是.await 得到数据后是一个 <code>Result&lt;&gt;</code>，如果这个 <code>Result&lt;&gt;</code> 是 Ok 值，那就解开它，返回里面的内容，这个例子里是一个 TcpListener 实例；而如果这个 <code>Result&lt;&gt;</code> 是 Err 值，那就直接从函数中返回，不再往下执行。问号操作符在这里起一个防御式编程的作用，能够让流程代码显得更简洁。</p><p>注意第 15 行是一个 loop 无条件循环，也就是死循环。为什么呢？因为这是个服务端程序，是需要一直跑着的，退出就意味着出问题了。</p><p>第 17 行，监听客户端来的连接，来一个就产生一个 socket 实例。我们看到，在 let 后面用了模式匹配写法，直接把元组析构了。如果来了多个连接，就会产生多个 task，它们之间互不干扰，是并发处理的。</p><p>第 20 行，针对每一个连上的客户端连接，创建一个新的 tokio 轻量级线程 task，来处理对应的任务。继续往下，第 22 行，可以看到，这个服务端程序为每个连接创建了一个缓冲区，大小是 1024 字节。从网络上读到的数据会放在这个缓冲区里面。</p><p>第 25 行，再次用了一个循环。因为网络上的数据是呈流的形式过来的，在一次 CPU 读取它之前，这些数据有可能还没完全到达服务器上面。因此可能需要多次读。读没读够，可以尝试把已经读到数据转换成字符串，看是否能成功来判断（这个判断方式并不严谨，这里主要用于说明流程）。如果成功了，就调用 <code>process()</code> 业务函数来计算。</p><p>process()异步函数中使用了 <code>tokio::process::Command</code> 类型来调用系统中的 <code>date</code> 命令，这是一个 Linux 下的查看系统日期时间的命令，会输出下面这种格式：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E5C07B;">Tue</span><span style="color:#E5C07B;"> Oct</span><span style="color:#D19A66;"> 31</span><span style="color:#D19A66;"> 14</span><span style="color:#ABB2BF;">:</span><span style="color:#D19A66;">56</span><span style="color:#ABB2BF;">:</span><span style="color:#D19A66;">27</span><span style="color:#D19A66;"> CST</span><span style="color:#D19A66;"> 2023</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>注：如果你使用 Windows 的话，可以找找 Windows 里的替代命令。</p><p><code>process()</code> 函数会返回这个字符串。</p><p>然后，通过同一个 socket，将数据返回给客户端连接： <code>socket.write_all</code>。</p><p>在多次读的过程中，要注意偏移量 offset 的处理。可以看到，代码量虽然不多，但是充满了细节，请你仔细品味一下。</p><h3 id="基于-tokio-实现-tcp-client" tabindex="-1">基于 tokio 实现 tcp client <a class="header-anchor" href="#基于-tokio-实现-tcp-client" aria-label="Permalink to &quot;基于 tokio 实现 tcp client&quot;">​</a></h3><p>下面我们来看对应的 tcp 客户端应该怎么实现。</p><p>因为我们要马上再创建一个可执行程序，所以默认的 <code>cargo run</code> 命令就不能满足这个需求，它默认只能启动一个二进制文件。我们需要改一下 Cargo.toml 的配置，在文件中加入一些内容。</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">[[</span><span style="color:#E06C75;">bin</span><span style="color:#ABB2BF;">]]</span></span>
<span class="line"><span style="color:#E06C75;">name</span><span style="color:#56B6C2;"> =</span><span style="color:#98C379;"> &quot;server&quot;</span></span>
<span class="line"><span style="color:#E06C75;">path</span><span style="color:#56B6C2;"> =</span><span style="color:#98C379;"> &quot;src/server.rs&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">[[</span><span style="color:#E06C75;">bin</span><span style="color:#ABB2BF;">]]</span></span>
<span class="line"><span style="color:#E06C75;">name</span><span style="color:#56B6C2;"> =</span><span style="color:#98C379;"> &quot;client&quot;</span></span>
<span class="line"><span style="color:#E06C75;">path</span><span style="color:#56B6C2;"> =</span><span style="color:#98C379;"> &quot;src/client.rs&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>然后把 src 目录下的 main.rs 改成 server.rs，并创建一个新文件 client.rs，代码如下：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> std</span><span style="color:#ABB2BF;">::env;</span></span>
<span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> tokio</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">io</span><span style="color:#ABB2BF;">::{</span><span style="color:#E5C07B;">AsyncReadExt</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">AsyncWriteExt</span><span style="color:#ABB2BF;">};</span></span>
<span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> tokio</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">net</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">TcpStream</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">#[tokio::main]</span></span>
<span class="line"><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> fn</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">() -&gt; </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">&lt;(), </span><span style="color:#E5C07B;">Box</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">dyn</span><span style="color:#E06C75;"> std</span><span style="color:#ABB2BF;">::</span><span style="color:#E06C75;">error</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">Error</span><span style="color:#ABB2BF;">&gt;&gt; {</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> addr</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> env</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">args</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">        .</span><span style="color:#61AFEF;">nth</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">        .</span><span style="color:#61AFEF;">unwrap_or_else</span><span style="color:#ABB2BF;">(</span><span style="color:#56B6C2;">||</span><span style="color:#98C379;"> &quot;127.0.0.1:8888&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 连接到服务端</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> stream</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> TcpStream</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">connect</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#E06C75;">addr</span><span style="color:#ABB2BF;">).</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">?;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 写入指令数据，这是一种最简单的协议.</span></span>
<span class="line"><span style="color:#E06C75;">    stream</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">write_all</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">b&quot;gettime&quot;</span><span style="color:#ABB2BF;">).</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">?;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 等待tcp server的回复，读取内容</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 这里用动态数组来存储从服务端返回的内容</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> buf</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Vec</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">u8</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#E5C07B;"> Vec</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">with_capacity</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">8128</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 读取的缓冲区</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> resp</span><span style="color:#56B6C2;"> =</span><span style="color:#ABB2BF;"> [</span><span style="color:#D19A66;">0</span><span style="color:#E5C07B;">u8</span><span style="color:#ABB2BF;">; </span><span style="color:#D19A66;">2048</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"><span style="color:#C678DD;">    loop</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 尝试一次读，返回读到的字节数</span></span>
<span class="line"><span style="color:#C678DD;">        let</span><span style="color:#E06C75;"> n</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> stream</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">read</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#C678DD;">mut</span><span style="color:#E06C75;"> resp</span><span style="color:#ABB2BF;">).</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">?;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 将读到的字节合并到buf中去</span></span>
<span class="line"><span style="color:#E06C75;">        buf</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">extend_from_slice</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#E06C75;">resp</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">..</span><span style="color:#E06C75;">n</span><span style="color:#ABB2BF;">]);</span></span>
<span class="line"><span style="color:#C678DD;">        if</span><span style="color:#E06C75;"> n</span><span style="color:#56B6C2;"> ==</span><span style="color:#D19A66;"> 0</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // 流断掉了</span></span>
<span class="line"><span style="color:#61AFEF;">            panic!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;Unexpected EOF&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">        } </span><span style="color:#C678DD;">else</span><span style="color:#C678DD;"> if</span><span style="color:#E06C75;"> buf</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">len</span><span style="color:#ABB2BF;">() </span><span style="color:#56B6C2;">&gt;=</span><span style="color:#D19A66;"> 28</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // like: &quot;Tue Oct 31 14:56:27 CST 2023&quot;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // buf 已经填充了足够的内容</span></span>
<span class="line"><span style="color:#C678DD;">            break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">        } </span><span style="color:#C678DD;">else</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // buf 中还没有足够多的内容，继续填充...</span></span>
<span class="line"><span style="color:#C678DD;">            continue</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 转换并打印返回的信息</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> timeinfo</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> String</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">from_utf8</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">buf</span><span style="color:#ABB2BF;">)?;</span></span>
<span class="line"><span style="color:#61AFEF;">    println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;{}&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">timeinfo</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;">    Ok</span><span style="color:#ABB2BF;">(())</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>代码中有详细解释，这里我也做一下补充说明。</p><p>第 11 行，我们使用 <code>TcpStream::connect()</code> 连到服务端上去，注意这点和服务端的监听是不同的。然后第 14 行，向 tcp 连接中写入协议指令，这里就是简单的字节串： <code>b&quot;gettime&quot;</code>。</p><p>然后第 17 行到 25 行，我们采用了另外一种方式来存储读回来的数据，这里用到了动态数组 Vec 的 <code>API extend_from_slice()</code>，这个的好处是不需要由自己来维护每次读到的偏移量。第 21 行，我们再次使用了 loop，还是同样的原因，网络上的数据流，我们有可能一次读取不完，需要多次读才行。</p><p>第 29 行是跳出此循环的判断条件，这里是因为我们知道会返回 date 命令的输出结果，它是固定的 28 个字节的长度。这个条件相当死板，这里也只是起演示作用。</p><p>最后就把这个从服务端程序得到的内容打印出来。下面我们开始测试。</p><h3 id="测试" tabindex="-1">测试 <a class="header-anchor" href="#测试" aria-label="Permalink to &quot;测试&quot;">​</a></h3><p>编译运行服务端：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">cargo</span><span style="color:#E06C75;"> run</span><span style="color:#ABB2BF;"> --</span><span style="color:#E06C75;">bin</span><span style="color:#E06C75;"> server</span><span style="color:#ABB2BF;"> 或 </span><span style="color:#E06C75;">cargo</span><span style="color:#E06C75;"> run</span><span style="color:#ABB2BF;"> --</span><span style="color:#E06C75;">bin</span><span style="color:#E06C75;"> server</span><span style="color:#ABB2BF;"> -- </span><span style="color:#D19A66;">127.0</span><span style="color:#ABB2BF;">.</span><span style="color:#D19A66;">0.1</span><span style="color:#ABB2BF;">:</span><span style="color:#D19A66;">8888</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>编译执行客户端：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E06C75;">cargo</span><span style="color:#E06C75;"> run</span><span style="color:#ABB2BF;"> --</span><span style="color:#E06C75;">bin</span><span style="color:#E06C75;"> client</span><span style="color:#ABB2BF;"> 或 </span><span style="color:#E06C75;">cargo</span><span style="color:#E06C75;"> run</span><span style="color:#ABB2BF;"> --</span><span style="color:#E06C75;">bin</span><span style="color:#E06C75;"> client</span><span style="color:#ABB2BF;"> -- </span><span style="color:#D19A66;">127.0</span><span style="color:#ABB2BF;">.</span><span style="color:#D19A66;">0.1</span><span style="color:#ABB2BF;">:</span><span style="color:#D19A66;">8888</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>查看执行效果。</p><p>服务端打印：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E5C07B;">Listening</span><span style="color:#E06C75;"> on</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">127.0</span><span style="color:#ABB2BF;">.</span><span style="color:#D19A66;">0.1</span><span style="color:#ABB2BF;">:</span><span style="color:#D19A66;">8888</span></span>
<span class="line"><span style="color:#E06C75;">offset</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">n</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">7</span></span>
<span class="line"><span style="color:#E06C75;">gettime</span></span>
<span class="line"><span style="color:#E5C07B;">Tue</span><span style="color:#E5C07B;"> Oct</span><span style="color:#D19A66;"> 31</span><span style="color:#D19A66;"> 15</span><span style="color:#ABB2BF;">:</span><span style="color:#D19A66;">04</span><span style="color:#ABB2BF;">:</span><span style="color:#D19A66;">08</span><span style="color:#D19A66;"> CST</span><span style="color:#D19A66;"> 2023</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>客户端打印：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#E5C07B;">Tue</span><span style="color:#E5C07B;"> Oct</span><span style="color:#D19A66;"> 31</span><span style="color:#D19A66;"> 15</span><span style="color:#ABB2BF;">:</span><span style="color:#D19A66;">07</span><span style="color:#ABB2BF;">:</span><span style="color:#D19A66;">48</span><span style="color:#D19A66;"> CST</span><span style="color:#D19A66;"> 2023</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>这样，我们就成功实现了我们的第一个命令行应用，并完整体验了 tokio 网络编程。</p><h2 id="frame-层" tabindex="-1">Frame 层 <a class="header-anchor" href="#frame-层" aria-label="Permalink to &quot;Frame 层&quot;">​</a></h2><p>前面我们的实现，完成了这个应用初步的功能。但是实际上对于我们初学者来说，难度还是比较大，主要体现在 4 个方面。</p><ol><li>什么时候要加 loop，什么时候不加？</li><li>两个端的合法性判定条件是什么？能否推广到适用面更广的方式？</li><li>多次读取的偏移量或缓冲区如何准确维护？</li><li>tcp 网络协议的背景知识，服务端与客户端的基本概念，EOF 在什么条件下触发等等。</li></ol><p>其中前面三条都属于实现层面的细节，我们可以来了解一下产生这些复杂性的原因。</p><h3 id="复杂性的来源" tabindex="-1">复杂性的来源 <a class="header-anchor" href="#复杂性的来源" aria-label="Permalink to &quot;复杂性的来源&quot;">​</a></h3><p>我们知道，一个 tcp 连接就像一个管道一样，里面流过的是一个个的字节，也就是说，它传输的是一个字节流。然而，由于网络本身的复杂性，比如如果服务器在很远的地方，数据有可能要经历过很多次路由器/交换机才能到达，有可能一个字节和下一个字节之间会间隔一段时间才能传过来。这时候，直接在 socket 上做的一次 read，并不能保证就一定读完整了我们想要的内容，有可能只读到了一个片段而已。</p><p>这个问题其实属于传输层的问题，不应该让上层业务开发人员来担忧。如果在考虑业务的同时，还要考虑这种底层问题的话，总会感觉施展不开，各种细节会缠得你寸步难行。</p><p>比如有两个人 A 和 B，A 给 B 发送两条消息 msg_a 和 msg_b，B 接收消息的时候，一般会希望编程接口每次拿到一个完整的消息，第一次取是 msg_a，不多也不少；第二次取是 msg_b，不多也不少。不会担心每次取的时候，消息可能取不完整，需要用一个循环重复取，并且还得把每次取到的片段拼接成一个大的完整的消息内容。</p><p>当消息体小的时候，可能问题不明显，当消息体大的时候，比如一次有几兆内容的时候，这个问题其实就无法忽略了。</p><p>好在 tokio 框架已经为我们考虑了这个问题。tokio 生态引入了 Frame 的概念，Frame 就是一个帧/框，一个 Frame 里可以包含一段完整的可预期的信息。相当于它在 tcp 这一层之上又抽象了一层，封装了具体怎么读取和切分原始的字节序列这个问题。Frame 让我们读到的总是业务关心的一批批数据：msg。Frame 机制将网络流的原始字节序列转换成 Frame 序列，并且会自动帮我们确定 Frame 的边界在哪里。</p><h3 id="frame-编解码" tabindex="-1">Frame 编解码 <a class="header-anchor" href="#frame-编解码" aria-label="Permalink to &quot;Frame 编解码&quot;">​</a></h3><p>既然是 Frame，就涉及到采用何种编码的问题。Frame 本身只是一个框的概念，这个框里面具体填什么格式的内容，是由编码决定的，写入的时候编码，取出的时候需要解码。</p><p>与 tokio 配套的 tokio_util crate 里，提供了四种最简单的编解码类型：BytesCodec、LinesCodec、AnyDelimiterCodec、LengthDelimitedCodec。我们分别介绍一下。</p><ul><li>BytesCodec</li></ul><p>Frame 长度为 1 的编解码。一个字节一个 Frame。适用于文本和二进制的任何网络协议。如果你的应用就想一个字节一个字节地处理数据流，这个就是合适的选择。</p><ul><li>LinesCodec</li></ul><p>行编解码协议，它使用 <code>\n</code> 作为 Frame 之间的分隔。这个协议用得很多，特别适合文本网络协议。</p><ul><li>AnyDelimiterCodec</li></ul><p>指定间隔符的编解码协议，这个相当于 LinesCodec 的扩展版本。用这个协议，你可以自定义任何 Frame 分隔符，比如 ; , # 等等。它也比较适用于文本网络协议。</p><ul><li>LengthDelimitedCodec</li></ul><p>长度分隔编解码协议。这个协议的思路是，每一个 msg 发送的时候，在它前面，都加上一个固定位数的长度表示前缀。这样，每次读到这个前缀数字的时候，就知道接下来要读多少个字节，才会形成一个完整的 Frame。比如编码后的一个 Frame 类似下面这个样子：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">+----------+--------------------------------+</span></span>
<span class="line"><span style="color:#56B6C2;">|</span><span style="color:#E06C75;"> len</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">u32</span><span style="color:#56B6C2;"> |</span><span style="color:#E06C75;">          frame</span><span style="color:#E06C75;"> payload</span><span style="color:#56B6C2;">         |</span></span>
<span class="line"><span style="color:#ABB2BF;">+----------+--------------------------------+</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这个方法是协议设计的典型方法，具有非常强的通用性，适用于文本或二进制的网络协议。</p><p>tokio 不仅提供了这些默认的简单的编解码方案，它还允许你自定义 Codec。如果上面 4 种都不能满足你的需求，你完全可以按它的规范自定义一个。</p><p>此处，我们可以用 LengthDelimitedCodec，只需要在基本的 TcpStream 上套一下就可以了。接着往下看。</p><h3 id="使用-frame-改造代码" tabindex="-1">使用 Frame 改造代码 <a class="header-anchor" href="#使用-frame-改造代码" aria-label="Permalink to &quot;使用 Frame 改造代码&quot;">​</a></h3><p>使用 Framed + LengthDelimitedCodec 类型改造后的服务端和客户端代码如下：</p><p>服务端代码：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> bytes</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">Bytes</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> futures</span><span style="color:#ABB2BF;">::{</span><span style="color:#E5C07B;">SinkExt</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">StreamExt</span><span style="color:#ABB2BF;">};</span></span>
<span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> std</span><span style="color:#ABB2BF;">::env;</span></span>
<span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> tokio</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">net</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">TcpListener</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> tokio</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">process</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">Command</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> tokio_util</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">codec</span><span style="color:#ABB2BF;">::{</span><span style="color:#E5C07B;">Framed</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">LengthDelimitedCodec</span><span style="color:#ABB2BF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">#[tokio::main]</span></span>
<span class="line"><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> fn</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">() -&gt; </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">&lt;(), </span><span style="color:#E5C07B;">Box</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">dyn</span><span style="color:#E06C75;"> std</span><span style="color:#ABB2BF;">::</span><span style="color:#E06C75;">error</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">Error</span><span style="color:#ABB2BF;">&gt;&gt; {</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> addr</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> env</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">args</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">        .</span><span style="color:#61AFEF;">nth</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">        .</span><span style="color:#61AFEF;">unwrap_or_else</span><span style="color:#ABB2BF;">(</span><span style="color:#56B6C2;">||</span><span style="color:#98C379;"> &quot;127.0.0.1:8888&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#61AFEF;">    println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;Listening on: {}&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">addr</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> listener</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> TcpListener</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">bind</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#E06C75;">addr</span><span style="color:#ABB2BF;">).</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">?;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 注意这里是一个无条件循环，表明始终处于服务状态</span></span>
<span class="line"><span style="color:#C678DD;">    loop</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 等待客户端请求连上来</span></span>
<span class="line"><span style="color:#C678DD;">        let</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;">stream</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">_</span><span style="color:#ABB2BF;">) </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> listener</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">accept</span><span style="color:#ABB2BF;">().</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">?;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 包裹成一个Frame stream</span></span>
<span class="line"><span style="color:#C678DD;">        let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> framed_stream</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> Framed</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">new</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">stream</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">LengthDelimitedCodec</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">new</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 创建子task执行任务</span></span>
<span class="line"><span style="color:#E5C07B;">        tokio</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">spawn</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> move</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">            // 等待读取一个一个msg，如果返回None，会退出这个循环</span></span>
<span class="line"><span style="color:#C678DD;">            while</span><span style="color:#C678DD;"> let</span><span style="color:#E5C07B;"> Some</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">msg</span><span style="color:#ABB2BF;">) </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> framed_stream</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">().</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">                match</span><span style="color:#E06C75;"> msg</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">                    Ok</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">msg</span><span style="color:#ABB2BF;">) =&gt; {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                        // 解析指令，执行任务</span></span>
<span class="line"><span style="color:#C678DD;">                        let</span><span style="color:#E06C75;"> directive</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> String</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">from_utf8</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">msg</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_vec</span><span style="color:#ABB2BF;">())</span></span>
<span class="line"><span style="color:#ABB2BF;">                            .</span><span style="color:#61AFEF;">expect</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;error when converting to string directive.&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">                        println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;{directive}&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">                        let</span><span style="color:#E06C75;"> output</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> process</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#E06C75;">directive</span><span style="color:#ABB2BF;">).</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">                        println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;{output}&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">                        // 返回执行结果</span></span>
<span class="line"><span style="color:#E06C75;">                        _</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> framed_stream</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">send</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Bytes</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">from</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">output</span><span style="color:#ABB2BF;">)).</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">                    }</span></span>
<span class="line"><span style="color:#E5C07B;">                    Err</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">e</span><span style="color:#ABB2BF;">) =&gt; {</span></span>
<span class="line"><span style="color:#61AFEF;">                        println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;{e:?}&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">                    }</span></span>
<span class="line"><span style="color:#ABB2BF;">                }</span></span>
<span class="line"><span style="color:#ABB2BF;">            }</span></span>
<span class="line"><span style="color:#ABB2BF;">        });</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> fn</span><span style="color:#61AFEF;"> process</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">directive</span><span style="color:#ABB2BF;">: &amp;</span><span style="color:#E5C07B;">str</span><span style="color:#ABB2BF;">) -&gt; </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#E06C75;"> directive</span><span style="color:#56B6C2;"> ==</span><span style="color:#98C379;"> &quot;gettime&quot;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 这里我们用了unwrap()是因为我们一般确信执行date命令不会失败</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 更可靠的做法是对返回的Result作处理</span></span>
<span class="line"><span style="color:#C678DD;">        let</span><span style="color:#E06C75;"> output</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> Command</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">new</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;date&quot;</span><span style="color:#ABB2BF;">).</span><span style="color:#61AFEF;">output</span><span style="color:#ABB2BF;">().</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">unwrap</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#E5C07B;">        String</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">from_utf8</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">output</span><span style="color:#ABB2BF;">.stdout).</span><span style="color:#61AFEF;">unwrap</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">    } </span><span style="color:#C678DD;">else</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">        // 如果是其他指令，我们目前返回 无效指令</span></span>
<span class="line"><span style="color:#98C379;">        &quot;invalid command&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_owned</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p>这里我简单解释一下上面的示例。</p><p>在监听到连接 stream（第 19 行）后，把它包裹成 Frame stream（第 21 行），然后使用 <code>while let</code> 配合 <code>framed_stream.next()</code> 对这个流进行迭代，就读出了里面一帧一帧的数据 msg。需要返回结果的时候，使用 <code>framed_stream.send()</code> 就可以了。</p><p>客户端代码：</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> bytes</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">Bytes</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> futures</span><span style="color:#ABB2BF;">::{</span><span style="color:#E5C07B;">SinkExt</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">StreamExt</span><span style="color:#ABB2BF;">};</span></span>
<span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> std</span><span style="color:#ABB2BF;">::env;</span></span>
<span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> tokio</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">net</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">TcpStream</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;">use</span><span style="color:#E5C07B;"> tokio_util</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">codec</span><span style="color:#ABB2BF;">::{</span><span style="color:#E5C07B;">Framed</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">LengthDelimitedCodec</span><span style="color:#ABB2BF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">#[tokio::main]</span></span>
<span class="line"><span style="color:#C678DD;">async</span><span style="color:#C678DD;"> fn</span><span style="color:#61AFEF;"> main</span><span style="color:#ABB2BF;">() -&gt; </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">&lt;(), </span><span style="color:#E5C07B;">Box</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#C678DD;">dyn</span><span style="color:#E06C75;"> std</span><span style="color:#ABB2BF;">::</span><span style="color:#E06C75;">error</span><span style="color:#ABB2BF;">::</span><span style="color:#E5C07B;">Error</span><span style="color:#ABB2BF;">&gt;&gt; {</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> addr</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> env</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">args</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">        .</span><span style="color:#61AFEF;">nth</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">        .</span><span style="color:#61AFEF;">unwrap_or_else</span><span style="color:#ABB2BF;">(</span><span style="color:#56B6C2;">||</span><span style="color:#98C379;"> &quot;127.0.0.1:8888&quot;</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 连接到服务端</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#E06C75;"> stream</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> TcpStream</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">connect</span><span style="color:#ABB2BF;">(&amp;</span><span style="color:#E06C75;">addr</span><span style="color:#ABB2BF;">).</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">?;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 包裹成 Frame stream</span></span>
<span class="line"><span style="color:#C678DD;">    let</span><span style="color:#C678DD;"> mut</span><span style="color:#E06C75;"> framed_stream</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> Framed</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">new</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">stream</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">LengthDelimitedCodec</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">new</span><span style="color:#ABB2BF;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 发送指令</span></span>
<span class="line"><span style="color:#E06C75;">    framed_stream</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">send</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Bytes</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">from</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;gettime&quot;</span><span style="color:#ABB2BF;">)).</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;">?;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">    // 读取返回数据，这里只读一次</span></span>
<span class="line"><span style="color:#C678DD;">    if</span><span style="color:#C678DD;"> let</span><span style="color:#E5C07B;"> Some</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">msg</span><span style="color:#ABB2BF;">) </span><span style="color:#56B6C2;">=</span><span style="color:#E06C75;"> framed_stream</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">next</span><span style="color:#ABB2BF;">().</span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;">        match</span><span style="color:#E06C75;"> msg</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E5C07B;">            Ok</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">msg</span><span style="color:#ABB2BF;">) =&gt; {</span></span>
<span class="line"><span style="color:#C678DD;">                let</span><span style="color:#E06C75;"> timeinfo</span><span style="color:#56B6C2;"> =</span><span style="color:#E5C07B;"> String</span><span style="color:#ABB2BF;">::</span><span style="color:#61AFEF;">from_utf8</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">msg</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_vec</span><span style="color:#ABB2BF;">())?;</span></span>
<span class="line"><span style="color:#61AFEF;">                println!</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;{}&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">timeinfo</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">            }</span></span>
<span class="line"><span style="color:#E5C07B;">            Err</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">e</span><span style="color:#ABB2BF;">) =&gt; </span><span style="color:#C678DD;">return</span><span style="color:#E5C07B;"> Err</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">e</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">into</span><span style="color:#ABB2BF;">()),</span></span>
<span class="line"><span style="color:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;">    Ok</span><span style="color:#ABB2BF;">(())</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>在连接到服务器，得到连接 stream（第 13 行）后，把它包裹成 Frame stream（第 15 行） ，然后使用 <code>framed_stream.send()</code> 发送一条指令，在后面用迭代器方法等待指令执行后返回的内容 msg。对 msg 的处理方式和服务端代码一致。</p><p>可以看到，经过 Frame 层抽象后，大大精简了代码逻辑，整体变得非常清爽。最关键的是，改造后的代码实际 <strong>完全重塑了程序员的心智模型</strong>：我们不再需要关注底层传输的大量细节了，真正实现了面向业务编码，可以按时下班了，非常开心。</p><p>注：这节课的完整代码点击 <a href="https://github.com/miketang84/jikeshijian/tree/master/14-getinfo" target="_blank" rel="noreferrer">这里</a> 可以获取。</p><h2 id="小结" tabindex="-1">小结 <a class="header-anchor" href="#小结" aria-label="Permalink to &quot;小结&quot;">​</a></h2><p>这节课我们一起学习了如何循序渐进地基于 tokio 开发一个服务端和客户端 tcp 网络应用命令行程序。知识点很多，我们一起来回顾一下。</p><ul><li>Rust 中命令行参数的获取方式；</li><li>在 Cargo.toml 配置文件中添加依赖；</li><li>在服务端建立 tcp lisener；</li><li>根据新的连接创建新的 task；</li><li>读取 tcp 数据输入，以及写入返回内容；</li><li>建立 tcp client 连接；</li><li>编译测试 Rust 命令行程序；</li><li>tokio 的 Frame 概念和编解码；</li><li>使用 Frame 简化网络编程。</li></ul><p>网络编程有其复杂性在里面，所以这节课我们应该重点掌握使用 Frame 的编程模型，同时了解原始字节流的处理原理。</p><h2 id="思考题" tabindex="-1">思考题 <a class="header-anchor" href="#思考题" aria-label="Permalink to &quot;思考题&quot;">​</a></h2><p>最后请你来思考 2 个问题。</p><ol><li>EOF 是什么，什么时候会碰到 EOF？</li><li>请问 stream.read_to_end() 接口能读完网络连接中的数据吗？</li></ol><p>欢迎你把思考后的结果分享到评论区和我一起讨论，也欢迎你把这节课的内容分享给其他朋友，我们下节课再见！</p></div></div></main><footer class="VPDocFooter" data-v-39a288b8 data-v-e257564d><!--[--><!--]--><div class="edit-info" data-v-e257564d><div class="edit-link" data-v-e257564d><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/muyaCode/FrontEndLearnNotes/edit/main/docs/Document/14｜tokio实战：编写一个网络命令行程序.md" target="_blank" rel="noreferrer" data-v-e257564d><!--[--><span class="vpi-square-pen edit-link-icon" data-v-e257564d></span> 在 GitHub 上编辑此页<!--]--></a></div><div class="last-updated" data-v-e257564d><p class="VPLastUpdated" data-v-e257564d data-v-e98dd255>上次更新：: <time datetime="2025-02-28T18:19:24.000Z" data-v-e98dd255></time></p></div></div><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-e257564d><span class="visually-hidden" id="doc-footer-aria-label" data-v-e257564d>Pager</span><div class="pager" data-v-e257564d><a class="VPLink link pager-link prev" href="/tanggang_rust/Document/13%EF%BD%9C%E7%8B%AC%E7%AB%8B%E7%8E%8B%E5%9B%BD%EF%BC%9A%E5%88%9D%E6%AD%A5%E4%BA%86%E8%A7%A3Rust%E5%BC%82%E6%AD%A5%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>上一篇</span><span class="title" data-v-e257564d>13｜独立王国：初步了解Rust异步并发编程</span><!--]--></a></div><div class="pager" data-v-e257564d><a class="VPLink link pager-link next" href="/tanggang_rust/Document/15%EF%BD%9Ctokio%E7%BC%96%E7%A8%8B%EF%BC%9A%E5%9C%A8%E5%A4%9A%E4%BB%BB%E5%8A%A1%E4%B9%8B%E9%97%B4%E6%93%8D%E4%BD%9C%E5%90%8C%E4%B8%80%E7%89%87%E6%95%B0%E6%8D%AE" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>下一篇</span><span class="title" data-v-e257564d>15｜tokio编程：在多任务之间操作同一片数据</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-5d98c3a5 data-v-e315a0ad><div class="container" data-v-e315a0ad><p class="message" data-v-e315a0ad>Released under the MIT License.</p><p class="copyright" data-v-e315a0ad>Copyright © 2025  MuYa</p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"document_00｜开篇词｜拥抱rust浪潮，迎接更极致的编程体验.md\":\"Bx6ruBRE\",\"document_01｜快速入门：rust中有哪些你不得不了解的基础语法？.md\":\"YEQ1UjRq\",\"document_02｜所有权（上）：rust是如何管理程序中的资源的？.md\":\"Bvb116GB\",\"document_03｜所有权（下）：rust中借用与引用的规则是怎样的？.md\":\"BJwhWwWd\",\"document_04｜字符串：对号入座，字符串其实没那么可怕！.md\":\"Bv5l_4z9\",\"document_05｜复合类型（上）：结构体与面向对象特性.md\":\"CITkKTJg\",\"document_06｜复合类型（下）：枚举与模式匹配.md\":\"Ct8Xedp7\",\"document_07｜类型与类型参数：给rust小助手提供更多信息.md\":\"EbjW2AkC\",\"document_08｜option-t-与result-t_e-、迭代器.md\":\"BNKn_0uw\",\"document_09｜初识trait：协议约束与能力配置.md\":\"llurKKcW\",\"document_10｜再探trait：带类型参数的trait及traitobject.md\":\"CMwHA5A-\",\"document_11｜常见trait解析：标准库中的常见trait应该怎么用？.md\":\"BGa5CpQf\",\"document_12｜智能指针：从所有权看智能指针.md\":\"Cxvwfxu6\",\"document_13｜独立王国：初步了解rust异步并发编程.md\":\"DSU5sdFT\",\"document_14｜tokio实战：编写一个网络命令行程序.md\":\"C1JeQOSl\",\"document_15｜tokio编程：在多任务之间操作同一片数据.md\":\"Bwzc0tpF\",\"document_16｜tokio编程：使用channel在不同任务间通信？.md\":\"DKrhaVoh\",\"document_17｜tokio编程：rust异步编程还有哪些需要注意的点？.md\":\"CmxLkup0\",\"document_18｜错误处理系统：错误的构建、传递和处理.md\":\"BWw-vDDL\",\"document_19｜rust的宏体系：为自己的项目写一个简单的声明宏.md\":\"DXluFKAD\",\"document_20｜生命周期：rust如何做基本的生命周期符号标注？.md\":\"Bt1xgIs6\",\"document_21｜web开发（上）：如何使用axum框架进行web后端开发？.md\":\"DXd_p46T\",\"document_22｜web开发（下）：如何实现一个todolist应用？.md\":\"Bi1r-Ulj\",\"document_23｜rust与大模型：用candle做一个聊天机器人.md\":\"CDaEmFi3\",\"document_24｜rust图像识别：利用yolov8识别对象.md\":\"CMFa5k75\",\"document_25｜rustgui编程：用slint为chatbot实现一个界面.md\":\"CSQiE64f\",\"document_26｜rustgui编程：用slint为yolov8实现一个界面.md\":\"8_AGledo\",\"document_27｜rustbevy游戏开发：用300行代码做一个贪吃蛇游戏.md\":\"DcZ-wJin\",\"document_28｜nom：用rust写一个parser解析器.md\":\"DtpKzSZI\",\"document_29｜unsafe编程（上）：unsaferust中那些被封印的能力.md\":\"DkGls-cm\",\"document_30｜unsafe编程（下）：使用rust为python写一个扩展.md\":\"tPXz85a6\",\"document_答疑课堂（一）｜第一章rust基础篇思考题答案.md\":\"CC_0mUbW\",\"document_答疑课堂（三）｜第三章rust应用篇思考题答案.md\":\"He3Na2GY\",\"document_答疑课堂（二）｜第二章rust进阶篇思考题答案.md\":\"rq96ZBKO\",\"document_结束语｜未来让rust带你“锈”到起飞.md\":\"CDoEtXUj\",\"document_结课测试｜来赴一场满分之约.md\":\"BDMdH3Zr\",\"index.md\":\"ZlsnMKnR\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh\",\"dir\":\"ltr\",\"title\":\"唐刚-Rust语言从入门到实战\",\"description\":\"Rust语言从入门到实战\",\"base\":\"/tanggang_rust/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"logo\":\"/img/buding.svg\",\"siteTitle\":\"Rust语言从入门到实战\",\"outlineTitle\":\"⚡️文档内容大纲\",\"outline\":\"deep\",\"search\":{\"provider\":\"local\",\"options\":{\"locales\":{\"root\":{\"translations\":{\"button\":{\"buttonText\":\"搜索文档\",\"buttonAriaLabel\":\"搜索文档\"},\"modal\":{\"noResultsText\":\"无法找到相关结果\",\"displayDetails\":\"显示详细信息\",\"resetButtonTitle\":\"清除查询条件\",\"backButtonTitle\":\"返回搜索结果\",\"footer\":{\"selectText\":\"选择\",\"selectKeyAriaLabel\":\"enter\",\"navigateText\":\"切换\",\"navigateUpKeyAriaLabel\":\"up arrow\",\"navigateDownKeyAriaLabel\":\"down arrow\",\"closeText\":\"关闭\",\"closeKeyAriaLabel\":\"escape\"}}}}},\"miniSearch\":{\"options\":{},\"searchOptions\":{}}}},\"sidebar\":{\"/\":[{\"text\":\"00｜开篇词｜拥抱Rust浪潮，迎接更极致的编程体验\",\"link\":\"/Document/00｜开篇词｜拥抱Rust浪潮，迎接更极致的编程体验\"},{\"text\":\"01｜快速入门：Rust中有哪些你不得不了解的基础语法？\",\"link\":\"/Document/01｜快速入门：Rust中有哪些你不得不了解的基础语法？\"},{\"text\":\"02｜所有权（上）：Rust是如何管理程序中的资源的？\",\"link\":\"/Document/02｜所有权（上）：Rust是如何管理程序中的资源的？\"},{\"text\":\"03｜所有权（下）：Rust中借用与引用的规则是怎样的？\",\"link\":\"/Document/03｜所有权（下）：Rust中借用与引用的规则是怎样的？\"},{\"text\":\"04｜字符串：对号入座，字符串其实没那么可怕！\",\"link\":\"/Document/04｜字符串：对号入座，字符串其实没那么可怕！\"},{\"text\":\"05｜复合类型（上）：结构体与面向对象特性\",\"link\":\"/Document/05｜复合类型（上）：结构体与面向对象特性\"},{\"text\":\"06｜复合类型（下）：枚举与模式匹配\",\"link\":\"/Document/06｜复合类型（下）：枚举与模式匹配\"},{\"text\":\"07｜类型与类型参数：给Rust小助手提供更多信息\",\"link\":\"/Document/07｜类型与类型参数：给Rust小助手提供更多信息\"},{\"text\":\"08｜Option-T-与Result-T,E-、迭代器\",\"link\":\"/Document/08｜Option-T-与Result-T,E-、迭代器\"},{\"text\":\"09｜初识trait：协议约束与能力配置\",\"link\":\"/Document/09｜初识trait：协议约束与能力配置\"},{\"text\":\"10｜再探trait：带类型参数的trait及traitobject\",\"link\":\"/Document/10｜再探trait：带类型参数的trait及traitobject\"},{\"text\":\"11｜常见trait解析：标准库中的常见trait应该怎么用？\",\"link\":\"/Document/11｜常见trait解析：标准库中的常见trait应该怎么用？\"},{\"text\":\"答疑课堂（一）｜第一章Rust基础篇思考题答案\",\"link\":\"/Document/答疑课堂（一）｜第一章Rust基础篇思考题答案\"},{\"text\":\"12｜智能指针：从所有权看智能指针\",\"link\":\"/Document/12｜智能指针：从所有权看智能指针\"},{\"text\":\"13｜独立王国：初步了解Rust异步并发编程\",\"link\":\"/Document/13｜独立王国：初步了解Rust异步并发编程\"},{\"text\":\"14｜tokio实战：编写一个网络命令行程序\",\"link\":\"/Document/14｜tokio实战：编写一个网络命令行程序\"},{\"text\":\"15｜tokio编程：在多任务之间操作同一片数据\",\"link\":\"/Document/15｜tokio编程：在多任务之间操作同一片数据\"},{\"text\":\"16｜tokio编程：使用channel在不同任务间通信？\",\"link\":\"/Document/16｜tokio编程：使用channel在不同任务间通信？\"},{\"text\":\"17｜tokio编程：Rust异步编程还有哪些需要注意的点？\",\"link\":\"/Document/17｜tokio编程：Rust异步编程还有哪些需要注意的点？\"},{\"text\":\"18｜错误处理系统：错误的构建、传递和处理\",\"link\":\"/Document/18｜错误处理系统：错误的构建、传递和处理\"},{\"text\":\"19｜Rust的宏体系：为自己的项目写一个简单的声明宏\",\"link\":\"/Document/19｜Rust的宏体系：为自己的项目写一个简单的声明宏\"},{\"text\":\"20｜生命周期：Rust如何做基本的生命周期符号标注？\",\"link\":\"/Document/20｜生命周期：Rust如何做基本的生命周期符号标注？\"},{\"text\":\"答疑课堂（二）｜第二章Rust进阶篇思考题答案\",\"link\":\"/Document/答疑课堂（二）｜第二章Rust进阶篇思考题答案\"},{\"text\":\"21｜Web开发（上）：如何使用Axum框架进行Web后端开发？\",\"link\":\"/Document/21｜Web开发（上）：如何使用Axum框架进行Web后端开发？\"},{\"text\":\"22｜Web开发（下）：如何实现一个TodoList应用？\",\"link\":\"/Document/22｜Web开发（下）：如何实现一个TodoList应用？\"},{\"text\":\"23｜Rust与大模型：用Candle做一个聊天机器人\",\"link\":\"/Document/23｜Rust与大模型：用Candle做一个聊天机器人\"},{\"text\":\"24｜Rust图像识别：利用YOLOv8识别对象\",\"link\":\"/Document/24｜Rust图像识别：利用YOLOv8识别对象\"},{\"text\":\"25｜RustGUI编程：用Slint为Chatbot实现一个界面\",\"link\":\"/Document/25｜RustGUI编程：用Slint为Chatbot实现一个界面\"},{\"text\":\"26｜RustGUI编程：用Slint为YOLOv8实现一个界面\",\"link\":\"/Document/26｜RustGUI编程：用Slint为YOLOv8实现一个界面\"},{\"text\":\"27｜RustBevy游戏开发：用300行代码做一个贪吃蛇游戏\",\"link\":\"/Document/27｜RustBevy游戏开发：用300行代码做一个贪吃蛇游戏\"},{\"text\":\"28｜Nom：用Rust写一个Parser解析器\",\"link\":\"/Document/28｜Nom：用Rust写一个Parser解析器\"},{\"text\":\"29｜Unsafe编程（上）：UnsafeRust中那些被封印的能力\",\"link\":\"/Document/29｜Unsafe编程（上）：UnsafeRust中那些被封印的能力\"},{\"text\":\"30｜Unsafe编程（下）：使用Rust为Python写一个扩展\",\"link\":\"/Document/30｜Unsafe编程（下）：使用Rust为Python写一个扩展\"},{\"text\":\"答疑课堂（三）｜第三章Rust应用篇思考题答案\",\"link\":\"/Document/答疑课堂（三）｜第三章Rust应用篇思考题答案\"},{\"text\":\"结课测试｜来赴一场满分之约\",\"link\":\"/Document/结课测试｜来赴一场满分之约\"},{\"text\":\"结束语｜未来让Rust带你“锈”到起飞\",\"link\":\"/Document/结束语｜未来让Rust带你“锈”到起飞\"}]},\"editLink\":{\"pattern\":\"https://github.com/muyaCode/FrontEndLearnNotes/edit/main/docs/:path\",\"text\":\"在 GitHub 上编辑此页\"},\"lastUpdated\":{\"text\":\"上次更新：\",\"formatOptions\":{\"dateStyle\":\"full\",\"timeStyle\":\"medium\"}},\"docFooter\":{\"prev\":\"上一篇\",\"next\":\"下一篇\"},\"footer\":{\"message\":\"Released under the MIT License.\",\"copyright\":\"Copyright © 2025  MuYa\"}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":true}");</script>
    
  </body>
</html>